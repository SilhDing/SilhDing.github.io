<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Yihang (Ian) Ding">


    <meta name="subtitle" content="Glad you reach here.">




<title>Category: technique | Yihang&#39;s Blog</title>



    <link rel="icon" href="/favicon.png">


<link href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,700|Noto+Sans+JP:300,700|Noto+Sans+KR:300,700|Source+Code+Pro:400,400i,700,700i|IBM+Plex+Mono:400,400i,600,600i&display=swap" rel="stylesheet">



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
            <a href="/">楽しんでね。| Yihang&#39;s Blog</a>
            </div>

            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">✐  Post</a>
                
                    <a class="menu-item" href="/category">➭  Category</a>
                
                    <a class="menu-item" href="/tag">✰  Tag</a>
                
                    <a class="menu-item" href="/about">❐  Résumé</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">楽しんでね。| Yihang&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">✐  Post</a>
                
                    <a class="menu-item" href="/category">➭  Category</a>
                
                    <a class="menu-item" href="/tag">✰  Tag</a>
                
                    <a class="menu-item" href="/about">❐  Résumé</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>

        <div class="main">
            


    
<div class="container">
    <div class="post-wrap categories">
        <h2 class="post-title"> ➭ | Categories | technique</h2>
    </div>
    <div class="post-wrap archive">
    
    
        

        
            <h1>2021</h1>
        

        <article class="archive-item">
            <a class="archive-item-link" href="/2021/08/20/A-Closer-Look-to-a-Key-Value-Storage-Engine/">A Closer Look to a Key-Value Storage Engine</a>
            <span class="archive-item-date">Aug 20, 2021</span>
            <!-- <span style=> <p>“Please design a key-value storage engine”. You might hear this during a system design interview. While this question in fact is pretty, designing a storage engine is not easy. In this post, I want to start with some simple designs and principles and gradually approach a solution of a relatively complete key-value storage engine.</p>
<p>Please note that, though we mainly talk about key-value storage, many ideas and principles are widely used in many other database designs.</p>
<h1 id="Key-Value-in-Memory"><a href="#Key-Value-in-Memory" class="headerlink" title="Key-Value in Memory"></a>Key-Value in Memory</h1><p>Have you ever encountered any key-value storages in memory? Sure. <code>HashMap</code> and <code>TreeMap</code> in Java are two data structures for key-value storages only in memory. There are also a lot of other data structures to implement a in-memory key-value storage, such as AVL tree, skip list, etc.</p>
<h1 id="How-About-Data-on-Disk"><a href="#How-About-Data-on-Disk" class="headerlink" title="How About Data on Disk?"></a>How About Data on Disk?</h1><p>Here is a question: since we already some in-memory data structures for key-value storages, can we also use it for storage on disk?</p>
<h2 id="HashMap-Append-only-Log"><a href="#HashMap-Append-only-Log" class="headerlink" title="HashMap + Append-only Log"></a>HashMap + Append-only Log</h2><p>Let’s take the <code>HashMap</code> as one example. <code>HashMap</code> uses hash value of the key to index the data. Assume we are always appending data to a file on the disk, what we can do here is to maintain a in-memory hash map where every key is mapped to a byte offset in the data file, which is the location at which the value can be found. Whenever you append a new key-value pair to the file, you also update the hash map by adding or updating the offset.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key     offset</span><br><span class="line">123     0</span><br><span class="line">456     64</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Though this method is pretty simple, some of its ideas are still pretty impressive, one of which is using append-only log to improve write.</p>
<p>Compared with in-memory key-value storage, the most important feature of an actual data storage is: it needs to be persistent. This is why we need to always write to the disk. For writes, <strong><em>it’s hard to beat the performance of simply appending to a file, as this is the simplest possible write operation</em></strong>. What is counterintuitive is, random write to memory is even <em>slower</em> than sequential read to disk, not to mention random write to disk. So, if you need to write to the disk with high performance, <strong>always use append-only write</strong>.</p>
<p>However, in terms of scalability, it is not hard to spot some downsides of this method:</p>
<ol>
<li>Append-only operation will grow the data size forever, so it is possible run out of the disk space, right?</li>
<li>If the number of keys of the hash map keeps growing, the data structure may not fit in the memory one day.</li>
</ol>
<p>Another downside of this approach is on range query. As the key is usually unordered, performance of range query might be pretty bad.</p>
<h2 id="Compaction-amp-Merging"><a href="#Compaction-amp-Merging" class="headerlink" title="Compaction &amp; Merging"></a>Compaction &amp; Merging</h2><p>How do we avoid eventually running out of disk space? A good solution is to break the log into segments of a certain size: if the log size reaches a limit, we close the current file (a segment) and all subsequent writes will go to a new file (a new segment). What we can do next is to perform <em>compaction</em> on these segment, which normally removes duplicate keys in the log and only keeps the most recent update for the key. As the size of a segment will be smaller after compaction, what we usually do is to also <em>merge</em> several segments at the same time as performing the compaction.</p>
<img src="Diagram-merge-compaction.svg" alt="compaction and merging" width="250"/>

<p>As shown in the picture above, segment 2 is newer than segment 1, so in the merging process, the data in segment 2 might also overwrite data in segment 1 (e.g., key “beef”).</p>
<p>For each of the segment, it may have its own in-memory hash map, mapping the keys to file offsets. If we want to look up a key, we can start with the most recent segment and its hash map; if the key is not present, we then check the second-most-recent, and so on. For write, we always write to the most recent segment and update its hash map.</p>
<p>To make this idea work in practice, some design details are also important in an actual implementation. For example:</p>
<blockquote>
<p>What is the file format for the log?</p>
</blockquote>
<p>Many formats are candidates, but probably it is better just to use a binary format, e.g., one encoding the length of a string in bytes, followed by the raw string. This format will remove all whitespaces.</p>
<blockquote>
<p>How can we delete a key/record?</p>
</blockquote>
<p>Similar to a simple write operation, when deleting a key, we may just need to append a special deletion record to the data file (usually called <strong><em>tombstone</em></strong>). In compaction and merging, all previous values of the deleted key before the tombstone should be discarded.</p>
<blockquote>
<p>What if crash happens or the machine is restarted, all in-memory hash maps (indices) will be lost. How can we recover them?</p>
</blockquote>
<p>We can also reconstruct the in-memory hash maps with the in-disk data, but it might take a long time if the segment files are large. A better method might be storing a snapshot of each segment’s hash map on disk. This may speed up recovery.</p>
<p>We still have a lot of designs or features to talk about (e.g., concurrency control) but will stop here. Coming back to the design itself, we still left some problem unsolved: the hash tables must fit in memory and it will be a problem if the has maps are large. Also, range querying have low efficiency.</p>
<h2 id="SSTables-and-LSM-Tree"><a href="#SSTables-and-LSM-Tree" class="headerlink" title="SSTables and LSM-Tree"></a>SSTables and LSM-Tree</h2><p>In this chapter, we will discuss some ideas brought by LevelDB, an open-source database engine by <a href="https://github.com/google/leveldb" target="_blank" rel="noopener">Google</a>. The basic idea is still to use append-log segment files (we will call them <strong><em>log structured storage segment</em></strong> from now) and to construct an in-memory index, but we have many other actions to resolve the scalability and range query issues.</p>
<p>Let’s start with a simple change to the format of our segment files: we require that the sequence of key-value pairs is <em>sorted by key</em>. Wait, won’t it break our ability to use sequential writes? No worry, let’s get to that in a moment.</p>
<p>This kind of format is simple called <em>Sorted String Table</em>, or just <em>SSTable</em>. Another requirement we want to put here is: in each segment file, one key will only appear once. The compaction and merging (or say, compression) process already ensures that. You might some exceptions in some cases (such as in LevelDB) but let’s assume it is always true now.</p>
<p>There are several benefits of doing this:</p>
<ol>
<li>While range query becomes more possible, merging segment is also simple and efficient. The approach is really similar to the one used in the <em>merge sort</em> algorithm. If we find a key exists in multiple segments during merging, we should always keep the key-value pair from the most recent segment and abandon those from older segments.</li>
<li>As keys are sorted, you don’t need to keep an index of all keys in memory. Instead, a sparse index could be used. For example, if you want to look up the key <code>bike</code>, you probably cannot determine the offset of this key just by looking up the hash map below, but you do know the key is between <code>bee</code> and <code>bored</code> (by a simple binary search), so you can jump to the offset for <code>bee</code> and scan from there until you find the key (you might not find it, and it is easy to know).</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key           byte offset</span><br><span class="line">...           ...</span><br><span class="line">b             100491</span><br><span class="line">bee           102134</span><br><span class="line">bored         104667</span><br><span class="line">bury          106812</span><br><span class="line">...           ...</span><br></pre></td></tr></table></figure>

<p>With this assumption, let’s consider how can we maintain SSTables while writes can occur in any order.</p>
<p>As we know, maintaining a sorted structure on disk is hard (though it is still possible, such as B-Tree), but it is easy to do it in memory (we already discussed this), such as AVL tree and read-black tree. We can do the following (also see the picture below):</p>
<ol>
<li>When a write comes in, add it to the in-memory sorted hash map. This hash map is called <strong><em>memtable</em></strong>.</li>
<li>The memtable might grow larger gradually. When the size of the hash map reaches a limit, it will become an immutable memtable. While we can create a new empty memtable for new incoming writes, we will also write out the immutable memtable to disk as an SSTable file. This is easy, as the in-memory data structure already maintains the order of all keys. The new SSTable will become the most recent SSTable.</li>
<li>For read requests, we will first find it in the memtable (this could be pretty fast). If not present, we start with the most recent SST file, and the second-most-recent SST file, and so on. Each SST file could have a in-memory index in memory to help up find a key, but we also have other better ways to help look-up (will talk about it later).</li>
</ol>
<img src="Diagram-LevelDB.svg" alt="compaction and merging"/>

<p>We also need to compress SSTable files regularly. In <a href="https://github.com/google/leveldb/blob/master/doc/impl.md" target="_blank" rel="noopener">Google’s LevelDB</a>, it uses a level-structured architecture to manage all SSTable files. By saying that, when writing the immutable memtable to the disk, we will write it to <strong>level 0</strong> (or called young level). On young level, SST files may contain overlapping keys (as they are directly from memtable), but we make sure on level 1 and higher, SST files on each level have distinct non-overlapping key ranges. This is achieved by the compaction process described below:</p>
<blockquote>
<p>When the size of level L exceeds its limit, we compact it in a background thread. The compaction picks a file from level <strong>L and all overlapping files from the next level L+1</strong>. Note that if a level-L file overlaps only part of a level-(L+1) file, the entire file at level-(L+1) is used as an input to the compaction and will be discarded after the compaction. Aside: because level-0 is special (files in it may overlap each other), we treat compactions from level-0 to level-1 specially: a level-0 compaction may pick more than one level-0 file in case some of these files overlap each other.<br><br>A compaction merges the contents of the picked files to produce a sequence of level-(L+1) files. We switch to producing a new level-(L+1) file after the current output file has reached the target file size (2MB). We also switch to a new output file when the key range of the current output file has grown enough to overlap more than ten level-(L+2) files. This last rule ensures that a later compaction of a level-(L+1) file will not pick up too much data from level-(L+2).<br><br>The old files are discarded and the new files are added to the serving state.<br><br>Compactions for a particular level rotate through the key space. In more detail, for each level L, we remember the ending key of the last compaction at level L. The next compaction for level L will pick the first file that starts after this key (wrapping around to the beginning of the key space if there is no such file).<br><br>Compactions drop overwritten values. They also drop deletion markers if there are no higher numbered levels that contain a file whose range overlaps the current key.</p>
</blockquote>
<p>You may also notice that, what if the machine crashes and all in-memory data gets lost? In this case, we will use write-ahead-log (WAL) to protect the data. <strong>We will append a log to the log file on disk before we make any updates to the memtable</strong>. Thus, even the machine crashes unexpectedly, we can still recover the memtable with the log file. The log file is also an append-only file so writing to it could be fast. Please note that, when we write the memtable into a SSTable file on disk, the corresponding log file will also be discarded. A new log file will be initialized along with the new memtable.</p>
<p>This algorithm and some similar storage engines are used in Cassandra and HBase, both of which were inspired by Google’s Bigtable paper (this paper introduces the idea of <em>memtable</em> and <em>SSTable</em>). The indexing structure is also called <strong><em>Log-Structured Merge-Tree</em></strong> (or just LSM-Tree). Storage engines that are based on this principle of merging and compacting sorted files are often called LSM storage engines.</p>
<h1 id="Other-Design-Details"><a href="#Other-Design-Details" class="headerlink" title="Other Design Details"></a>Other Design Details</h1><p>Coming back to LevelDB, there are many other design details we need to have a look, as it also affects the performance of the database system.</p>
<h2 id="Manifest-file"><a href="#Manifest-file" class="headerlink" title="Manifest file"></a>Manifest file</h2><p>For all SSTable files, there is a manifest file that lists the set of sorted SSTables on each level. It records some important metadata of each SSTable, such as the file’s name and the key range.</p>
<p>Manifest fils might be useful when we look up a key among all SSTable files. When a key is not present in the memtable and we need to find it in SSTable files, manifest file can improve this process:</p>
<ul>
<li>Manifest file might contain the key range of each SSTable. If the key is not within that range, we can quickly know that we can skip this SSTable file and go ahead with the next one.</li>
<li>Starting from level 1, all SSTables on a single level will not have overlapping key range. Thus, <strong>there will only be one SSTable file that might have the key</strong>. A simple binary search might determine which SSTable we should look into for this key.</li>
</ul>
<h2 id="Bloom-filter"><a href="#Bloom-filter" class="headerlink" title="Bloom filter"></a>Bloom filter</h2><p>It is apparent that the write performance is good in LevelDB, thanks to the LSM-tree, but read performance might be bad, as we might need to check more than one SSTable to find a key’s value. Bloom filter is a way to improve read operations.</p>
<p>A bloom filter is a memory-efficient data structure for <strong><em>approximately</em></strong> the contents of a set. Basically,</p>
<ul>
<li>if it says “the key doesn’t exist”, then they key must not exist in the database;</li>
<li>if it says “the key exists”, then the key <strong><em>may</em></strong> exist in the database, and we need to go to the memtable or SSTables to find out the truth.</li>
</ul>
<p>In fact, the implementation of a bloom filter could be really easy. Another similar data structure is <em>count-min sketch</em>, though they are suitable in different use cases (we will not dive deep here). The most important benefit of a bloom filter is, if a key does not exist, it can avoid all unnecessary lookups and return the result immediately.</p>
<h2 id="Other-improvements"><a href="#Other-improvements" class="headerlink" title="Other improvements"></a>Other improvements</h2><p>There are some other ways to improve the performance:</p>
<ol>
<li>Cache. It’s possible to cache some SSTables in memory;</li>
<li>Sparse index or full index of each SSTables can be stored in the memory for fast lookup.</li>
</ol>
<h1 id="B-tree"><a href="#B-tree" class="headerlink" title="B-tree"></a>B-tree</h1><p>While the LSM-tree is the main focus in this post, the most popular indexing data structure is, however, B-tree. We mentioned B-tree earlier in this post, and it is always instructive to compare B-tree and LSM-tree.</p>
<p><strong>B-tree is almost the standard index implementation in almost all relational databases</strong>, and some non-relational database systems. B-tree also keeps key-value pair sorted by key, but the mechanism is pretty different from LSM-tree. Briefly speaking, B-tree is able to maintain a on-disk tree structure to index the data. To find a key and its value, we normally start with the root <em>page</em> and go all the way to a leaf node (of the key) or a position which indicates the absence of the key. If we want to write a key and its value, we will use the similar method to find the key, change the value in that page, and write back to disk. If a new key is added, the tree structure might be adjusted (split, merge, …).</p>
<h2 id="Reliability"><a href="#Reliability" class="headerlink" title="Reliability"></a>Reliability</h2><p>In contrast to LSM-tree, when writing to a key in a B-tree, we usually change <strong><em>in place</em></strong>, which it is just an appending operation in LSM-tree. In B-tree, you need to find the page that contains the key and then overwrite the page with the new value. The tree’s structure normally will not be changed and all references to the modified page will not be changed either.</p>
<p>However, a write operation, in some cases, might involve some additional work (this is always called write amplification/multiplication). For example, if the key is absent and you insert it, you might need to split the page to two new ones if the page becomes too big. If it happens, you also need to update the references in their parent pages, which, however, could be dangerous: what if the database crashes after the whole process get completed?</p>
<p>A widely used solution for this problem is write-ahead log (WAL). Another possible issue is concurrency. For this problem, applying some latches (lightweight locks) might work.</p>
<p>As a whole, you will find that, in this regard, LSM-tree is much better: appending to log is simpler than writing in place; the background compaction process can be greatly isolated from the incoming queries.</p>
<h2 id="B-tree-VS-LSM-tree"><a href="#B-tree-VS-LSM-tree" class="headerlink" title="B-tree VS LSM-tree"></a>B-tree VS LSM-tree</h2><p>The most intuitive performance difference between these two data structures is: B-tree is good for read operation while LSM-tree is generally faster for write operations. Of course, benchmarking always varies as the actual performance is sensitive to implementation details and workload. Let’s see something that you might be interested when measuring the performance of a storage engine.</p>
<h3 id="Advantages-of-LSM-trees"><a href="#Advantages-of-LSM-trees" class="headerlink" title="Advantages of LSM-trees"></a>Advantages of LSM-trees</h3><p>Typically, a LST-tree is able to sustain higher write throughput then a B-tree, <em>partly</em> because it normally involves lower write amplification. Note that LSM-tree also has write amplification, such as compaction/merging process, but this can always be in the background and incoming writes will not be affected: this promises high write throughput.</p>
<p>A LSM-tree also compressed better, and it always produce smaller files on disk than a B-tree. In a B-tree, some space in a page might be unused so fragmentation is more serious.</p>
<h3 id="Downsides-of-LSM-trees"><a href="#Downsides-of-LSM-trees" class="headerlink" title="Downsides of LSM-trees"></a>Downsides of LSM-trees</h3><p>The most serious downside of a LSM-tree is that the write bandwidth has to be shared the initial write and the compaction threads running in the background. It could be pretty bad when the write throughout gets high: the compaction might not be able to keep up with the rate of the incoming writes. It even gets worse later: the number of unmerged segments (SSTable files) on disk keeps growing and you will run out of the disk space finally. The performance will also get worse as there are now more segments to check in order to find the key.</p>
<p>Another concern arises when a transaction happens, where there are multiple operations in a single transaction. In a B-tree, a key will only exactly exist in one place, but might be copied several times in a LSM-tree. Transaction isolation can be easily implemented using locks on a B-tree, which could be hard on a LSM-tree.</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2021/03/13/How-to-design-a-delayed-scheduler-in-Java/">How to design a delayed scheduler in Java?</a>
            <span class="archive-item-date">Mar 13, 2021</span>
            <!-- <span style=> <p>Designing a delayed scheduler could be very interesting but challenging. Though in Java there are many built-in tools under the concurrency section, studying them on the code level is a really good practice.</p>
<p>The question here is to design a delayed scheduler that can accept a <code>Runnable</code> task with a delay. The task should be executed after the delay time.</p>
<p>At this moment, let’s forget a large scale scheduler on a distributed system. The scope right now is to implement such a class and an API:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayedScheduler</span> </span>&#123;</span><br><span class="line">    <span class="comment">// unit of delayTime is milliseconds</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future <span class="title">scheduler</span><span class="params">(Runnable task, <span class="keyword">long</span> delayTime)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Approach-1-PriorityQueue-polling"><a href="#Approach-1-PriorityQueue-polling" class="headerlink" title="Approach 1: PriorityQueue + polling"></a>Approach 1: <code>PriorityQueue</code> + polling</h3><p>A simple and intuitive solution is to maintain a priority queue which contains all tasks to be executed. The most urgent task will be at the peek of this queue. We then will have a thread which iteratively and periodically checking the peek task in the priority queue; then pop and run the task if needed. This is called <strong><em>polling</em></strong>.</p>
<p>A big issue with this approach is, how can we decide the period of polling?</p>
<ul>
<li>If the interval is too small, it will be a huge workload for the CPU;</li>
<li>If the interval is too large, the real execution time of a task might not be accurate (it will be delayed).</li>
</ul>
<h3 id="Approach-2-PriorityQueue-timer"><a href="#Approach-2-PriorityQueue-timer" class="headerlink" title="Approach 2: PriorityQueue + timer"></a>Approach 2: <code>PriorityQueue</code> + timer</h3><p>Instead of polling periodically, what we can do is: get the delay time of the current peek task, set a timer with the time, check again when the timer is up.</p>
<p>However, <strong>this is even worse compared with the approach 1</strong>. Why? Consider such a situation: now the peek element in the queue will be executed one hour later, so the timer will be up after 1 hour. However, after that a new task comes into the queue, and this task’s delay time is 30 minutes. Apparently, we are not able to execute this task after 30 minutes later as the thread blocks due to the timer.</p>
<h3 id="Approach-3-Let’s-look-into-DelayQueue-now"><a href="#Approach-3-Let’s-look-into-DelayQueue-now" class="headerlink" title="Approach 3: Let’s look into DelayQueue now!"></a>Approach 3: Let’s look into <code>DelayQueue</code> now!</h3><p>In Java we have a built-in queue called <code>DelayQueue</code>. This is exactly what we want! We will look into how it works by analyzing the source code, but firstly, let’s implement the delay scheduler with this class.</p>
<p>Let’s write a wrapper for the <code>Runnable</code> task.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelayTask</span> <span class="keyword">extends</span> <span class="title">FutureTask</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> startTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable task;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayTask</span><span class="params">(Runnable task, <span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(task, <span class="keyword">null</span>);  <span class="comment">// null is the return value for the runnable tasks</span></span><br><span class="line">        <span class="keyword">this</span>.task = task;</span><br><span class="line">        <span class="keyword">this</span>.startTime = System.currentTimeMillis() + delayTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> diff = <span class="keyword">this</span>.startTime - System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">return</span> unit.convert(diff, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Long.compare(<span class="keyword">this</span>.getDelay(), ((DelayTask) o).getDelay());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that we need to implement <code>getDelay</code> and <code>compareTo</code> functions, as <code>Delayed</code> is in fact only an interface, which also implements <code>Comparable</code> interface.</p>
<p>Now, let’s implement the scheduler class.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayedScheduler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DelayQueue&lt;DelayTask&gt; queue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayedScheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> DelayQueue&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.startExecute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future <span class="title">schedule</span><span class="params">(Runnable task, <span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">        DelayTask newTask = <span class="keyword">new</span> DelayTask(task, delayTime);</span><br><span class="line">        <span class="keyword">this</span>.queue.offer(newTask);</span><br><span class="line">        <span class="keyword">return</span> newTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runnable execute = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    DelayTask task = <span class="keyword">this</span>.queue.take();</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTree();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> Thread(execute, <span class="string">"Executor"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The code is really concise and self-explanatory, thanks to the good capsulation of this class. The source code of <code>DelayQueue</code> is not complicated but very delicate!</p>
<p>Below is the implementation of some core functions of this class.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueue</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Delayed</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">transient</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityQueue&lt;E&gt; q = <span class="keyword">new</span> PriorityQueue&lt;E&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Thread designated to wait for the element at the head of</span></span><br><span class="line"><span class="comment">     * the queue.  This variant of the Leader-Follower pattern</span></span><br><span class="line"><span class="comment">     * (http://www.cs.wustl.edu/~schmidt/POSA/POSA2/) serves to</span></span><br><span class="line"><span class="comment">     * minimize unnecessary timed waiting.  When a thread becomes</span></span><br><span class="line"><span class="comment">     * the leader, it waits only for the next delay to elapse, but</span></span><br><span class="line"><span class="comment">     * other threads await indefinitely.  The leader thread must</span></span><br><span class="line"><span class="comment">     * signal some other thread before returning from take() or</span></span><br><span class="line"><span class="comment">     * poll(...), unless some other thread becomes leader in the</span></span><br><span class="line"><span class="comment">     * interim.  Whenever the head of the queue is replaced with</span></span><br><span class="line"><span class="comment">     * an element with an earlier expiration time, the leader</span></span><br><span class="line"><span class="comment">     * field is invalidated by being reset to null, and some</span></span><br><span class="line"><span class="comment">     * waiting thread, but not necessarily the current leader, is</span></span><br><span class="line"><span class="comment">     * signalled.  So waiting threads must be prepared to acquire</span></span><br><span class="line"><span class="comment">     * and lose leadership while waiting.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Thread leader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Condition signalled when a newer element becomes available</span></span><br><span class="line"><span class="comment">     * at the head of the queue or a new thread may need to</span></span><br><span class="line"><span class="comment">     * become leader.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition available = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            q.offer(e);</span><br><span class="line">            <span class="keyword">if</span> (q.peek() == e) &#123;</span><br><span class="line">                leader = <span class="keyword">null</span>;</span><br><span class="line">                available.signal();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                E first = q.peek();</span><br><span class="line">                <span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">                    available.await();</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">long</span> delay = first.getDelay(NANOSECONDS);</span><br><span class="line">                    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> q.poll();</span><br><span class="line">                    first = <span class="keyword">null</span>; <span class="comment">// don't retain ref while waiting</span></span><br><span class="line">                    <span class="keyword">if</span> (leader != <span class="keyword">null</span>)</span><br><span class="line">                        available.await();</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        Thread thisThread = Thread.currentThread();</span><br><span class="line">                        leader = thisThread;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            available.awaitNanos(delay);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (leader == thisThread)</span><br><span class="line">                                leader = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; q.peek() != <span class="keyword">null</span>)</span><br><span class="line">                available.signal();</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see, we still use a priority queue to manage all tasks and the peek is the one with the shortest delay time. Instead of using polling or timer, we use the wait/notify(signal) to handle the concurrency problems. If there are many threading that blocks on <code>take()</code> functions (i.e., they are all waiting to get an element from the queue), we use a <strong><em>leader/follower</em></strong> pattern to efficiently minimize unnecessary timed waiting. The leader will only wait for the delay time of the peek element in the queue, while other threads need to wait until signaled.</p>
<p>Here are many design tricks that are deserved to be noticed.</p>
<blockquote>
<p>Q: In <code>offer()</code> function, why we need to check the peek with the element we just added?</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">q.offer(e);</span><br><span class="line"><span class="keyword">if</span> (q.peek() == e) &#123;</span><br><span class="line">    leader = <span class="keyword">null</span>;</span><br><span class="line">    available.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Once we’ve added the element, if the peek element becomes the one we just added, it means the element will be earliest one to come out of the queue (this is exactly the issue that approach 2 cannot handle!). If we ignore it, no thread will be aware of it and the leader will still wait for the previous peek element!</p>
<p>To figure out how exactly it works, let’s go through one example. Suppose now the peek element’s name is A, and its delay is 1 hour. In addition, we have one or more thread blocking on <code>take()</code> because element A cannot be out until 1 hour later. The leader thread, say thread-1, blocks on <code>awaitNanos()</code> (or say, it is waiting for A to become available) and other threads (if any) are waiting until signal as either of them is not the leader:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (leader != <span class="keyword">null</span>)</span><br><span class="line">    available.await();</span><br></pre></td></tr></table></figure>

<p>Now, a new element B comes in, and its delay time is only 10 minutes. According to the code, it will set <code>leader</code> to <code>null</code> and notify one of the waiting thread.</p>
<ol>
<li>If there is only one waiting thread, which is thread-1, then it will stop waiting (line 65), enter the while loop again, get the peek element again (<strong>now the peek element will be B</strong>), and finally starts waiting for B;</li>
<li>If there are more than one thread, which means we have followers, then the thread signaled is not necessarily thread-1!<ul>
<li>if thread-1 get signaled, then it is same with 1;</li>
<li>otherwise (<strong>here comes the tricky part</strong>), another thread, say thread-2, wakes up! Since <code>offer()</code> function also sets <code>leader</code> to <code>null</code>, so thread-2 will re-enter the loop in <code>take()</code> and becomes the leader, and it will also start to wait for B. As for thread-1, it will wake up once the timeout happens (1 hour) or signaled by other operations.</li>
</ul>
</li>
</ol>
<blockquote>
<p>Q: After one thread takes an element, why do we need to signal?</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; q.peek() != <span class="keyword">null</span>)</span><br><span class="line">        available.signal();</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is in fact apparent: all follower threads are actually waiting infinitely, we must notify one of the threads if there is <strong>no leader</strong> but <strong>the queue has elements inside it</strong>. Generally, you can find that <code>available.signal()</code> is in fact to <strong>make sure there is a new when a newer element becomes available at the head of the queue or a new thread may need to become leader</strong> (this is the comment in the source code :P).</p>
<blockquote>
<p>Q: Why we need to do this: <code>first = null</code>?</p>
</blockquote>
<p>According to the Doug Lea’s comment after this line, we know this is to avoid memory leakage. If a thread (thread-1) is not the leader but it is still holding <code>first</code> in its thread, then after <code>first</code> is taken by the leader, it cannot be collected by Java GC (though it should be) as long as thread-1 keeps waiting.</p>
<blockquote>
<p>Q: When a thread start to waiting in the <code>take()</code> method, does it keep holding the lock?</p>
</blockquote>
<p>No, it will not. Note, <code>availability</code> is associated with the current lock!</p>
<p>The doc says:</p>
<blockquote>
<p><code>void await()
     throws InterruptedException</code><br>Causes the current thread to wait until it is signalled or interrupted.</p>
<p>The lock associated with this Condition is atomically released and the current thread becomes disabled for thread scheduling purposes and lies dormant until one of four things happens:</p>
<ul>
<li>Some other thread invokes the signal() method for this Condition and the current thread happens to be chosen as the thread to be awakened; or</li>
<li>Some other thread invokes the signalAll() method for this Condition; or</li>
<li>Some other thread interrupts the current thread, and interruption of thread suspension is supported; or</li>
<li>A “spurious wakeup” occurs.</li>
</ul>
<p>In all cases, before this method can return the current thread must re-acquire the lock associated with this condition. When the thread returns it is guaranteed to hold this lock.</p>
</blockquote>
<h3 id="Approach-4-implement-a-delay-queue-by-ourselves"><a href="#Approach-4-implement-a-delay-queue-by-ourselves" class="headerlink" title="Approach 4: implement a delay queue by ourselves!"></a>Approach 4: implement a delay queue by ourselves!</h3><p>Okay, as we get clear with the mechanism of this class, we can totally implement the scheduler without <code>DelayQueue</code>. Some part of the codes will remain the same.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayedScheduler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;DelayTask&gt; queue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition available;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock;</span><br><span class="line">    <span class="keyword">private</span> Thread leader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayedScheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> PriorityBlockingQueue();</span><br><span class="line">        <span class="keyword">this</span>.lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">this</span>.available = <span class="keyword">this</span>.lock.newCondition();</span><br><span class="line">        <span class="keyword">this</span>.leader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.startExecute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future <span class="title">schedule</span><span class="params">(Runnable task, <span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">        DelayTask newTask = <span class="keyword">new</span> DelayTask(task, delayTime);</span><br><span class="line">        <span class="keyword">this</span>.offer(newTask);</span><br><span class="line">        <span class="keyword">return</span> newTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runnable execute = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    DelayTask task = <span class="keyword">this</span>.take();</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTree();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> Thread(execute, <span class="string">"Executor"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(DelayTask task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.queue.offer(task);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.queue.peek() == task) &#123;</span><br><span class="line">                <span class="keyword">this</span>.leader = <span class="keyword">null</span>;</span><br><span class="line">                available.signal();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DelayTask <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                DelayTask peek = <span class="keyword">this</span>.queue.peek();</span><br><span class="line">                <span class="keyword">if</span> (peek == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// no element at all, just wait!</span></span><br><span class="line">                    available.await();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">long</span> delay = peek.getDelay(TimeUnit.NANOSECONDS);</span><br><span class="line">                    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">this</span>.queue.poll();</span><br><span class="line">                    <span class="keyword">if</span> (leader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// not the leader, need to waits</span></span><br><span class="line">                        <span class="keyword">this</span>.available.await();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Thread curThread = Thread.currentThread();</span><br><span class="line">                        <span class="keyword">this</span>.leader = curThread;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            available.awaitNanos(delay);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (curThread == <span class="keyword">this</span>.leader) <span class="keyword">this</span>.leader = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.queue.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                available.signal();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, this is still kind of overkilled. Why? Because we will not have multiple thread calling <code>take()</code> at the same time! Thus, we might not need to use the leader/follower pattern here, and we can simplify the code further.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayedSchedulerSelfDev</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;DelayedTask&gt; queue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition available;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">put</span><span class="params">(DelayedTask task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.queue.offer(task);</span><br><span class="line">            <span class="keyword">if</span> (task == <span class="keyword">this</span>.queue.peek()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.available.signal();   <span class="comment">// wake up one thread (not all!)</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DelayedTask <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                DelayedTask peekTask = <span class="keyword">this</span>.queue.peek();</span><br><span class="line">                <span class="keyword">if</span> (peekTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// no elemnets; wait!</span></span><br><span class="line">                    available.await();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">long</span> delay = peekTask.getDelay(TimeUnit.NANOSECONDS);</span><br><span class="line">                    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">this</span>.queue.poll();</span><br><span class="line">                    available.awaitNanos(delay);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see, you don’t need to maintain a <code>leader</code> thread now. The logic for <code>take()</code> is also much simpler: the thread either waits forever if there is no element (until signaled) or waits until the first element becomes available.</p>
<h3 id="Distributed-Scheduler"><a href="#Distributed-Scheduler" class="headerlink" title="Distributed Scheduler"></a>Distributed Scheduler</h3><p>Let’s talk about it in another post if we have time!</p>
</span> -->
        </article>
    
        

        
            <h1>2020</h1>
        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/08/12/Magic-Bitwise-Operation-Benwick-Tree/">Magic Bitwise Operation: Benwick Tree</a>
            <span class="archive-item-date">Aug 12, 2020</span>
            <!-- <span style=> <p>First, let’s look at one problem on the LeetCode:</p>
<p>Given an integer array <code>nums</code>, find the sum of the elements between indices <code>i</code> and <code>j</code> (<code>i</code> ≤ <code>j</code>), inclusive. The <code>update(i, val)</code> function modifies <code>nums</code> by updating the element at index <code>i</code> to <code>val</code>.</p>
<p>Example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Given nums &#x3D; [1, 3, 5]</span><br><span class="line"></span><br><span class="line">sumRange(0, 2) -&gt; 9</span><br><span class="line">update(1, 2)</span><br><span class="line">sumRange(0, 2) -&gt; 8</span><br></pre></td></tr></table></figure>

<p>Fro this question, a simple and naive solution is to maintain a prefix sum array for this input array and then we can easily get the sum of any sub array. However, the array itself will be updated at some entries, and the prefix sum array will also be updated, which could be expensive. Is there any better solution for this problem?</p>
<p>Say we have an array below:</p>
<pre><code>array = [1,3,4,7,10,34,1,8]</code></pre><p>For convenience, we will index the array staring with 1. In other words,</p>
<pre><code>array[1] = 1
array[2] = 3
...</code></pre><h2 id="Warm-up"><a href="#Warm-up" class="headerlink" title="Warm-up"></a>Warm-up</h2><p>We construct a binary tree with all of these indices:</p>
<img src="tree_1.svg" alt="tree_1" width="500"/>

<p>We assign each node a number with the index of the node.</p>
<p><strong><em>For node <code>i</code>, the value of this node is the sum of all array entries will all indices in its left sub-tree and itself</em></strong>.</p>
<p>In other words, say <code>node(i)</code> is the value of the node with index <code>i</code>:</p>
<pre><code>node(1) = array[1]
node(2) = array[1] + array[2]
node(3) = array[3]
node(4) = array[1] + array[2] + array[3] + array[4]
node(5) = array[5]
node(6) = array[5] + array[6]
node(7) = array[7]
node(8) = array[1] + array[2] + array[3] + array[4] + array[5] + array[6] + array[7] + array[8]</code></pre><p>We can write it in another way:</p>
<pre><code>node(1) = array[1]
node(2) = node(1) + array[2]
node(3) = array[3]
node(4) = node(2) + node(3) + array[4]
node(5) = array[5]
node(6) = node(5) + array[6]
node(7) = array[7]
node(8) = node(4) + node(6) + node(7) + array[8]</code></pre><p>Put the values in the tree:</p>
<img src="tree_2.svg" alt="tree_2" width="500"/>

<p>You might get confused. What can we do with this tree? Well, think about two questions.</p>
<blockquote>
<p>How can we find prefix sum of the array?</p>
</blockquote>
<p>Say we want to get the sum of all entries before index <code>i</code> (inclusive). You will find we can always find a node-to-top path in the tree whose sum of all values on that path if the prefix sum.</p>
<p>For example, say now <code>i</code> is 6，we start the node 6, get the value of node 6; as node 6’s value is the sum of <code>array[5]</code> and <code>array[6]</code>, we only need to get the sum of <code>array[1]</code>, <code>array[2]</code>, <code>array[3]</code> and <code>array[4]</code>, which is the value of node 4. Thus, the path is <code>6 -&gt; 4</code>.</p>
<p>We will later generalize a way to get the path for calculating the prefix sum.</p>
<blockquote>
<p>If we update one entry of the array, how can we update the nodes’ values in the tree?</p>
</blockquote>
<p>Apparently, <strong><em>all nodes whose values contain the modified entry will have to be updated.</em></strong> For example, say <code>array[3]</code> is changed, node 3, 4 and 8 will be to be updated. We also have a path to update these nodes one by one: <code>3 -&gt; 4 -&gt; 8</code>. We will later generalize this problem as well.</p>
<p>Now, I believe you are still confused with this tree. A question you might ask is: <em>How can we construct a tree like this? What are the properties of this tree?</em></p>
<h2 id="Construction"><a href="#Construction" class="headerlink" title="Construction"></a>Construction</h2><p>Here we will discuss some properties of this tree:</p>
<p>Let’s convert all the node numbers into binary.</p>
<img src="tree_3.svg" alt="tree_3" width="400"/>

<h3 id="Parent-and-Child-Nodes"><a href="#Parent-and-Child-Nodes" class="headerlink" title="Parent and Child Nodes"></a>Parent and Child Nodes</h3><ul>
<li>If this node is its parent node’s left child node, then its parent node is: <strong>increment the last set bit of this node number</strong>. For example, if we increment the last set bit of 2 (0010), we get 4, which is the parent node of node 2.</li>
<li>If this node is its parent node’s right child node, then its parent node is: <strong>remove the last set bit of this node number</strong>. For example, if we remove the last set bit of 7 (0111), we get 6, which is the parent node of node 6.</li>
</ul>
<p>Though these observations will help us understand the tree better, we do not need these information, as you will see later.</p>
<h3 id="Tree-Shape"><a href="#Tree-Shape" class="headerlink" title="Tree Shape"></a>Tree Shape</h3><p>With the previous property, it is not easy to get that, for a node <code>i</code>, its parent node and child nodes will always be fixed, and it is independent of the array’s length. More interestingly, a non-root node in the tree might not have a parent node.</p>
<p>The picture above shows the tree of an array of length 8. The picture below shows trees for arrays with length 10 and 15.</p>
<img src="tree_4.svg" alt="tree_4" width="500"/>

<p>You can see that, every time we are given an array, the tree is already there. A longer array just means we should add more nodes to the tree.</p>
<p>We can find more properties of the tree based on the binary representation.</p>
<h2 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h2><p>In the warm-up section we have discussed how can we get the prefix sum of the array and how can we update the tree if we update the array. Here, we will generalize the answer to these two problems.</p>
<h3 id="Prefix-Sum"><a href="#Prefix-Sum" class="headerlink" title="Prefix Sum"></a>Prefix Sum</h3><p>what is the prefix sum of the array at index <code>i</code> (inclusive) (note: we still use 1-based indexing here)? Similarly, we still wish to find a path (starting at <code>i</code>) that the sum of all values on that path is the prefix sum. <strong><em>It is not hard to find out that the node number on that path will be decreasing</em></strong>, as we need to sum all nodes’ values with lower indices. Thus, for a node <code>i</code>, in order to find the nodes with lower indices, there are three parts we need to consider:</p>
<ol>
<li>Its left sub tree. Apparently, we can ignore this part, as node <code>i</code> already contains all values in its left tree.</li>
<li>Node at the same or lower <strong><em>level</em></strong> (see picture below) which are smaller than <code>i</code> (e.g., node 1, 2 and 3 for node 6). We can also ignore this part because all such nodes will be included by a node on a higher level, which will be discussed in the case 3 (e.g., node 1, 2 and 3 are included by node 4).</li>
<li>Nodes with higher level which are smaller than <code>i</code>. For example, if <code>i</code> is 5, the next node on the path should be 4.</li>
</ol>
<img src="tree_5.svg" alt="tree_5" width="400"/>

<p>A straightforward way to find the prefix sum path is: starting at node <code>i</code>, go to its parent node, if its node is smaller than <code>i</code>, then add it to the path; continue it until we reach the root.</p>
<p>In fact, we have a better way to find the next node: <strong><em>remove the last set bit of <code>i</code>, the new number is just the next node which is smaller than <code>i</code> and on a higher level</em></strong>. It can be expressed as <code>i - i &amp; (-i)</code>, where <code>i &amp; (-i)</code> is the last set bit and all zeros after this bit. For example, if <code>i</code> is 7, the path is <code>0111(7) -&gt; 0110(6) -&gt; 0100(4) -&gt; 0000(0) (end of the path)</code>; if <code>i</code> is 9, the path is <code>1001(9) -&gt; 1000(8) -&gt; 0000(0)</code>.</p>
<p>This observation is really helpful for coding. You will feel it magic, but we can always find an explanation. In fact, the last set bit of one node always indicates the level of this node, for example, if last set bit of 10 and 14 is <code>10</code>, which means they are on the second level; <code>1</code> indicates the first level and <code>100</code> indicates the third level. Thus, for a given node <code>i</code>, if we want find the next smaller node which is on a higher level, then apparently, we just need to remove the last set bit of <code>i</code>.</p>
<p>A snippet of code to get the prefix sum:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> prefixSum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    prefixSum += tree[i];  <span class="comment">// the tree can be represented as an array</span></span><br><span class="line">    i -= i &amp; (-i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Update-the-Tree"><a href="#Update-the-Tree" class="headerlink" title="Update the Tree"></a>Update the Tree</h3><p>If the array is updated, we then need to update the tree as well. Apparently, we need to find all nodes that are affected by the modified entry of the array. Instead of finding a descending path in the last problem, here we need to find an ascending path.</p>
<p>How can we find larger nodes of node <code>i</code>? Similarly, we can also have three cases like we did for the last problem, but we only need to consider one part: <strong>all nodes at higher levels which are larger than <code>i</code></strong>.</p>
<p>Thus, similarly, we can also find the path by starting with <code>i</code> and recursively finding parent nodes. However, a more concise way is to just <strong>increment the last set bit of <code>i</code></strong>, which can be expressed as <code>i + i &amp; (-i)</code>. It also has a good explanation: we need to find the next larger number whose last set bit is also higher, thus incrementing the last set bit is just the solution.</p>
<p>It is then trivial to update the tree.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// diff is the diff between the old value and new value on index i</span></span><br><span class="line"><span class="comment">// n is the length of array</span></span><br><span class="line"><span class="keyword">while</span> (i &lt;= n) &#123;</span><br><span class="line">    tree[i] += diff;</span><br><span class="line">    i += i &amp; (-i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>It is kind of hard to fully understand this magic data structure, but coding with all of these ideas is pretty easy. Here is a solution to the original LeetCode problem.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NumArray</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] nums;</span><br><span class="line">    <span class="keyword">int</span>[] tree;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NumArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nums = nums;</span><br><span class="line">        <span class="keyword">this</span>.len = nums.length;</span><br><span class="line">        <span class="keyword">this</span>.tree = <span class="keyword">new</span> <span class="keyword">int</span>[len+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            updateTree(i, nums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateTree</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> diff)</span> </span>&#123;</span><br><span class="line">        i += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt;= len) &#123;</span><br><span class="line">            <span class="keyword">this</span>.tree[i] += diff;</span><br><span class="line">            i += i &amp; (-i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> diff = val - nums[i];</span><br><span class="line">        nums[i] = val;</span><br><span class="line">        updateTree(i, diff);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sumRange</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getPrefixSum(j) - getPrefixSum(i - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrefixSum</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        i ++;</span><br><span class="line">        <span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sum += tree[i];</span><br><span class="line">            i -= i &amp; (-i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The time complexity of the two methods are both <code>O(logN)</code> where <code>N</code> is the length of the input array.</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/18/string-algorithm/">Algorithms Case Study: String</a>
            <span class="archive-item-date">Apr 18, 2020</span>
            <!-- <span style=> <p>In this post, we want to study and summarize some well-known algorithms for Strings.</p>
<h2 id="String-Sorts"><a href="#String-Sorts" class="headerlink" title="String Sorts"></a>String Sorts</h2><h3 id="LSD"><a href="#LSD" class="headerlink" title="LSD"></a>LSD</h3><p>If we want to sort some items and each item is associated with a key (or ID). We could use <em>key-indexed</em> counting to sort, which is very efficient. This method also indicates that we could follow the same idea to sort <strong>fixed-length</strong> strings, which is called <strong><em>least-significant-digit first (LSD)</em></strong> sort.</p>
<p>The basic idea is to conduct key-indexed counting for w times, where w is the length of each string.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LSD</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a, <span class="keyword">int</span> W)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// W is the length of each string in a</span></span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        String[] aux = <span class="keyword">new</span> String[N];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> d = W - <span class="number">1</span>; d &gt;= <span class="number">0</span>; d--) &#123;</span><br><span class="line">            <span class="comment">// Sort by key-indexed counting on dth char.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span>[] count = <span class="keyword">new</span> <span class="keyword">int</span>[R+<span class="number">1</span>];</span><br><span class="line">            <span class="comment">// Computer frequency counts.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                count[a[i].charAt(d) + <span class="number">1</span>] ++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Transform counts to indices.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> r = <span class="number">0</span>; r &lt; R; r++) &#123;</span><br><span class="line">                count[r+<span class="number">1</span>] += count[r];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Distribute.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                aux[count[a[i].charAt(d)]++] = a[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Copy back.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                a[i] = aux[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] a  = &#123;<span class="string">"43FRFN"</span>, <span class="string">"423FFE"</span>, <span class="string">"D439JN"</span>, <span class="string">"10NE2E"</span>,</span><br><span class="line">                        <span class="string">"DDERFR"</span>, <span class="string">"340FEW"</span>, <span class="string">"104FDS"</span>, <span class="string">"R4053N"</span>&#125;;</span><br><span class="line">        LSD.sort(a, <span class="number">6</span>);</span><br><span class="line">        System.out.println(Arrays.toString(a));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Time complexity: <code>O(W(N + R))</code>, where <code>N</code> is the number of all string to be sorted, <code>R</code> is the radix (number of characters in alphabet) and <code>W</code> is the width of each string.</p>
<p>Space complexity: <code>O(N + R)</code>, as we use two additional arrays.</p>
<p>Remember that there are some requirements when applying this method:</p>
<ol>
<li>Each string has the same length (certainly we can modify this method to accommodate this case, but we have other algorithms that work well for this scenario);</li>
<li>We know the radix of the alphabet of these strings (in this case, 256).</li>
</ol>
<h3 id="MSD"><a href="#MSD" class="headerlink" title="MSD"></a>MSD</h3><p>LSD algorithm listed above only works for fix-length strings. Here we want to implement an algorithm that works for a general purpose: <em>most-significant-digit-first (MSD)</em>.</p>
<p>We still follow the basic idea of key-indexed counting to complete this algorithm. Now, as the algorithm’s name indicates, we will start sorting based on the most significant digits. So, if we have sorted them based on the first digit, what should we do next? <strong>We can group (or split) these strings and sort in each group based on other digits,</strong> which requires a recursive algorithm.</p>
<p>Remember, this algorithm does not require all strings with same length. What should we do if, in a group, there are string which are shorter than others and we have reached the end of these short strings during key-indexed counting? Okay, we know that shorter strings here should be sorted first, so here is the solution:</p>
<p>Implement a new <code>toChar()</code> method that can convert from an indexed string character to an array index that returns -1 if the specified character position is pass the end of the string. Then, we just add 1 to each returned value, so get a nonnegative <code>int</code> that we can use to index <code>count[]</code>. It means we have <code>R+1</code> possible character values at each string position:</p>
<ul>
<li><code>0</code> to signify the end of the string;</li>
<li><code>1</code> for the first alphabet character;</li>
<li><code>2</code> for the second alphabet character;</li>
</ul>
<p>With all these practices above, now it is easy to write down the real code.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MSD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> R = <span class="number">256</span>;  <span class="comment">// radix</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> M = <span class="number">0</span>;  <span class="comment">// cutoff for small subarrays</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] aux; <span class="comment">// auxiliary array for distribution</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        aux = <span class="keyword">new</span> String[N];</span><br><span class="line">        sort(a, <span class="number">0</span>, N-<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Cut-off if the number of string is too small</span></span><br><span class="line">        <span class="keyword">if</span> (lo + M &gt;= hi) &#123;</span><br><span class="line">            Insertion.sort(a, lo, hi, d);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] count = <span class="keyword">new</span> <span class="keyword">int</span>[R+<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// Compute frequency counts.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt;= hi; i++) &#123;</span><br><span class="line">            count[charAt(a[i], d) + <span class="number">2</span>] ++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Transform counts to indices.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; R +<span class="number">1</span>; i++) &#123;</span><br><span class="line">            count[i+<span class="number">1</span>] += count[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Distribute.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt;= hi; i++) &#123;</span><br><span class="line">            aux[count[charAt(a[i], d) + <span class="number">1</span>]++] = a[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Copy back.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt;= hi; i++) &#123;</span><br><span class="line">            <span class="comment">// Consider why i - lo here: because we only sort hi- lo + 1 strings, starting with index 0 in aux</span></span><br><span class="line">            a[i] = aux[i - lo];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Recursive call: process to the next d for each split</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> r = <span class="number">0</span>; r &lt; R; r++) &#123;</span><br><span class="line">            sort(a, lo + count[r], lo + count[r+<span class="number">1</span>] - <span class="number">1</span>, d + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">charAt</span><span class="params">(String s, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; s.length())</span><br><span class="line">            <span class="keyword">return</span> s.charAt(index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] a = &#123;<span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"seashells"</span>, <span class="string">"by"</span>, <span class="string">"the"</span>, <span class="string">"sea"</span>,</span><br><span class="line">                        <span class="string">"shore"</span>, <span class="string">"the"</span>, <span class="string">"shells"</span>, <span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"are"</span>, <span class="string">"surely"</span>, <span class="string">"seashells"</span>&#125;;</span><br><span class="line">        sort(a);</span><br><span class="line">        System.out.println(Arrays.toString(a));</span><br><span class="line">        String[] b = &#123;<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>&#125;;</span><br><span class="line">        sort(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that we add a “cutoff-for-small-subarrays” before the sort really begins. why do we need this?</p>
<p>As we can see, the method quickly divides the array to be sorted into small subarrays. But this is also a double-edged sword: we are certain to have to handle huge numbers of tiny subarrays, so we had better be sure that we handle them efficiently. Each sort involves initializing the 258 (if <code>R = 256</code>) entries of the <code>count[]</code> array to <code>0</code> and transforming them all to indices. Accordingly, the switch to insertion sort for small subarrays is a must for MSD string sort (in the code I simply use a <code>Insertion.sort()</code> for this part).</p>
<p>Please also note another pitfall of MSD sort algorithm: it can be relatively slow for subarrays containing large numbers of equal keys. <strong><em>The worst case for MSD string sorting is when all key are equal</em></strong>: the algorithm cannot make smaller subarrays after each iteration (d). In this case, out program will have to examine every character in all input strings, and the running time is linear in the number of characters in the data (like LSD string sort).</p>
<p>In many cases, we should treat the input strings are randomly generated. In this case, MSD string sort examines just enough characters to distinguish among the keys, and the running time is sub-linear in the number of characters in the data.</p>
<h3 id="Three-way-string-quicksort"><a href="#Three-way-string-quicksort" class="headerlink" title="Three-way string quicksort"></a>Three-way string quicksort</h3><p>This algorithm borrows the idea from quick sort.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quick3string</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a)</span> </span>&#123;</span><br><span class="line">        sort(a, <span class="number">0</span>, a.length - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (lo &gt;= hi) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> lt = lo, gt = hi;</span><br><span class="line">        <span class="keyword">int</span> i = lo + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> v = charAt(a[lo], d);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt;= gt) &#123;</span><br><span class="line">            <span class="keyword">int</span> t = charAt(a[i], d);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (t &lt; v) exch(a, lt++, i++);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (t &gt; v) exch(a, i, gt--);</span><br><span class="line">            <span class="keyword">else</span> i ++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sort(a, lo, lt - <span class="number">1</span>, d);</span><br><span class="line">        <span class="keyword">if</span> (v &gt;= <span class="number">0</span>) sort(a, lt, gt, d + <span class="number">1</span>);</span><br><span class="line">        sort(a, gt + <span class="number">1</span>, hi, d);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">charAt</span><span class="params">(String s, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; s.length())</span><br><span class="line">            <span class="keyword">return</span> s.charAt(index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exch</span><span class="params">(String[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        String tmp = a[i];</span><br><span class="line">        a[i] = a[j];</span><br><span class="line">        a[j] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] a = &#123;<span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"seashells"</span>, <span class="string">"by"</span>, <span class="string">"the"</span>, <span class="string">"sea"</span>,</span><br><span class="line">                <span class="string">"shore"</span>, <span class="string">"the"</span>, <span class="string">"shells"</span>, <span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"are"</span>, <span class="string">"surely"</span>, <span class="string">"seashells"</span>&#125;;</span><br><span class="line">        sort(a);</span><br><span class="line">        System.out.println(Arrays.toString(a));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This algorithm will always partition the array into three subarrays, which is different from MSD as MSD might generate many subarrays and many of them might be small or even empty subarrays. It can adapt well to handling equal keys, keys with long common prefixes. <strong>It will not use extra space, just like quick sort</strong>.</p>
<p>An interesting fact will be found when you try to compare this algorithm with standard quicksort. Indeed, one way to think 2-way string quick sort is <strong><em>as a way for standard quicksort to keep track of leading characters that are known to be equal</em></strong>. Note: no algorithm can beat 3-way string quicksort by more than a constant factor.</p>
<h2 id="Tries"><a href="#Tries" class="headerlink" title="Tries"></a>Tries</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrieSTNew</span>&lt;<span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Object val;</span><br><span class="line">        <span class="keyword">private</span> Node[] next = <span class="keyword">new</span> Node[R];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When finding the node, we use recursion rather than iteration.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Value <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Node node = get(root, key, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> (Value) node.val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">get</span><span class="params">(Node x, String key, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Return value associated with key in the subtrie rooted at x.</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Remember, right now we are at the node corresponding to char at index d-1</span></span><br><span class="line">        <span class="keyword">if</span> (d == key.length()) <span class="keyword">return</span> x;</span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        <span class="keyword">return</span> get(x.next[c], key, d + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, Value value)</span> </span>&#123;</span><br><span class="line">        root = put(root, key, value, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">put</span><span class="params">(Node x, String key, Value value, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) x = <span class="keyword">new</span> Node();</span><br><span class="line">        <span class="comment">// Remember, right now we are at the node corresponding to char at index d-1</span></span><br><span class="line">        <span class="keyword">if</span> (d == key.length()) &#123;</span><br><span class="line">            x.val = value;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        x.next[c] = put(x.next[c], key, value, d + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		TrieSTNew&lt;Integer&gt; trie = <span class="keyword">new</span> TrieSTNew&lt;&gt;();</span><br><span class="line">		trie.put(<span class="string">"dede"</span>, <span class="number">0</span>);</span><br><span class="line">		trie.put(<span class="string">"de"</span>, <span class="number">0</span>);</span><br><span class="line">		trie.put(<span class="string">"deeffe"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String str: trie.keys()) &#123;</span><br><span class="line">			System.out.print( str+<span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		System.out.println(trie.root);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Collecting-keys"><a href="#Collecting-keys" class="headerlink" title="Collecting keys"></a>Collecting keys</h3><p>Now, we are going to implement some methods for collecting keys. The above code contains some basic operations including <code>get</code> and <code>put</code>. Now we will continue to implement some method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> keysWithPrefix(<span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">keysWithPrefix</span><span class="params">(String pre)</span> </span>&#123;</span><br><span class="line">    Queue&lt;String&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    collect(<span class="keyword">this</span>.get(root, pre, <span class="number">0</span>), pre, queue);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(Node x, String pre, Queue&lt;String&gt; q)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Starting with Node x, find all keys</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) q.add(pre);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c = <span class="number">0</span>; c &lt; R; c++)</span><br><span class="line">        collect(x.next[c], pre + c, q);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Wildcard-match"><a href="#Wildcard-match" class="headerlink" title="Wildcard match"></a>Wildcard match</h3><p>Wildcard match: to implement <code>keysThatMatch()</code> method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">keysThatMatch</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">    Queue&lt;String&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    collect(root, <span class="string">""</span>, pat, queue);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(Node x, String pre, String pat, Queue&lt;String&gt; queue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">int</span> len = pre.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == pat.length()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) queue.add(pre);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> next = pat.charAt(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c = <span class="number">0</span>; c &lt; R; c ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == next || c == <span class="string">'.'</span>)</span><br><span class="line">            collect(x.next[c], pre + c, pat, queue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Longest-prefix"><a href="#Longest-prefix" class="headerlink" title="Longest prefix"></a>Longest prefix</h3><p>Now we also want to method <code>longestPrefixOf(String s)</code> to find the longest string which is a prefix of a given string. The principle is quite similar: go down the trie with the given string; once we find a node with a non-null value, we just update the length.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">longestPrefixOf</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length = search(root, s, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> s.substring(<span class="number">0</span>, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(Node x, String s, <span class="keyword">int</span> d, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> length;</span><br><span class="line">    <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) length = d;</span><br><span class="line">    <span class="keyword">if</span> (d == s.length()) <span class="keyword">return</span> length;</span><br><span class="line">    <span class="keyword">char</span> c = s.charAt(d);</span><br><span class="line">    <span class="keyword">return</span> search(x.next[c], s, d + <span class="number">1</span>, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Deletion"><a href="#Deletion" class="headerlink" title="Deletion"></a>Deletion</h3><p>What if we want to delete a key? Apparently, the first step is to find the node corresponding to the input string and then set the value to <code>null</code>. However, we need to remove many nodes all the way down. This can be easily implemented with the recursive method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    root = delete(root, key, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">delete</span><span class="params">(Node x, String key, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (d == key.length()) &#123;</span><br><span class="line">        <span class="comment">// Find the node representing the key</span></span><br><span class="line">        x.val = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Keep going down and find the node.</span></span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        x.next[c] = delete(x.next[c], key, d + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) <span class="keyword">return</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c = <span class="number">0</span>; c &lt; R; c ++) &#123;</span><br><span class="line">        <span class="comment">// Check if x have a non-null link</span></span><br><span class="line">        <span class="keyword">if</span> (x.next[c] != <span class="keyword">null</span>) <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>It is easy to prove the time complexity of this algorithm. What about space?</p>
<p>The number of links in a trie us between <code>RN</code> and <code>RNw</code>, where w is the average key length.</p>
<h2 id="TSTs"><a href="#TSTs" class="headerlink" title="TSTs"></a>TSTs</h2><p>Ternary search tries (TSTs) are used to avoid the excessive space cost associated with R-way tries. In a TST, each node has a character, three links, and a value.The three links corresponds to keys whose current characters are less than, equal, or greater than the node’s character.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TSTNew</span>&lt;<span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> c;</span><br><span class="line">        Node left, mid, right;</span><br><span class="line">        Value value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Value <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Node node = get(root, key, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Note: value could be null</span></span><br><span class="line">        <span class="keyword">return</span> node.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">get</span><span class="params">(Node x, String key, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        <span class="keyword">if</span> (c &lt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the left side.</span></span><br><span class="line">            <span class="keyword">return</span> get(x.left, key, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the right side.</span></span><br><span class="line">            <span class="keyword">return</span> get(x.right, key, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (d &lt; key.length() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// Have not reached the end of key, need to go down.</span></span><br><span class="line">            <span class="keyword">return</span> get(x.mid, key, d + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Have reached the end of the key.</span></span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, Value val)</span> </span>&#123;</span><br><span class="line">        root = put(root, key, val, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">put</span><span class="params">(Node x, String key, Value val, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x = <span class="keyword">new</span> Node();</span><br><span class="line">            x.c = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c &lt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the left side.</span></span><br><span class="line">            x.left = put(x.left, key, val, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the rigth side.</span></span><br><span class="line">            x.right = put(x.right, key, val, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (d &lt; key.length() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// Have not reached the end of the key.</span></span><br><span class="line">            x.mid = put(x.mid, key, val, d + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Have reached the end of the key.</span></span><br><span class="line">            x.value = val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The number of links in a TST build from N string keys of average length <code>w</code> is between <code>3N</code> and <code>3Nw</code>.</p>
<h2 id="Substring-Search"><a href="#Substring-Search" class="headerlink" title="Substring Search"></a>Substring Search</h2><h3 id="Brute-force"><a href="#Brute-force" class="headerlink" title="Brute-force"></a>Brute-force</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringSearch</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is the brute-force substring search</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String pat, String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> N = txt.length();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N - M; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> j;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j ++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (txt.charAt(i + j) != pat.charAt(j))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(search(<span class="string">"ABRA"</span>, <span class="string">"ABACADABRAC"</span>));</span><br><span class="line">        System.out.println(search(<span class="string">"ABRA"</span>, <span class="string">"ABACADABRBC"</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Time complexity: <code>O(MN)</code>. Below is an alternative solution.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">search2</span><span class="params">(String pat, String txt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> M = pat.length();</span><br><span class="line">    <span class="keyword">int</span> N = txt.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; N &amp;&amp; j &lt; M; i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (txt.charAt(i) == pat.charAt(j)) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            i -= j;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i - M;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> N;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="KMP-Algorithm"><a href="#KMP-Algorithm" class="headerlink" title="KMP Algorithm"></a>KMP Algorithm</h3><p>Here I will introduce two versions of KMP algorithms.</p>
<h4 id="2D-Version-with-DFA"><a href="#2D-Version-with-DFA" class="headerlink" title="2D Version with DFA"></a>2D Version with DFA</h4><p>As we mentioned in the brute-force substring match algorithm (the alternate one), if we find a mismatch at some point, <code>j</code> has to set to be <code>0</code> and <code>i</code> will also decremented. This is the main reason that the running time of that algorithm is high.</p>
<p>Is there a way which avoids decrementing the value of ‘j’. This is what KMP algorithm tries to achieve. The basic idea behind the algorithm discovered by Knuth, Morris, and Pratt is this: whenever we detect a mismatch, <em>we already know some of the characters in the text</em>, since they matched the pattern characters prior to the mismatch.</p>
<p>In KMP substring search, we never back up the text pointer <code>i</code>, and we use an array <code>dfa[][]</code> to record how far to back up the pattern pointer <code>j</code> when a mismatch is detected. For every character <code>c</code>, <code>dfa[c][j]</code> is the pattern position to compare with next text position after comparing <code>c</code> with <code>pat.charAt(j)</code>. During the search, <strong><code>dfa[txt.charAt(i)][j]</code> is the pattern position to compare with <code>txt.charAt(i)</code> with <code>pat.charAt(j)</code></strong>. Thus, <code>dfa[pat.charAt(j)][j]</code> is always <code>j+1</code>.</p>
<p>Once we have computed DFA, we then can easily search the match with DFA. You may ask, why we have to call it “DFA”?</p>
<p>In fact, “DFA” represents <em>deterministic finite-state automation</em>. For example, for a pattern <code>A B A B A C</code>, the DFA will be (we will later study how can we construct DFA):</p>
<pre><code>   A B C D E F
j  0 1 2 3 4 5
   -----------
A |1 1 3 1 5 1
B |0 2 0 4 0 4
C |0 0 0 0 0 6</code></pre><p>Please note that here we assume there are only three characters (A, B, and C) in the alphabet. Below is the graphical representation of this DFA.</p>
<p><img src="dfa_graph.jpg" alt="dfa_graph"></p>
<p>We then could easily use this to finish the matching process. The input text string is “B C B A A B A C A A B A B A C A A”:</p>
<p><img src="dfa_process.jpg" alt="dfa_process"></p>
<p>Below is the code corresponding to the process showed in the picture.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KMP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[][] dfa;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KMP</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        dfa = <span class="keyword">new</span> <span class="keyword">int</span>[R][M];</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> construct the DFA array    </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, j;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length(), M = <span class="keyword">this</span>.pat.length();</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; N &amp;&amp; j &lt; M; i++) &#123;</span><br><span class="line">            j = dfa[txt.charAt(i)][j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i - M;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Up to now, you must feel the logic is natural and comfortable. Now, we have to know how can we construct DFA array with a given pattern string, which is much trickier and interesting.</p>
<p>When we have a mismatch at <code>pat.charAt(j)</code>, our interest is in knowing in what state the DFA <em>would be</em> if we were to back up the next index and rescan the text characters that we just saw after shifting to the right one position (remember, <code>i</code> is always incremented by <code>1</code> after a match or mismatch).</p>
<p>What should the DFA do with the next character? <strong><em>Exactly what it would have done if we had backed up</em></strong>, except if it finds a match with <code>pat.charAt(j)</code>, when it should go to state <code>j+1</code>. Certainly, this makes sense and is straightforward.</p>
<p>So, the question here is, what is the back up state X? before this question, we must know what exactly happens (or, say, what we should do) when backing up to state X. Here are two question to discussed about:</p>
<blockquote>
<p>Q: What we actually do after backing up to state <code>X</code>?</p>
</blockquote>
<p>If we back up to state X after a mismatch, keep <code>i</code> not changed, and set <code>j</code> to X. The definition of X should guarantee that <strong>all chars from index 0 to <code>j - 1</code> (i.e., <code>X - 1</code>) are matched with chars prior to <code>i</code> in the text string</strong>. We now, we just need to compare the char of index <code>j</code> (<code>X</code>) in the pattern string and the char of index <code>i</code> in the text string, this may proceed to a nigger state or a level state. Because our DFA is partially completed already, and <code>X &lt; j</code>, so we can use the DFA now! which is: <code>dfa[c][X]</code>, where <code>c</code> is the current text char at index <code>i</code>. And then, according to the definition of DFA, we get a new position for <code>j</code> (the result of <code>dfa[c][X]</code>), and <code>i</code> is incremented by 1.</p>
<p><strong><em>Thus, we can copy the entry values in state <code>X</code> to state <code>j</code>, except when we see a match: <code>dfa[pat.charAt(j)][j] = j + 1</code>.</em></strong></p>
<p>I know this is kind of confusing, so let’s look into 2 example. In both these examples, we use pattern string <code>A B A B A C</code>.</p>
<p><strong>~ Example 1</strong></p>
<p>Say we have completed the first column of DFA (the first column of this DFA is in fact the complete DFA for pattern string <code>A</code>), and we are building the second column. As mentioned earlier, we should back up (exception there is a match, and we will handle this case specially) to state <code>X</code>. <code>X</code> for the second column (<code>j = 1</code>) is <code>0</code> (we will explain why <code>X</code> is this value later).</p>
<pre><code>             (i)
txt string: A A C ...
pat string: A B A ...
             (j)</code></pre><p>We can see that when state is <code>1</code> (<code>j = 1</code>) we have a mismatch. As we said previously, we need to remain the value of <code>i</code>, and set <code>j</code> to <code>0</code>.</p>
<pre><code>             (i)
txt string: A A C...
pat string:   A B A...
             (j)
             (X)</code></pre><p>We have backed up the <code>X</code>, and we have not finished our job. We could only make sure that all chars from index <code>0</code> to <code>X - 1</code> is pattern string are matched (of course, it is none in this example), but how about char on index <code>X</code> (<code>i</code> for text string)? We cannot make sure it is also match.</p>
<p>In fact, because we have finished the first column of DFA, and <code>j</code> is <code>0</code> now, and you may also notice that <strong><em>we are actually doing a match</em></strong>! All of these indicate that we can use the partially completed DFA to determine a new state, which is given by <code>dfa[&#39;A&#39;][X]</code>. The first <code>A</code> indicates the char on index <code>i</code> in text string. If the text string is <code>A B ...</code>, then use <code>dfa[&#39;B&#39;][X]</code>. As we are building the second column of DFA, we might need a loop: <code>dfa[][j] = dfa[][X]</code> (note <code>j</code> here is the original <code>y</code>).</p>
<p>Continue this example. <code>dfa[&#39;A&#39;][X]</code>, which is also <code>dfa[&#39;A&#39;][0]</code> will return <code>1</code>. Thus, we set <code>j</code> to <code>1</code> and increment <code>i</code> by 1.</p>
<pre><code>               (i)
txt string: A A C...
pat string:   A B A...
               (j)</code></pre><p><strong>~ Example 2</strong></p>
<p>You may notice that the example 1 does not show that <strong>all chars from index 0 to <code>X - 1</code> are matched with chars prior to <code>i</code> in the text string</strong>. No worry, we can give you another example.</p>
<p>Suppose now we have a mismatch at index <code>j = 3</code>, and <code>X</code> is <code>1</code>. For example, it happens when the text string is <code>A B A C ...</code></p>
<pre><code>                 (i)
txt string: A B A C A...
pat string: A B A B A...
                 (j)</code></pre><p>As we discussed previously, we need to remain the value of <code>i</code>, and set <code>j</code> to <code>X</code>, which is <code>1</code>.</p>
<pre><code>                 (i)
txt string: A B A C A ...
pat string:     A B A B A ...
                 (j)
                 (X)</code></pre><p>We can see all chars from index <code>0</code> to <code>X - 1</code>, in fact, <code>A</code>, match with txt string. So, we only need to care about the chars after <code>X</code>, and we can just use value of <code>dfa[C][X]</code> as the DFA is partially built. The value given by it is <code>0</code>.</p>
<pre><code>                   (i)
txt string: A B A C A ...
pat string:         A B A B A ...
                   (j)</code></pre><p>I believe these two examples can help you understand the process that we build the DFA array. The key to understand the process is to be aware that state <code>X</code> <em>can make sure all chars prior to index <code>X</code> in pattern string have will be matched if we set <code>j</code> to <code>X</code> and do not change <code>i</code></em>.</p>
<p>There is another way to understand <code>X</code>, and it will help you understand the next question.</p>
<p>For a given string, we define its <strong><em>prefix set</em></strong> as the set of all its prefix (exclude the string itself) and <strong><em>suffix set</em></strong> as the set of all its suffix (exclude the string itself). <strong><code>X</code> will be the length of the longest string in the intersection set of the string’s prefix and suffix set</strong>. For example, for string <code>ABA</code>, longest string is <code>A</code>, and <code>X</code> is <code>1</code>; for <code>ABAB</code>, <code>X</code> will be <code>2</code>.</p>
<p>We have image the you are match two same strings, while sliding one to the left and another one to right. Once the overlapping matches, we get the <code>X</code> value. Take <code>ABAB</code> as an example:</p>
<pre><code>← A B A B
      A B A B →</code></pre><p>It should be easy to derive this representation once you have understand the two examples above.</p>
<p>In fact, this is also the way to compute the value of <code>X</code>. However, we don’t want to use this naive way, and here comes our second question.</p>
<blockquote>
<p>Q: How can we compute the value of <code>X</code>?</p>
</blockquote>
<p>At first, let’s talk about what is the initial value of <code>X</code> when we just start to build the DFA array.</p>
<ul>
<li>If we mismatch at state <code>0</code>, of course we should go back to state <code>0</code> (<code>j = 0</code>). This is totally understandable;</li>
<li>If we mismatch at state <code>1</code>, we could only back up to <code>0</code> as well as we cannot stay the same state.</li>
</ul>
<p>What if we mismatch at other positions? The method is, every time when we have finished one column of DFA, <strong>we need to update the value of <code>X</code></strong>.</p>
<p>Say we now have finished the first three columns of the DFA array and are building the 4th column. The prefix with length of 3 is <code>ABA</code>, and the <code>X</code> value during the construction of 4th column is <code>1</code>:</p>
<pre><code>← A B A
      A B A →
       (X)</code></pre><p>Apparently, value of <code>X</code> is the length that we can self-matched, as showed above. Say now we also have finished the 4th column, and the prefix length should be <code>4</code>. Then, it is necessary to update the value of <code>X</code>:</p>
<pre><code>   (new char added)
        ↓
← A B A B
      A B A B →
       (X)  ↑
          (new char added)</code></pre><p>A critical observation is, to determine the new value of <code>X</code> (or, say, the new length of self-matching), <strong><em>we only need to match the newly added char with the char on index of previous <code>X</code></em></strong>: <code>dfs[pat.charAt(j)][X]</code>!</p>
<p>We can use DFA to do this still because <code>X</code> is smaller than <code>j</code> and the DFA is partially completed!</p>
<p>You will find some interesting facts about <code>X</code>. For example, if <code>X</code> is incremented after one update, it could only be incremented by <code>1</code>; <code>X</code> might also be lower after one update (e.g., if the newly added char is <code>c</code> rather than <code>B</code>, <code>X</code> will become <code>0</code>).</p>
<p>Okay, take a deep breath! We have gone through everything about KMP now, and I believe (100%) that you are confident in writing the code by yourself.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KMP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[][] dfa;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KMP</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        dfa = <span class="keyword">new</span> <span class="keyword">int</span>[R][M];</span><br><span class="line">        dfa[pat.charAt(<span class="number">0</span>)][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>, X = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; R; c ++) &#123;</span><br><span class="line">                dfa[c][j] = dfa[c][X];</span><br><span class="line">            &#125;</span><br><span class="line">            dfa[pat.charAt(j)][j] = j + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update X</span></span><br><span class="line">            X = dfa[pat.charAt(j)][X];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, j;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length(), M = <span class="keyword">this</span>.pat.length();</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; N &amp;&amp; j &lt; M; i++) &#123;</span><br><span class="line">            j = dfa[txt.charAt(i)][j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i - M;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1D-Version-with-PMT"><a href="#1D-Version-with-PMT" class="headerlink" title="1D Version with PMT"></a>1D Version with PMT</h4><p>If you are a Chinese reader, you can also refer to <a href="https://www.zhihu.com/question/21923021/answer/281346746" target="_blank" rel="noopener">this post</a> for a new version which only uses a 1-D array. I will translate it into English later.</p>
<p>One hint I would give you is: though these two versions seem to differ a lot, they still share something (which plays a big role in KMP algorithm) in common. <strong><em>You will find that the the “PMT” mentioned in this version is exactly the restart state <code>X</code> is the 2D version!</em></strong></p>
<h4 id="Performance-1"><a href="#Performance-1" class="headerlink" title="Performance"></a>Performance</h4><p>For the second version, the time complexity is <code>O(M + N)</code> (<code>O(M)</code> for computing DFA and <code>O(N)</code> for search); if we do not ignore the alphabet size <code>R</code>, then it should be <code>O(RM + N)</code>.</p>
<h3 id="Boyer-Moore-Algorithm"><a href="#Boyer-Moore-Algorithm" class="headerlink" title="Boyer-Moore Algorithm"></a>Boyer-Moore Algorithm</h3><p>AS you can see, KMP algorithm is a method based on <em>left-to-right</em> compare. Here we want to introduce a new algorithm based on the <em>right-to-left</em> compare.</p>
<p>In this algorithm, we still have two pointers, <code>i</code> and <code>j</code>, for text string and pattern string respectively. Index<br><code>i</code> always points to the char in the text string that should be compared with the first char of the pattern string, <code>j</code> initially points to the last char of the pattern string and will be decremented if <code>pat.charAt(j) == txt.charAt(i+j)</code>.</p>
<p>In addition, we also implement an array <code>right[]</code> that gives fir each character in the alphabet, the index of its <em>rightmost occurrence</em> in the pattern (or <code>-1</code> if the character is not in the pattern). For example, if the string is <code>N E E D L E</code>:</p>
<pre><code> A  B  C  D  E ... L   M  N ...
-1 -1 -1  3  5 ... 4  -1  0 ...</code></pre><p>If there is a mismatch between <code>pat.charAt(j)</code> and <code>txt.charAt(i+j)</code>, we will have one of the following three cases:</p>
<ol>
<li>If the character causing the mismatch is not found in the pattern, we can slide the pattern <code>j+1</code> positions to the right;</li>
<li>If the character <code>c</code> causing the mismatch is found in the pattern ,we use the <code>right[]</code> array to line up the pattern with the text string so that character will match its rightmost occurrence in the pattern. To do so, we increment <code>i</code> by <code>j</code> minus <code>right[c]</code>.</li>
<li>If the computation would not increase <code>i</code>, i.e., not helping, we simply increment <code>i</code> by <code>1</code>, just like what we do in the brute-force algorithm.</li>
</ol>
<p>Now, the code below should be understandable and straightforward.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoyerMoore</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] right;</span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BoyerMoore</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        right = <span class="keyword">new</span> <span class="keyword">int</span>[R];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span> ; c &lt; R; c++) &#123;</span><br><span class="line">            right[c] = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">            right[pat.charAt(j)] = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length();</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> skip;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N - M; i += skip) &#123;</span><br><span class="line">            skip = <span class="number">0</span>;  <span class="comment">// the increment for i</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = M - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j --) &#123;</span><br><span class="line">                <span class="comment">// compare pat.charAt(i) and txt.charAt(i+j)</span></span><br><span class="line">                <span class="keyword">if</span> (pat.charAt(j) != txt.charAt(i+j)) &#123;</span><br><span class="line">                    skip = j - right[txt.charAt(i+j)];</span><br><span class="line">                    <span class="comment">// if value of `right` is -1, then skip = j + 1, which is the second case</span></span><br><span class="line">                    <span class="keyword">if</span> (skip &lt; <span class="number">1</span>) skip = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (skip == <span class="number">0</span>) <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Please note, this algorithm requires <em>backup in the input string</em>, i.e., we need to read previous chars again during the process. It enables us to exploit some features of right-to-left compares. In some applications where backup is not allowed, KMP would be a better candidate.</p>
<h3 id="Rabin-Karp-Algorithm"><a href="#Rabin-Karp-Algorithm" class="headerlink" title="Rabin-Karp Algorithm"></a>Rabin-Karp Algorithm</h3><p>Unlike the two algorithms above, this algorithm will use hashing. In fact, each string of length <code>M</code> corresponds to an <code>M</code>-digit base-<code>R</code> number, which means we can totally treat a string as a number. We could also implement a has function to convert an <code>M</code>-digit base-<code>R</code> number to an <code>int</code> value between 0 and <code>Q-1</code>, with the help of modular hashing.</p>
<p>A naive solution is based on the brute-force substring matching: we could simply compute the hash value for every possible substring with length <code>M</code> of the text string, and compare it with the hash value of pattern string. However, it is not efficient and shows no improvement over brute-force solution.</p>
<p>The Rabin-Karp algorithm shows an efficient way to get the new hash value after we move <code>i</code> to the right position by 1. It is easy to derive this logic with some simple maths work:</p>
<p>Using the notation $t_i$ for <code>txt.charAt(i)</code>, the number corresponding to the <code>M</code>-character substring of text string that starts at position <code>i</code> is</p>
<p>$$x_i = t_iR^{M-1} + t_{i+1}R^{M} + … + t_{i+M-1}R^0$$</p>
<p>and we can assume that we know the value of $h(x_i)=x_i$ mod Q. It is also easy to get that</p>
<p>$$x_{i+1} = (x_i - t_iR^{M-1})R+t_{i+M}$$</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabinKarp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> M;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> patHash;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> Q;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> RM;  <span class="comment">// R^(M - 1) % Q</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RabinKarp</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">this</span>.M = pat.length();</span><br><span class="line">        Q = <span class="number">997</span>; <span class="comment">// A prime number</span></span><br><span class="line">        RM = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= M - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            RM = (R * RM ) % Q;</span><br><span class="line">        &#125;</span><br><span class="line">        patHash = hash(pat, M);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">hash</span><span class="params">(String key, <span class="keyword">int</span> M)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> h = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; M ; j++) &#123;</span><br><span class="line">            h = (R * h + key.charAt(j)) % Q;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length();</span><br><span class="line">        <span class="keyword">long</span> txtHash = hash(txt, M); <span class="comment">// only get the hash value for the first M chars</span></span><br><span class="line">        <span class="keyword">if</span> (patHash == txtHash &amp;&amp; check(<span class="number">0</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = M ; i &lt; N; N++) &#123;</span><br><span class="line">            txtHash = (txtHash + Q - RM * txt.charAt(i-M) % Q) % Q;  </span><br><span class="line">            <span class="comment">// Adding Q to make sure we can always get the positive value</span></span><br><span class="line">            txtHash = (txtHash * R + txt.charAt(i)) % Q;</span><br><span class="line">            <span class="keyword">if</span> (patHash == txtHash &amp;&amp; check(i - M + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i - M + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You may notice that there is a function called <code>check()</code>. Why do we need this?</p>
<p>hashing is a good thing and we could exploit hashing for many applications, e.g., <code>HashMap</code> in Java. However, one main problem of hashing is that we may see hash conflict sometimes. Of course, we have the same problem in this case, as two different strings will get the same hash value. In order to resolve this issue, we can simply add an additional check when we see a hash value match, but we do not want to do that as it requires backup in the text string. Instead, we can choose a bigger value for <code>Q</code> to make the probability of hash conflict very small.</p>
<p>This algorithm is an early and famous example of <em>Monte Carlo</em> algorithm that has a guaranteed completion time but fails to output a correct answer with a small probability. The alternative method of checking for a match could be slow (it might amount to the brute-force algorithm, with a small probability) but is guaranteed correct, which is known as a <em>Las Vegas</em> algorithm.</p>
<p>Rabin-Karp substring search is known as a <em>fingerprint</em> search because it uses a small amount of information to represent a pattern.</p>
<h2 id="Regex"><a href="#Regex" class="headerlink" title="Regex"></a>Regex</h2><p>Substring search appears in many applications in real world, but we also need regular expressions to describe patterns and use this pattern to recognize some input string. In this section, we will implement algorithms for recognizing strings with regex.</p>
<p>If you have experience with regex in some programming languages, you may notice that there are many complicated rules in regex, but here we will not do all of them. Instead, we will only focus on three basic operations:</p>
<ol>
<li>Concatenation: when we write <code>AB</code>, we are specifying the language <code>{AB}</code>that has one two-character string, formed by concatenating <code>A</code> and <code>B</code>;</li>
<li>Or: specified by <code>|</code>. E.g., <code>A|B</code> specified the language <code>{A, B}</code>;</li>
<li>Closure: close allows parts of the pattern to be repeated arbitrarily. We denote closure by placing a <code>*</code> after<br>the pattern to be repeated.</li>
</ol>
<p>By convention, we also use parentheses to override the default precedence rules. All patterns will be enclosed in parentheses as well.</p>
<h3 id="NFA"><a href="#NFA" class="headerlink" title="NFA"></a>NFA</h3><p>Recall the KMP algorithm for substring search where DFA is exploited. Here we will also exploit this idea, though we might do something different.</p>
<p>We will build a <strong><em>nondeterministic finite-state automata</em></strong> (NFA) for a given regex string. Unlike DFA, the automata shows nondeterminism due to the nature of regex, as we are faced with more than one way to try to match the pattern.</p>
<p>For pattern string <code>((A*B|AC)D)</code>, the NFA is showed below:</p>
<p><img src="nfa.svg" alt="nfa_eg"></p>
<p>The rules for an NFA is listed below:</p>
<ol>
<li>The NFA corresponding to an regex of length <em>M</em> has exactly one state per pattern chars, starts at state 0, and has a (virtual) accept state <em>M</em>;</li>
<li>States corresponding to character from the alphabet have an outgoing edge that goes to the state corresponding to the next character in the pattern (black edges in the diagram);</li>
<li>States corresponding to the meta-chars <code>(</code>,<code>)</code>,<code>|</code>,<code>*</code> have at least one outgoing black edge (red edges in the diagram).</li>
<li>No state has more than one outgoing black edge.</li>
</ol>
<p>What are the the rules when we match the input string?</p>
<ol>
<li>If the current state corresponding to a char in the alphabet and the current char in the text string matched the char, the automation can scan past the char in the text string and take the black transition to the next state;</li>
<li>the automation can follow any red edge to another state without scanning any text char.</li>
</ol>
<p>We can use the rules to scan and recognize the input text string. As there might be multiple outgoing red edges for a state, we need to find all possible path to check the input text string.</p>
<h3 id="Simulating-an-NFA"><a href="#Simulating-an-NFA" class="headerlink" title="Simulating an NFA"></a>Simulating an NFA</h3><p>NFA is in similar to a directed graph and simulating an NFA is similar to DFS. We create the initial states by starting state <code>0</code> and going all the way to states pointed by read edge. In the example above, the initial state should be <code>0 1 2 3 4 6</code>; if the first char in text string is <code>A</code>, then we update the state set to <code>2 3 4 7</code>. We should keep doing this until all chars from text string are exhausted, and finally we check if the accept state is in the state set.</p>
<p><strong>Note</strong>: when building digraph, we will not include the black edges into the graph.</p>
<p>We then can write the code out immediately with the idea. The code use <code>Digraph</code> and <code>DirectedDFS</code> class and you may refer to their implementation in <a href="#Appendix">Appendix</a>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NFA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span>[] re;</span><br><span class="line">    <span class="keyword">private</span> Digraph G;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> M;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NFA</span><span class="params">(String regexp)</span> </span>&#123;</span><br><span class="line">        re = regexp.toCharArray();</span><br><span class="line">        M = regexp.length();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> construct the NFA</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">recognizes</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        Set&lt;Integer&gt; pc = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        DirectedDFS dfs = <span class="keyword">new</span> DirectedDFS(G, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; txt.length(); i++) &#123;</span><br><span class="line">            <span class="comment">// Compute possible NFA states for txt[i+1]</span></span><br><span class="line">            Set&lt;Integer&gt; match = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">                <span class="keyword">if</span> (v &lt; M) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (re[v] == txt.charAt(i) || re[v] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                        match.add(v+<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            dfs = <span class="keyword">new</span> DirectedDFS(G, match);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v == M) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Determining whether an N-character text string is recognized by the NFA corresponding to an M-character RE takes time proportional to <em>NM</em> in the worst case. However, we in fact need to know the number of edges in the directed graph. We will talk about it later.</p>
<h3 id="Building-an-NFA"><a href="#Building-an-NFA" class="headerlink" title="Building an NFA"></a>Building an NFA</h3><p>Now, the problem is how we can build an NFA given a pattern string. For different operations, we might need to exploit different rules.</p>
<p><strong><em>Concatenation</em></strong></p>
<p>This is the simplest one. We just mentioned that we do not include black edge into the graph, so we can just simply ignore the char if the char is in the alphabet.</p>
<p><strong><em>Parentheses</em></strong></p>
<p>We just push the RE index of each left parentheses on the stack, and pop the left one out of the stack if we see a right one. It could be tricker than you think, as we will also push the or operator <code>|</code> on the stack.</p>
<p><strong><em>Closure</em></strong></p>
<p>A closure (*) operator must occur either after a single character or after a right parenthesis. The picture below shows these two cases and what we should do regarding updating the graph.</p>
<p><img src="nfa_closure.svg" alt="nfa_closure"></p>
<p><strong><em>Or</em></strong></p>
<p>We only consider an RE of the form <code>(A|B)</code> where <code>A</code> and <code>B</code> are both REs. When we see <code>)</code>, we should find the index of <code>|</code> and <code>(</code> then add two edges to the graph, as showed in the picture below. Please note within a pair of parenthesis, there will only be one <code>|</code>; a form of RE like <code>(A|B|C)</code> is not supported here.</p>
<p><img src="nfa_or.svg" alt="nfa_or"></p>
<p>With all the rules above, we can implement the code for building an NFA.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NFA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span>[] re;</span><br><span class="line">    <span class="keyword">private</span> Digraph G;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> M;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NFA</span><span class="params">(String regexp)</span> </span>&#123;</span><br><span class="line">        re = regexp.toCharArray();</span><br><span class="line">        M = regexp.length();</span><br><span class="line">        G = <span class="keyword">new</span> Digraph(M+<span class="number">1</span>);  <span class="comment">// Remember to include the accept state</span></span><br><span class="line">        Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> lp = i;</span><br><span class="line">            <span class="keyword">if</span> (re[i] == <span class="string">'('</span> || re[i] == <span class="string">'|'</span>) &#123;</span><br><span class="line">                stack.push(i);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (re[i] == <span class="string">')'</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> or = stack.pop();</span><br><span class="line">                <span class="keyword">if</span> (re[or] == <span class="string">'|'</span>) &#123;</span><br><span class="line">                     lp = stack.pop();</span><br><span class="line">                     G.addEdge(lp, or+<span class="number">1</span>);</span><br><span class="line">                     G.addEdge(or, i);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    lp = or;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &lt; M - <span class="number">1</span> &amp;&amp; re[i+<span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line">                <span class="comment">// lp could be i (current index), or a left parenthesis.</span></span><br><span class="line">                <span class="comment">// It in fact handles the two cases for closure.</span></span><br><span class="line">                G.addEdge(lp, i+<span class="number">1</span>);</span><br><span class="line">                G.addEdge(i+<span class="number">1</span>, lp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (re[i] == <span class="string">'('</span> || re[i] == <span class="string">'*'</span> || re[i] == <span class="string">')'</span>) &#123;</span><br><span class="line">                G.addEdge(i, i+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">recognizes</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        Set&lt;Integer&gt; pc = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        DirectedDFS dfs = <span class="keyword">new</span> DirectedDFS(G, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; txt.length(); i++) &#123;</span><br><span class="line">            <span class="comment">// Compute possible NFA states for txt[i+1]</span></span><br><span class="line">            Set&lt;Integer&gt; match = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">                <span class="keyword">if</span> (v &lt; M) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (re[v] == txt.charAt(i) || re[v] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                        match.add(v+<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            dfs = <span class="keyword">new</span> DirectedDFS(G, match);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v == M) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Building the NFA corresponding to an M-character RE takes time ad space proportional to M in the worst case, as for each of the RE character in the regular expression, we add at most three transitions and perhaps execute one or two stack operations.</p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><h3 id="Directed-Graph-and-DFS"><a href="#Directed-Graph-and-DFS" class="headerlink" title="Directed Graph and DFS"></a>Directed Graph and DFS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Digraph</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> V;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> E;</span><br><span class="line">    <span class="keyword">private</span> Bag&lt;Integer&gt;[] adj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Digraph</span> <span class="params">(<span class="keyword">int</span> V)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.V = V;</span><br><span class="line">        <span class="keyword">this</span>.E = <span class="number">0</span>;</span><br><span class="line">        adj = (Bag&lt;Integer&gt;[])<span class="keyword">new</span> Bag[V];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; V; v++) &#123;</span><br><span class="line">            adj[v] = <span class="keyword">new</span> Bag&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">V</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> V;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">E</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> E;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">        adj[v].add(w); <span class="comment">// v -&gt; w</span></span><br><span class="line">        <span class="keyword">this</span>.E ++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Integer&gt; <span class="title">adj</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> adj[v];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Digraph <span class="title">reverse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Digraph R = <span class="keyword">new</span> Digraph(V);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; V; v++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> w: adj(v)) &#123;</span><br><span class="line">                R.addEdge(w, v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectedDFS</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>[] marked;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DirectedDFS</span><span class="params">(Digraph G, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        marked = <span class="keyword">new</span> <span class="keyword">boolean</span>[G.V()];</span><br><span class="line">        dfs(G, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DirectedDFS</span><span class="params">(Digraph G, Iterable&lt;Integer&gt; sources)</span> </span>&#123;</span><br><span class="line">        marked = <span class="keyword">new</span> <span class="keyword">boolean</span>[G.V()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> s: sources) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!marked[s]) dfs(G, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(Digraph G, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        marked[v] = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> w: G.adj(v)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!marked[w]) dfs(G, w);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">marked</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> marked[v];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/17/java3/">A Java programmer? Try these puzzles! (Part 3/3)</a>
            <span class="archive-item-date">Apr 17, 2020</span>
            <!-- <span style=> <p>Let’s continue our puzzlers!</p>
<h2 id="Classier-Puzzlers"><a href="#Classier-Puzzlers" class="headerlink" title="Classier Puzzlers"></a>Classier Puzzlers</h2><p>Puzzlers in this chapter will concern inheritance, overriding, and other forms of name reuse.</p>
<h3 id="A-Private-Matter"><a href="#A-Private-Matter" class="headerlink" title="A Private Matter"></a>A Private Matter</h3><p>In this program, a subclass filed has the same name as a superclass field. What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String className = <span class="string">"Base"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String className = <span class="string">"Derived"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrivateMatter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Derived().className);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are two possible behavior you may expect from this program:</p>
<ol>
<li>it should print <code>Base</code> as overriding may not take effect;</li>
<li>it does not compile, because the variable className in Derived has more restrictive access than it does in <code>Base</code>.</li>
</ol>
<p>If you run this program, you will find it does not compile, but the program is with <code>PrivateMatter</code>. Had <code>className</code> been an instance method instead of an instance filed, <code>Derived.className()</code> would have <em>overridden</em> <code>Base.className()</code>, and the program would have been illegal. The access modifier of an overriding method must provide at least as much access as that of the overridden method. Because <code>classname</code> is a field, <code>Derived.className</code> <em>hides</em> <code>Base.className</code> rather than overriding it. It is legal, though inadvisable.</p>
<p>In fact, hiding always cause confusion. A class that hides a field with one whose accessibility is more restrictive than that of the hidden field, as in out original program, violates the principle of <em>subsumption</em>, also known as <em>Liskov Substitution Principle</em>. This principle, generally speaking, says that everything you can do with a base class, you can also do with a derived class. This is an integral part of the natural mental model of object-oriented programming. The program will become very difficult to understand if it is violated. This principle is also violated when hiding one filed with another and:</p>
<ul>
<li>if the two field are of different types;</li>
<li>if one field is static and the other isn’t;</li>
<li>if one field is final and the other isn’t;</li>
<li>if one filed is constant and the other isn’t;</li>
<li>of both are constant and have different values.</li>
</ul>
<h3 id="All-Strung-Out"><a href="#All-Strung-Out" class="headerlink" title="All Strung Out"></a>All Strung Out</h3><p>Try to run the program below with the Java command or your favorite IDE. <strong>Don’t just read it and guess what is the output</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StrungOut</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s = <span class="keyword">new</span> String(<span class="string">"Hello world!"</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> java.lang.String s;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(java.lang.String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.s = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This program looks simple. It acts like a wrapper for <code>String</code>. However, if you try to run this code from an IDE (such as IntelliJ), it will not allow you to run it; if you run with java command, if will give you an exception:</p>
<pre><code>Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: main</code></pre><p>It seems strange, because we indeed have a main method in class <code>StrungOut</code>. Why can’t the VM find it?</p>
<p>Although <code>StrungOut</code> has a method named “main”, it has the wrong signature. A <code>main</code> method must accept a single argument that is an array of strings. What the VM is struggling to tell us is that <code>StrungOut.main</code> accepts an arrays of <em>our</em> <code>String</code> class, which has nothing whatsoever to do with <code>java.lang.String</code>.</p>
<p>Remember: <strong><em>avoid reusing the names of platform classes, and never reuse class names from java.lang</em></strong>.</p>
<h3 id="Shades-of-Gray"><a href="#Shades-of-Gray" class="headerlink" title="Shades of Gray"></a>Shades of Gray</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShadesOfGray</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(X.Y.Z);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Y</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> String Z = <span class="string">"BLACK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> C Y = <span class="keyword">new</span> C();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    String Z = <span class="string">"WHITE"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There is no abvious way to decide whether this program should print <code>BLACK</code> or <code>WHITE</code>. Normally, our compiler would reject ambiguous programs, but this one is legal and you can see the result is <code>WHITE</code>.</p>
<p>The class <code>X</code> has a type <code>Y</code> and a variable <code>Y</code>. When a variable and a type have the same name and both are in scope, the compiler will not return any errors. Instead, the variable name will take precedence. The variable name is said to <em>obsure</em> the type name. Similarly, variable and type names can obscure package names.</p>
<p>This seems to be a trivial problem, but in a big class we might make this mistake as there might be many variables and types within the class. However, <strong>if you are strictly following standard Java naming conventions, you almost will never encounter this issue</strong>. This is apparent as differnet entities in Java will have their own ways to do naming. Remember: always follow a standardized naming convention!</p>
<h3 id="Package-Deal"><a href="#Package-Deal" class="headerlink" title="Package Deal"></a>Package Deal</h3><p>This program involves the interaction of two classes in different packages. What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hack;</span><br><span class="line"><span class="keyword">import</span> click.CodeTalk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeIt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClickIt</span> <span class="keyword">extends</span> <span class="title">CodeTalk</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Hack"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ClickIt clickit = <span class="keyword">new</span> ClickIt();</span><br><span class="line">        clickit.doIt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> click;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeTalk</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doIt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        printMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Click"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you run this program, you will find the output is <code>Click</code>. In fact, <strong><em>a package-private method cannot be directly overridden by a method in a different package</em></strong>. The two <code>printMessage</code> methods in this program are unrelated; they merely have the same name. The purpose of this rule for Java is to enable packages to support encapsulation of abstractions larger than a single class.</p>
<p>If you want the <code>printMessage</code> method in <code>hack.TypeIt.ClickIt</code> to override the method in <code>click.CodeTalk</code>, you must add the <code>protected</code> or <code>public</code> modifier to the method declaration in <code>click.CodeTalk</code>. To make the program compile, you must also add a modifier to the overriding declaration in <code>hack.TypeIt.ClickIt</code>. The modifier must be no more restrictive than the one you placed in the declaration for <code>printMessage</code> in <code>hack.TypeIt.ClickIt</code>.</p>
<h3 id="Import-Duty"><a href="#Import-Duty" class="headerlink" title="Import Duty"></a>Import Duty</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Arrays.toString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportDuty</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        printArgs(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printArgs</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">        System.out.println(toString(args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, this program does not compile. What is the problem? Is it because the compiler cannot find the function <code>toString</code>?</p>
<p>If you write this program in an IDE, probably the IDE will tell you what is the result: “Non-static method <code>toString</code> cannot be referenced from a static context”. The function <code>toString</code> we used in function <code>printArgs</code> is in fact the member method of class <code>ImportDuty</code> (inherit this method from class <code>Object</code>).</p>
<p><strong><em>Members that are naturally in scope take precedence over static imports</em></strong>. Remember: static import facility cannot be used effectively on a method if its name is already in scope.</p>
<h2 id="Library-Puzzlers"><a href="#Library-Puzzlers" class="headerlink" title="Library Puzzlers"></a>Library Puzzlers</h2><h3 id="Rudely-Interrupted"><a href="#Rudely-Interrupted" class="headerlink" title="Rudely Interrupted"></a>Rudely Interrupted</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfInterruption</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Interrupted: "</span> + Thread.interrupted());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Not interrupted: "</span> +  Thread.interrupted());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The program first interrupts itself, then prints out the status of the thread. So you might expect the output to be <code>Interrupted: true</code>. However, it prints out <code>Interrupted: false</code>.</p>
<p>What really happened was that the fist invocation of <code>Thread.inyerrupted</code> returned <code>true</code> and cleared the interrupted status of the thread, so the second invocation will return <code>false</code>. <strong>Calling <code>Thread.interrupted</code> always clears the interrupted status of the current thread.</strong> The method name gives no hints of this behavior and the documentation is also misleading. Instead, if you do not want to clear the state and only want to query the status, please use the one instance method of <code>Thread</code>: <code>isInterrupted</code>. This one will not clear the interrupted status of the thread.</p>
<p>The lesson for API designer is that methods should have names that describe their primamry functions. In this case, a better name for this static method could be <code>interruptedAndClear</code>. When the name cannot fully indicate the behavior of an API, please well document it.</p>
<h3 id="Lazy-Initialization"><a href="#Lazy-Initialization" class="headerlink" title="Lazy Initialization"></a>Lazy Initialization</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lazy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                initialized = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(initialized);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apparently, the result should be <code>true</code>, right? However, if you run this program, it will not print out anything; it just hangs there.</p>
<p>When a thread is about to access a member of a class, it has to check if the class has been initialized. Ignoring serious errors, there are four possible cases:</p>
<ol>
<li>The class is not yet initilized;</li>
<li>The class is being initilized by the current thread: a recursive request for initialization;</li>
<li>The class is being initialized by some thread other than the current thread;</li>
<li>The class is already initialized.</li>
</ol>
<p>In the main thread, <code>Lazy.main</code> checks whether the class <code>Lazy</code> has been initialized. It hasn’t (case 1), so it begins to initialize it: set <code>initialized</code> to <code>false</code>, create and start a background thread whose <code>run</code> method sets <code>initilized</code> to <code>true</code>, and wait for it to complete.</p>
<p>In the <code>run</code> method, as it is accessing the static member variable <code>initialized</code>, it will also check if the class has been initialized, and find that it is being initialized by another thread (which is the main thread, case 3). <strong>The current thread, which is the background thread, will waits on the <code>Class</code> object until initialization is complete</strong>. On the other hand, the main thread is also waiting for the background thread to complete (<code>t.join()</code>). Thus, this program generates a deadlock.</p>
<p>This bug is pretty subtle. To fix this, the best way is alwasy to <strong>avoid start any background threads during class initialization</strong>. More generally, keep class initialization as simple as possible.</p>
<h2 id="Advanced-Puzzlers"><a href="#Advanced-Puzzlers" class="headerlink" title="Advanced Puzzlers"></a>Advanced Puzzlers</h2><h3 id="Raw-Deal"><a href="#Raw-Deal" class="headerlink" title="Raw Deal"></a>Raw Deal</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T first;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T second;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(T first, T second)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.first = first;</span><br><span class="line">        <span class="keyword">this</span>.second = second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">first</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">second</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">stringList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(String.valueOf(first), String.valueOf(second));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Pair p = <span class="keyword">new</span> Pair&lt;Object&gt;(<span class="number">23</span>, <span class="string">"skipoo"</span>);</span><br><span class="line">        System.out.println(p.first() + <span class="string">" "</span> + p.second());</span><br><span class="line">        <span class="keyword">for</span> (String s: p.stringList()) &#123;</span><br><span class="line">            System.out.println(s + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The result seems really apparent and it should be <code>23 skipoo</code>, right? However, you cannot compile the program.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Pair.java:26: incompatible types;</span><br><span class="line">found: Object, required: String</span><br><span class="line">        for (String s: p.stringList())</span><br></pre></td></tr></table></figure>
<p> This is quite surprising, as the returned type of the function <code>stringList()</code> is indeed list of string, right? What is the problem here?</p>
<p> This rather countertuitive behavior is caused by the program’s use of <em>raw</em> types. A raw type is simply the name of a generic cass or interface without any type parameters. For example, <code>List&lt;E&gt;</code> is a generic interface, <code>List&lt;String&gt;</code> is a parameterized type, and <code>List</code> is a raw type. In the program above, variable <code>p</code> is also a raw type.</p>
<p> What happens if <code>p</code> is declared as a raw type? A raw type is like its parameterized counterpart, but all its instance members are replaced by their <em>erased</em> counterparts. <strong>In particular, each parameterized types appearing in an instance will be replaced with its raw counterpart</strong>. Thus, for <code>stringList()</code> method, the compiler interprets the program as if this method returned the raw type <code>List</code>. While <code>List&lt;String&gt;</code> implements the parameterized type <code>Interable&lt;String&gt;</code>, <code>List</code> implements the raw type <code>Iterable</code>. Where <code>Interable&lt;String&gt;</code> has an <code>iterator</code> method that returns the parameterized type <code>Iterator&lt;String&gt;</code>, <code>Iterable</code> has an <code>Iterator</code> method taht returns the raw type <code>Iterator</code>. Similar for all subsequent methods in <code>Iterator</code>. Therefor, iterating over <code>p.stringList()</code> requires a loop bariable of type <code>Object</code>, which explains the compiler’s bizarre error message.</p>
<p> To fix the problem, you can change the type of the loop varible from <code>String</code> to <code>Object</code>. However, it loses all the benefits of generics, and the program wouldn’t even compile if the loop invoked any <code>String</code> methods on <code>s</code>. The right way to fix it is still to avoid raw type for <code>p</code> by declaring it as <code>Pair&lt;Object&gt;</code>.</p>
<p> The key point here is: <strong>the raw type <code>List</code> is not the same as the parameterized type <code>List&lt;Object&gt;</code></strong>. If the raw type used, the compiler has no idea whether there are nay restrictions on the type of the elements permitted by the list, but it lets you insert elements of any type. <em>This is not typesafe</em>.</p>
<p> There is a third type that is closely related to these two: <code>List&lt;?&gt; is a special kind of parameterized type known as a *wildcard* type</code>. This is a parameterized type. The language requires stronger type-checking.</p>
<p> Raw types are in fact a concession to exsiting code, which could not use generics prior to release 5.0. The real problam for the “Pair” program is that the author did not decide what version of Java to use. You should always <strong>avoid writing raw types in code indended for release 5.0 or later</strong></p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/13/java2/">A Java programmer? Try these puzzles! (Part 2/3)</a>
            <span class="archive-item-date">Apr 13, 2020</span>
            <!-- <span style=> <p>Let’s continue our puzzlers!</p>
<h2 id="Classy-Puzzlers"><a href="#Classy-Puzzlers" class="headerlink" title="Classy Puzzlers"></a>Classy Puzzlers</h2><h3 id="The-Case-of-the-Confusing-Constructor"><a href="#The-Case-of-the-Confusing-Constructor" class="headerlink" title="The Case of the Confusing Constructor"></a>The Case of the Confusing Constructor</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Confusing</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Confusing</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Object"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Confusing</span><span class="params">(<span class="keyword">double</span>[] dArray)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"double array"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Confusing(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apparently, this is a question on overloading. Which method is called by <code>main</code> method? The answer is the second one: <code>Confusing(double[])</code>.</p>
<p>There are two phases in Java’s overload resolution process:</p>
<ol>
<li>selects all the methods or constructors that are accessible and applicable;</li>
<li>selects the <em>most specific</em> of the methods or constructors selected in the first phase.</li>
</ol>
<p>In our program, both constructors are applicable and accessible, but <code>Confusing(Object)</code> is less specific as accepts any parameter passed to <code>Confusing(Object)</code>. The key to understanding this puzzle is that the test for which method or constructors is most specific does not use the <em>actual parameters</em>: the parameters appearing in the invocation (e.g., null in this case).</p>
<p>This puzzle should indicate some advices for you when you are writing some APIs: ensure your clients aren’t forced to go to these extreme fashions of selecting among overloadings. Ideally, you should <strong><em>avoid</em></strong> overloading: use different names for different methods, which, however, it is not possible sometimes. For example, constructors don’t have names, but you could make constructors private and providing public static libraries. If constructors have too many parameters, consider builder pattern.</p>
<p>If you really have to do overload, make sure that all overloading accept mutually incompatible parameter types, <strong><em>so that no two are applicable at the same time</em></strong>.</p>
<h3 id="Well-Dog-My-Cats"><a href="#Well-Dog-My-Cats" class="headerlink" title="Well, Dog My Cats!"></a>Well, Dog My Cats!</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123; count ++; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> count; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">woof</span><span class="params">()</span> </span>&#123; increment(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">meow</span><span class="params">()</span> </span>&#123; increment(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ruckus</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Dog[] dogs = &#123; <span class="keyword">new</span> Dog(), <span class="keyword">new</span> Dog() &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dogs.length; i++) &#123;</span><br><span class="line">            dogs[i].woof();</span><br><span class="line">        &#125;</span><br><span class="line">        Cat[] cats = &#123;<span class="keyword">new</span> Cat(), <span class="keyword">new</span> Cat(), <span class="keyword">new</span> Cat()&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cats.length; i++) &#123;</span><br><span class="line">            cats[i].meow();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(Dog.getCount() + <span class="string">" woofs "</span>);</span><br><span class="line">        System.out.println(Cat.getCount() + <span class="string">" meows"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A naive guess is <code>2 woofs 3 meows</code>. However, it turns out to be <code>5 woofs 5 meows</code>. It is not easy to get the reason: a single copy of each static field is shared among its declaring class and all subclasses. So <code>Dog</code> and <code>Cat</code> use the same <code>count</code> field.</p>
<p>To avoid this problem, we must correct a fundamental design error. When designing one class to build on the behavior of another, you have two options: <em>inheritance</em> (one class extends the other) and <em>composition</em> (one class contains an instance of the other). Apparently, composition is preferable in this case.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Counter counter = <span class="keyword">new</span> Counter();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">woofCount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> counter.getCount();&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">woof</span><span class="params">()</span> </span>&#123;counter.increment();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you are familiar with design patterns and principles in Java, you will aware that composition uses delegation to assign tasks and reduce coupling. You can refer to <em>Effective Java</em> for more information.</p>
<h3 id="All-I-Get-Is-Static"><a href="#All-I-Get-Is-Static" class="headerlink" title="All I Get Is Static"></a>All I Get Is Static</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Woof "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Basenji</span> <span class="keyword">extends</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bark</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bark</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Dog woofer = <span class="keyword">new</span> Dog();</span><br><span class="line">        Dog nipper = <span class="keyword">new</span> Basenji();</span><br><span class="line">        woofer.bark();</span><br><span class="line">        nipper.bark();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Both <code>woofer</code> and <code>nipper</code> are declared with <code>Dog</code>, but <code>nipper</code> is initializer with <code>Basenji</code> constructor. The method <code>bark</code> is <code>Basenji</code> is defined to do nothing. So <code>nipper.bark()</code> will print nothing. Is this true?</p>
<p>No. You will see two <code>Woof</code> on the screen.</p>
<p>The problem is that <code>bark</code> is a static method, and <strong>there is no dynamic dispatch on static methods</strong>. When a program calls a static method, the method to be invoked is selected at compile time, based on the compile-time type of the qualifier, which is the name we give to the part of the method invocation expression to the left of the dot. In this program, both <code>woofer</code> and <code>nipper</code> are declared to be of type <code>Dog</code> and they have to same compile-time type, the compiler causes the same method to be invoked: <code>Dog.bark</code>. It does not matter that the runtime type of <code>nipper</code> is <code>Basenji</code>; only compile-time type is considered.</p>
<p>When you  invoke a static method, you typically qualify it with a class rather an expression.</p>
<pre><code>Dog.bark();
Basenji.bark();</code></pre><p>In fact, this is what Java recommends to do. Remember: <strong><em>static methods cannot be overridden</em></strong>.</p>
<h3 id="Larger-Than-Life"><a href="#Larger-Than-Life" class="headerlink" title="Larger Than Life"></a>Larger Than Life</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Elvis</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Elvis INSTANCE = <span class="keyword">new</span> Elvis();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beltSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CURRENT_YEAR =</span><br><span class="line">        Calendar.getInstance().get(Calendar.YEAR);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Elvis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        beltSize = CURRENT_YEAR - <span class="number">1930</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBeltSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.beltSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            <span class="string">"Elvis wears a size "</span> + INSTANCE.getBeltSize() + <span class="string">" belt."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The program will return you <code>Elvis wears a size -1930 belt.</code>. It seems that <code>INSTANCE.getBeltSize()</code> will return <code>0</code>.</p>
<p>If you still have some memory of the puzzler “The Reluctant Constructor”, you might have some idea of what is really happening. However, <code>INSTANCE</code> here is a static variable and it may not cause <code>StackOverFlowError</code>. But the reason is similar: we have to dive deep into order of <em>class</em> initialization.</p>
<p>Initialization of <code>Elvis</code> is triggered by the VM’s call to its <code>main</code> method. First, static field are set to their default values. The field <code>INSTANCE</code> is set to <code>null</code>, and <code>CURRENT_YEAR</code> is set to 0. Next, static field initializers are executed in order of appearance. The first static field is <code>INSTANCE</code>. Its value is computed by invoking the <code>Elvis()</code> constructor.</p>
<p>The constructor initializes <code>beltSize</code> to an expression involving the static field <code>CURRENT_YEAR</code>. Normally, reading a static field is one of the things that causes a class to be initialized, but we are already initializing the class <code>Elvis</code>. Recursive initialization attempts are simply ignored. Consequently, the value of <code>CURRENT_VALUE</code> still has its default value of 0. That is why Elvis’s belt size if <code>-1930</code>. Though <code>CURRENT_YEAR</code> will be initialized to <code>2020</code> (current year), it is too late for the now correct value of this field to affect the computation of <code>Elvis.INSTANCE.beltSize</code>.</p>
<p>This puzzle shows that <strong><em>it is possible to observer a final static field before it is initialized.</em></strong> You should always be careful of the initialization cycles.</p>
<h3 id="What’s-the-Point"><a href="#What’s-the-Point" class="headerlink" title="What’s the Point?"></a>What’s the Point?</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> x, y;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    Point(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">        name = makeName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span> + x + <span class="string">","</span> + y + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorPoint</span> <span class="keyword">extends</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String color;</span><br><span class="line"></span><br><span class="line">    ColorPoint(<span class="keyword">int</span> x, <span class="keyword">int</span> y, String color) &#123;</span><br><span class="line">        <span class="keyword">super</span>(x, y);</span><br><span class="line">        <span class="keyword">this</span>.color = color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.makeName() + <span class="string">":"</span> + color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> ColorPoint(<span class="number">4</span>, <span class="number">2</span>, <span class="string">"red"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is not hard to spot the bug in the program, but I believe many programmers might not notice this bug. The result returned by this program is <code>[4,2]:null</code>.</p>
<p>If you are not aware of the issue, let’s mark the order of instance initialization.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> x, y;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    Point(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">        name = makeName();  <span class="comment">// 3. Invoke subclass method</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span> + x + <span class="string">","</span> + y + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorPoint</span> <span class="keyword">extends</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String color;</span><br><span class="line"></span><br><span class="line">    ColorPoint(<span class="keyword">int</span> x, <span class="keyword">int</span> y, String color) &#123;</span><br><span class="line">        <span class="keyword">super</span>(x, y);  <span class="comment">// 2. Chain to Point constructor</span></span><br><span class="line">        <span class="keyword">this</span>.color = color;  <span class="comment">// 5. Initialization blank final-Too late</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  4. Executes before subclass constructor body!</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.makeName() + <span class="string">":"</span> + color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  1. Invoke subclass constructor</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> ColorPoint(<span class="number">4</span>, <span class="number">2</span>, <span class="string">"red"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apparently, the bug is because we use the value of variable <code>color</code> before it is initialized. So, always remember that <strong><em>it is possible to observe the value of a final instance field before its value has been assigned</em></strong>.</p>
<p>In fact, this problem arises whenever a constructor calls a method that has been over-ridden in its subclass. A method invoked in this way always runs before the instance has been initialized, when its declared fields still have their default values. To avoid this problem, <strong>never call overridable methods from constructors</strong>.</p>
<h3 id="Sum-Fun"><a href="#Sum-Fun" class="headerlink" title="Sum Fun"></a>Sum Fun</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        initializeIfNecessary();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> sum;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initializeIfNecessary();</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initializeIfNecessary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">                sum += i;</span><br><span class="line">            initialized = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Cache.getSum());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems that the author of this program apparently went to a lot of trouble to make sure that <code>sum</code> was initialized before use, and expected <code>Cache.sum</code> to be <code>4950</code>. However, the program tells you the sum is <code>9900</code>, fully twice the expected value.</p>
<p>Obviously, the problem is because of the class initialization. Let’s go through the whole process.</p>
<p>Before it can invoke <code>Client.main</code>, the VM must initialize the class <code>Client</code>. The <code>Client.main</code> method invokes <code>Cache.getSum</code>. Before the <code>getSum</code> method can be executed, the VM must initialize the class <code>Cache</code>.</p>
<p>Do you still remember the order of static initializers? It follows the order they appear in the source. The <code>Cache</code> class has two static initializers: the <code>static</code> block at the top of the class and the initializing of the static field <code>initialized</code>. The first one will be executed first, adding 4950 to <code>sum</code> (default value of <code>sum</code> is <code>0</code>) and setting <code>initialized</code> to <code>true</code>.</p>
<p>The second initializer will com later. <strong>The static initializer for the <code>initialized</code> field sets it back to <code>false</code></strong>, completing the class initialization of <code>Cache</code>. Thus, when calling <code>Cache.getSum()</code>, <code>sum</code> will be added with 4950 again.</p>
<p>From the program, it infers that the programmer did not think about the order in which the initialization of the <code>Cache</code> class would take place, and was unable to decide between eager and lazy initialization. The author used both eager (<code>initializeIfNecessary()</code> in static block) and lazy initialization (<code>initializeIfNecessary()</code> in <code>getSum()</code>). Remember: <strong><em>use either eager initialization or lazy initialization, never both</em></strong>.</p>
<p>Instead, the code below is a better version for <code>Cache</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> sum = computeSum();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">computeSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100l</span> i++)</span><br><span class="line">            result += i;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A goof lesson (which we mentioned previously): if you want to compute a value for a static field, you’d better write a static function to do it.</p>
<h3 id="Creationism"><a href="#Creationism" class="headerlink" title="Creationism"></a>Creationism</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Creator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">            Creature creature = <span class="keyword">new</span> Creature();</span><br><span class="line">        System.out.println(Creature.getNum());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Creature</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Creature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        num ++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Pretty trick, right? If you try to write this program on your favorite IDE, you will find that this program does not compile. My IDE will tell me “Declaration not allowed here” at line 5.</p>
<p>I would say this puzzle is the most impressive and surprising one. Please notice that, line 5 is <em>a local variable declaration statement</em>. The syntax of the language does not allow a local variable declaration statement as the statement repeated by a <code>for</code>, <code>while</code>, or <code>do</code> loop. <strong><em>A local variable declaration can appear only as a statement directly within a block</em></strong>. (A block is a pair of curly braces and the statements and declaration contained within it.)</p>
<p>There are two ways to fix it:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    Creature creature = <span class="keyword">new</span> Creature();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">    <span class="keyword">new</span> Creature();</span><br></pre></td></tr></table></figure>

<h2 id="Library-Puzzlers"><a href="#Library-Puzzlers" class="headerlink" title="Library Puzzlers"></a>Library Puzzlers</h2><h3 id="The-Dating-Game"><a href="#The-Dating-Game" class="headerlink" title="The Dating Game"></a>The Dating Game</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatingGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Calendar cal = Calendar.getInstance();</span><br><span class="line">        cal.set(<span class="number">1999</span>, <span class="number">12</span>, <span class="number">31</span>);</span><br><span class="line">        System.out.println(cal.get(Calendar.YEAR) + <span class="string">" "</span>);</span><br><span class="line"></span><br><span class="line">        Date d = cal.getTime();</span><br><span class="line">        System.out.println(d.getDay());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems that the program should print <code>1999 31</code>. However, it prints <code>2000 1</code>. What is happening here?</p>
<p>Our program illustrates a few of the problems with the <code>Date</code> and <code>Calendar</code> API. The program’s first bug is in the method invocation <code>cal.set(1999, 12, 31)</code>. <strong><code>Date</code> represents January as 0, and <code>Calendar</code> perpetuates this mistake</strong>. Therefore, this method invocation sets the calendar to the thirty-first day of the thirteenth month of 1999. But the standard (Gregorian) calendar has only 12 months; surely this method invocation should cause an <code>IllegalArgumentException</code>? <strong>It should, but it doesn’t</strong>. The <code>Calendar</code> class silently substitutes the first month of the next year, in this case, 2000. This explains the first number printed by  our program (<code>2000</code>).</p>
<p>Another bug is: <strong><code>Date.getDay</code> returns the day of the week represented by the <code>Date</code> instance, not the day of the month</strong>. The returned value is 0-based, starting at Sunday.</p>
<p>A good thing is some of these confusing methods are deprecated already, and you should avoid using these methods. In addition, be careful when using <code>Calendar</code> or <code>Date</code> (or even other classes); always consult the API documentation.</p>
<h3 id="The-Mod-Squad"><a href="#The-Mod-Squad" class="headerlink" title="The Mod Squad"></a>The Mod Squad</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mod</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> MODULUS = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span>[] histogram = <span class="keyword">new</span> <span class="keyword">int</span>[MODULUS];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            histogram[Math.abs(i) % MODULUS] ++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (i ++ != Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; MODULUS; j++) &#123;</span><br><span class="line">            System.out.println(histogram[j] + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We expect to see number from each entry of <code>histogram</code> is roughly equal. However, if you run this code. You will get:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.ArrayIndexOutOfBoundsException: Index -2 out of bounds for length 3</span><br><span class="line">	at src.Mod.main(Mod.java:8)</span><br></pre></td></tr></table></figure>

<p>So <code>Math.abs(i)</code> returns a negative value? Let’s go to the documentation for <code>Math.abs</code>. The method is supposed to always return non-negative value, but in one case, it does not. The documentation says: if the argument is equal to the value of <code>Integer.MIN_VALUE</code>, the result is that same value, which is negative.</p>
<p>Please remember that <code>Math.abs()</code> is not guaranteed to return a non-negative value.</p>
<h3 id="A-strange-Saga-of-a-Suspicious-sort"><a href="#A-strange-Saga-of-a-Suspicious-sort" class="headerlink" title="A strange Saga of a Suspicious sort"></a>A strange Saga of a Suspicious sort</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuspiciousSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">        Integer[] arr = <span class="keyword">new</span> Integer[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">            arr[i] = rnd.nextInt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Comparator&lt;Integer&gt; cmp = <span class="keyword">new</span> Comparator&lt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer i1, Integer i2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i2 - i1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Arrays.sort(arr, cmp);</span><br><span class="line">        System.out.println(order(arr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> Order &#123;ASCENDING, DESCENDING, CONSTANT, UNORDERED&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Order <span class="title">order</span><span class="params">(Integer[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> ascending = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> descending = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">            ascending |= (a[i] &gt; a[i-<span class="number">1</span>]);</span><br><span class="line">            descending |= (a[i] &lt; a[i-<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ascending &amp;&amp; !descending)</span><br><span class="line">            <span class="keyword">return</span> Order.ASCENDING;</span><br><span class="line">        <span class="keyword">if</span> (descending &amp;&amp; ! ascending)</span><br><span class="line">            <span class="keyword">return</span> Order.DESCENDING;</span><br><span class="line">        <span class="keyword">if</span> (!ascending)</span><br><span class="line">            <span class="keyword">return</span> Order.CONSTANT;</span><br><span class="line">        <span class="keyword">return</span> Order.UNORDERED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this program, we try to sort a random generated array with a self-defined comparator. Then, we use a static method <code>order</code> to determine the type of the order. From the code, the comparator is supposed to sort the array in descending order. However, if you run this code, you will find that the program will print <code>UNORDERED</code>. What happens here?</p>
<p>There is a problem in the comparator. Seemingly this idiom always makes sense: if you have two numbers and you want a value whose sign indicates their order, compute their difference. However, the problem with this idiom is that a fixed-width integer is not big enough to hold the difference of two arbitrary integers of the same width. When you subtract two <code>int</code> or <code>long</code> values, the result can overflow, in which case it will have the wrong sign. Try the program below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverFlow</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> x = -<span class="number">2000000000</span>;</span><br><span class="line">		<span class="keyword">int</span> z = <span class="number">2000000000</span>;</span><br><span class="line">		System.out.println(x - z);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Thus, subtracting two values to compare them might not be a good choice.</p>
<br>

<p>———— END OF THIS POST ————</p>
<p>If you want to read more puzzlers, please go to <a href="/2020/04/17/java3/">this</a> page!</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/05/java/">A Java programmer? Try these puzzles! (Part 1/3)</a>
            <span class="archive-item-date">Apr 5, 2020</span>
            <!-- <span style=> <p><img src="book.jpg" alt="book"></p>
<br>

<p>If you are a Java programmer, <strong><em>I highly recommend reading this book: Java Puzzler</em></strong>, by <em>Joshua Bloch</em> and <em>Neal Gafter</em>. This book will introduce many common traps, pitfalls and corner cases that you are highly likely to meet when programming with Java.</p>
<p>This post is intended to summarize the most interesting and critical pitfalls recorded in this book. Trust me, you will be highly surprised by some of them.<br><br></p>
<p><img src="pitfall.gif" alt="gif"></p>
<br>
This post will keep updating. Welcome to revisit!

<h2 id="Expressive-Puzzlers"><a href="#Expressive-Puzzlers" class="headerlink" title="Expressive Puzzlers"></a>Expressive Puzzlers</h2><h3 id="The-Joy-of-Hex"><a href="#The-Joy-of-Hex" class="headerlink" title="The Joy of Hex"></a>The Joy of Hex</h3><p>What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoyOfHex</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Long.toHexString(<span class="number">0x100000000L</span> + <span class="number">0xcafebabe</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The most intuitive answer would be <code>1cafebabe</code>, right? However, if you run this program, it is in fact <code>cafebabe</code>.</p>
<p>A very subtle feature for decimal literal is: <strong><em>decimal literals are all positive</em></strong>. This feature is not shared by hexadecimal or octal literals. To write a negative decimal literal, we always use a minus sign <code>-</code> in combination with a decimal literal. Thus, negative decimal constants are clearly identifiable by the presence of the minus sign. <strong><em>Hex and octal literals are negative if their high-order bit is <code>1</code></em></strong>.</p>
<p>In this program, the number <code>0xcafebabe</code> is an <code>int</code> constant with its high-order bit set, so it is negative. The addition performed by the program is a mixed-type computation: the left operand is of type <code>long</code>. Java will promote the <code>int</code> value to a <code>long</code> value with a <em>widening primitive conversion</em>.</p>
<p>Final computation will be: <code>0xffffffffcafebabeL + 0x0000000100000000L = 0x00000000cafebabeL</code></p>
<h3 id="Swap-Meat"><a href="#Swap-Meat" class="headerlink" title="Swap Meat"></a>Swap Meat</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CleverSwap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">1984</span>;  <span class="comment">//(0x7c0)</span></span><br><span class="line">        <span class="keyword">int</span> y = <span class="number">2001</span>;  <span class="comment">//(0x7d1)</span></span><br><span class="line">        x ^= y ^= x ^= y;</span><br><span class="line">        System.out.println(<span class="string">"x = "</span> + x + <span class="string">"; y = "</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As referred by its name, this program is supposed to swap the values of the variables <code>x</code> and <code>y</code>. However, you will find it fails, printing <code>x = 0; y = 1984</code>.</p>
<p>The most natural way to swap two variables is to use a temporary variable:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tmp = x;</span><br><span class="line">x = y;</span><br><span class="line">y = tmp;</span><br></pre></td></tr></table></figure>

<p>It was discovered that one could avoid the temporary variable:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = x ^ y;</span><br><span class="line">y = y ^ x;</span><br><span class="line">x = y ^ x;</span><br><span class="line"><span class="comment">// promise me: don't do this in your program :)</span></span><br></pre></td></tr></table></figure>

<p>In fact, it works. However, it is not recommended, as it is far less clear than its naive counterpart and far slower. Now, you might combine the three exclusive OR operations and make it into a single statement, like in the code.</p>
<p>However, it is guaranteed not to work in Java, though might work in other languages (C, C++, …).</p>
<p>Operands of operators are evaluated from left to right. To evaluate the expression <code>x ^= expr</code>, the value of <code>x</code> is sampled <strong>before</strong> <code>expr</code> is evaluated, and the exclusive OR of these two values is assigned to the variable <code>x</code>.</p>
<p>The code below describes what in fact happens in the original program:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tmp1 = x;  <span class="comment">// first appearance of x in the expression</span></span><br><span class="line"><span class="keyword">int</span> tmp2 = y;  <span class="comment">// first appearance of y</span></span><br><span class="line"><span class="keyword">int</span> tmp3 = x ^ y;  <span class="comment">// compute x ^ y</span></span><br><span class="line">x = tmp3;  <span class="comment">// last assignment: store x ^ y in x</span></span><br><span class="line">y = tmp2 ^ tmp3;  <span class="comment">// second assignment, store original x value in y</span></span><br><span class="line">x = tmp1 ^ y;  <span class="comment">// first assignment: store 0 in x</span></span><br></pre></td></tr></table></figure>

<p>If you really want to make it work, you shoudl write it like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y = (x ^= (y ^= x)) ^ y;  <span class="comment">// NOT recommended!</span></span><br></pre></td></tr></table></figure>

<p>A lesson: do not assign to the same variable more than once in a single expression.</p>
<h3 id="Dos-Equis"><a href="#Dos-Equis" class="headerlink" title="Dos Equis"></a>Dos Equis</h3><p>Now look at an example of conditional operator. What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DosEquis</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> x = <span class="string">'X'</span>;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        System.out.print(<span class="keyword">true</span> ? x : <span class="number">0</span>);</span><br><span class="line">        System.out.print(<span class="keyword">false</span> ? i : x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okay, this program seems trivial, and both <code>print</code> lines will print out <code>x</code>. However, if you run the program, it turns out to be <code>X88</code>.</p>
<p>I would admit this is the most surprising behavior of Java I’ve ever seen.</p>
<p>The answer lies in a dark corner of the specification for the conditional operator. <strong><em>Mixed-type computation can be confusing. Nowhere is this more apparent than in conditional expressions.</em></strong></p>
<p>So, this problem is due to that these two expressions have different result types (one is <code>char</code> is one is <code>int</code>). There are three key points in determining the result type of a conditional expression:</p>
<ol>
<li>If the second and third operands have the same type, that is the type of the conditional expression;</li>
<li>If one of the operands is of type <em>T</em> and <em>T</em> is <code>byte</code>, <code>short</code>, or <code>char</code> and the other operand is a constant expression of type <code>int</code> whose value is represented in type <em>T</em>, the type of the conditional expression is <em>T</em>.</li>
<li>Otherwise, binary numeric promotion is applied to the operands types, and the type of the conditional expression is the promoted type of the second and third operands.</li>
</ol>
<p>Remember: use the same type for the second and third operands in conditional expressions.</p>
<h2 id="Puzzlers-with-Characters"><a href="#Puzzlers-with-Characters" class="headerlink" title="Puzzlers with Characters"></a>Puzzlers with Characters</h2><h3 id="Animal-Farm"><a href="#Animal-Farm" class="headerlink" title="Animal Farm"></a>Animal Farm</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnimalFarm</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String pig = <span class="string">"length: 10"</span>;</span><br><span class="line">        <span class="keyword">final</span> String dog = <span class="string">"length: "</span> + pig.length();</span><br><span class="line">        System.out.println(pig == dog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Both strings will be <code>length: 10</code> in this case. Though the <code>==</code> operator does not test whether two objects are equal (it tests whether two object reference are identical), compile-time constants of type <code>String</code> are <strong>interned</strong>. So this program should print <code>True</code>, right?</p>
<p>Unfortunately, no. <strong><em>This is because the second string is not initialized with constant expressions</em></strong>, and they will not point to the a same object.</p>
<h3 id="Escape-Rout"><a href="#Escape-Rout" class="headerlink" title="Escape Rout"></a>Escape Rout</h3><p>The following programs uses two Unicode escapes. What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EscapeRout</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// \u0022 is the Unicode escape for double quote (")</span></span><br><span class="line">        System.out.println(<span class="string">"a\u0022.length() + \u0022b"</span>.length());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You probably guess the result is 16 or 26. However, it’s 2.</p>
<p>A key to understanding this puzzle is: <strong><em>Java provides no special treatment for Unicode escapes within string literals</em></strong>. The compiler translates Unicode escapes into the characters they represent before it pareses the program into tokens, such as string literals. The Unicode escape in the program closes a one-character string literal (<code>&quot;a&quot;</code>), and same for the second one (<code>&quot;b&quot;</code>). In fact, the print line should be:</p>
<pre><code>System.out.println(&quot;a&quot;.length() + &quot;b&quot;.length())</code></pre><p>When programming with Java, remember that Unicode escapes are designed for use when a programmer needs to insert a character that can’t be represented in the source file’s character set. <strong><em>Don’t use unicode escapes to represent ASCII character</em></strong>.</p>
<h3 id="Hello-Whirled"><a href="#Hello-Whirled" class="headerlink" title="Hello Whirled"></a>Hello Whirled</h3><p>The program below seems to be absolutely right.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generated by the IBM IDL-to-Java compiler, version 1.0</span></span><br><span class="line"><span class="comment"> * from F:\TestRoot\apps\a1\units\include\PolicyHome.idl</span></span><br><span class="line"><span class="comment"> * Wednesday, June 17, 1998 6:44:40 o'clock Am GMT+00:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">"Hell"</span>);</span><br><span class="line">        System.out.println(<span class="string">"o world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, it does not compile. If you have read the previous puzzlers, you might get a subtle hint now.</p>
<p>Look at <code>\units</code> in the comments. These characters begin with a backslash (<code>\</code>) followed by the letter <code>u</code>, which denotes the start of a Unicode escape. These characters are not followed by four hexadecimal digits, so the Unicode escape is ill-formed.</p>
<p><em>Don’t put a Unicode escape in the program though it is well-formed</em>, unless you have a strong reason to do it.</p>
<p>Sometimes you might want to use Unicode escape to represent some special characters:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method calls itself recursively, causing a</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;StackOverFlowError&lt;/tt&gt; to be thrown.</span></span><br><span class="line"><span class="comment"> * The algorithm is due to Peter von Ah\u00E9.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>Please use HTML entity escapes instead.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method calls itself recursively, causing a</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;StackOverFlowError&lt;/tt&gt; to be thrown.</span></span><br><span class="line"><span class="comment"> * The algorithm is due to Peter von Ah&amp;eacute.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>An important lesson from this example is to avoid putting Windows filenames into comments in generated Java source files without first processing them to eliminate backslashes.</p>
<h3 id="Classy-Fire"><a href="#Classy-Fire" class="headerlink" title="Classy Fire"></a>Classy Fire</h3><p>What does this program print?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class Classifier &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            classify(&#39;n&#39;) + classify(&#39;+&#39;) + classify(&#39;2&#39;));</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static String classify(char ch) &#123;</span><br><span class="line">        if (&quot;0123456789&quot;.indexOf(ch) &gt;&#x3D; 0)</span><br><span class="line">            return &quot;NUMERAL &quot;;</span><br><span class="line">        if (&quot;qwertyuiopasdfghjklzxcvbnm&quot;.indexOf(ch) &gt;&#x3D; 0)</span><br><span class="line">            return &quot;LETTER &quot;;</span><br><span class="line">    &#x2F;* (Operator not supported yet)</span><br><span class="line">        if (&quot;+-*&#x2F;&amp;|!&#x3D;\&quot;&quot;.indexOf(ch) &gt;&#x3D; 0)</span><br><span class="line">            return &quot;OPERATOR &quot;;</span><br><span class="line">     *&#x2F;</span><br><span class="line">        return &quot;UNKNOWN &quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>you might not find anything wrong in this program. However, this program does not compile. You may also notice that I did not use code highlight. This is becasue you will easily find out the truth if I go with it:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Classifier</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            classify(<span class="string">'n'</span>) + classify(<span class="string">'+'</span>) + classify(<span class="string">'2'</span>));</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">classify</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"0123456789"</span>.indexOf(ch) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"NUMERAL "</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"qwertyuiopasdfghjklzxcvbnm"</span>.indexOf(ch) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"LETTER "</span>;</span><br><span class="line">    <span class="comment">/* (Operator not supported yet)</span></span><br><span class="line"><span class="comment">        if ("+-*/</span>&amp;|!=\<span class="string">""</span>.indexOf(ch) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"OPERATOR "</span>;</span><br><span class="line">     */</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"UNKNOWN "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Once again, as we mentioned earlier, <strong><em>string literals are not treated specially within comments</em></strong>. So, block comments do not nest either.</p>
<p>The best way to comment out a section of code is to use a sequence of single-line comments. You may use some IDEs to automate this process.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /* Operator not supported yet */</span></span><br><span class="line"><span class="comment">// if ("+-*/&amp;|!=".indexOf(ch) &gt;= 0)</span></span><br><span class="line"><span class="comment">//     return "OPERATOR ";</span></span><br></pre></td></tr></table></figure>

<h3 id="What’s-My-Class"><a href="#What’s-My-Class" class="headerlink" title="What’s My Class?"></a>What’s My Class?</h3><p>You might get this issue previously, which is presented by the program below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Me</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            Me.class.getName().replaceAll(".", "/") + ".class");</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems the program tries to replace all <code>.</code> with <code>/</code>. However, it prints <code>///////.class</code>.</p>
<p>The problem is due to that <code>String.replaceAll</code> takes a regular expression as its first parameter (same with <code>String.split</code>).Thus, every character of the class name if replaced by a slash.</p>
<p>An alternative is to use <code>java.util.regex.Pattern.quote</code> after release 5.0. It takes a string as a parameter and adds any necessary escapes, returning a regular expression string that matches the input string exactly.</p>
<h3 id="Dupe-of-URL"><a href="#Dupe-of-URL" class="headerlink" title="Dupe of URL"></a>Dupe of URL</h3><p>What do you think about this program? It doesn’t compile, right?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class BrowserTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;Hello World&quot;);</span><br><span class="line">        http:&#x2F;&#x2F;www.google.com;</span><br><span class="line">        System.out.println(&quot;Is this wrong?&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, it does. You might notice that I did not use the code highlight again.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">        http:<span class="comment">//www.google.com;</span></span><br><span class="line">        System.out.println(<span class="string">"Is this wrong?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In fact, the URL that appears in the middle of the program is a <em>statement label</em> followed by an end-of-line comment. Labels are rarely needed in Java.</p>
<h3 id="No-Pain-No-Gain"><a href="#No-Pain-No-Gain" class="headerlink" title="No Pain, No Gain"></a>No Pain, No Gain</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rhymes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuffer word = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span>(rnd.nextInt(<span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: word = <span class="keyword">new</span> StringBuffer(<span class="string">'P'</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: word = <span class="keyword">new</span> StringBuffer(<span class="string">'G'</span>);</span><br><span class="line">            <span class="keyword">default</span>: word = <span class="keyword">new</span> StringBuffer(<span class="string">'M'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        word.append(<span class="string">'a'</span>);</span><br><span class="line">        word.append(<span class="string">'i'</span>);</span><br><span class="line">        word.append(<span class="string">'n'</span>);</span><br><span class="line">        System.out.println(word);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You might notice that <code>rnd.nextInt(2)</code> will never return <code>2</code>, so <code>case 2</code> will never be reached; in addition, since there is no <code>break</code> at the end of each case, the default case will always be executed, so the result always should be <code>Main</code>.</p>
<p>Well, you successfully spotted several issues in this program, but the result will always be <code>ain</code>.</p>
<p>There is a very subtle error that you didn’t catch: <code>new StringBuffer(&#39;M&#39;)</code> probably does not do what you think it does. Let me ask you a question:</p>
<blockquote>
<p>Q: Are you pretty sure you are familiar with <code>StringBuffer(char)</code> constructor?</p>
</blockquote>
<p>I am pretty sure you aren’t with a good reason: <strong><em>It does not exist</em></strong>.</p>
<p>All <code>StringBuffer</code> constructors are listed below:</p>
<ul>
<li>A parameterless one;</li>
<li>one that takes a <code>String</code> indicating the initial contents of the string buffer;</li>
<li>one that takes an <code>int</code> indicating its initial capacity.</li>
</ul>
<p>So, if we pass a <code>char</code> to it, the third constructor will be used.</p>
<p>To avoid this kind of problem, use familiar idioms and APIs whenever possible. If you must use unfamiliar APIs, read the documentation carefully.</p>
<h2 id="Loopy-Puzzlers"><a href="#Loopy-Puzzlers" class="headerlink" title="Loopy Puzzlers"></a>Loopy Puzzlers</h2><h3 id="A-Big-Delight-in-Every-Byte"><a href="#A-Big-Delight-in-Every-Byte" class="headerlink" title="A Big Delight in Every Byte"></a>A Big Delight in Every Byte</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BigDelight</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span> b = Byte.MIN_VALUE; b &lt; Byte.MAX_VALUE; b++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (b == <span class="number">0x90</span>)</span><br><span class="line">                System.out.println(<span class="string">"Joy!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okay, it seems that <code>b</code> goes through every value from <code>Byte.MIN_VALUE</code> to <code>Byte.MAX_VALUE</code> (exclusive). As a byte has 8 bits, so the min value is <code>0x90</code> while the max one is <code>0x7F</code>. What happens here?</p>
<p>To figure it out, I should know what really happens in <code>b == 0x90</code>. The comparison of a <code>byte</code> to an <code>int</code> is a <em>mixed-type comparison</em>. Java will promote the <code>byte</code> to an <code>int</code> with a widening primitive conversion and compares the two <code>int</code> values. And remember, <code>byte</code> a <strong><em>signed</em></strong> value, and the conversion performs sign extension, promoting negative <code>byte</code> values to numerically equal <code>int</code> values. Thus, if we treat <code>b</code> as an <code>int</code>, its values are from <code>-128</code> to <code>+127</code>, while <code>0x90</code> is <code>+144</code>.</p>
<p>Remember, avoid mixed-type comparisons, because they are inherently confusing, and there are many hidden cases we might not be aware of.</p>
<h3 id="Inclement-Increment"><a href="#Inclement-Increment" class="headerlink" title="Inclement Increment"></a>Inclement Increment</h3><p>What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Increment</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            j = j++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You might expect the output is ‘100’, right? In each loop, <code>j</code> will increment itself and assign it to itself. However, the result is ‘0’.</p>
<p>When palced after a variable, the <code>++</code> operator functions as the <em>postfix increment operator</em>: the value of the expression <code>j++</code> is the original value of <code>j</code> before it was incremented. The assignment is equivalent to this sequence of statements:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tmp = j;</span><br><span class="line">j = j + <span class="number">1</span>;</span><br><span class="line">j = tmp;</span><br></pre></td></tr></table></figure>

<p>Remember: do not assign to the same variable more than once in a single expression.</p>
<h3 id="Shifty-i’s"><a href="#Shifty-i’s" class="headerlink" title="Shifty i’s"></a>Shifty i’s</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shifty</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (-<span class="number">1</span> &lt;&lt; i != <span class="number">0</span>) &#123;</span><br><span class="line">            i ++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okay, <code>-1</code> is an <code>int</code> value with all 32 bits set. The left-shift operator shifts zeros in from the right to fill the low-order bits vacated by the shift, since there are 32 bits in <code>-1</code>, <code>-1</code> will become 0 when <code>i</code> is <code>32</code>. Is it right? If you run this program, you will not see such a value printed but an infinite loop.</p>
<p>Remember, <strong><em>shift operators use only the five low-order bits of their right operand as the shift distance, or six bits if the left operand is a <code>long</code></em></strong>. The applies to all three shift operators: <code>&lt;&lt;</code>, <code>&gt;&gt;</code> and <code>&gt;&gt;&gt;</code>. So the shift distance is always between 0 and 31, or 0 and 63 if the left operand is a <code>long</code>.</p>
<p>A good practice from this puzzler is, shift distances should, if possible, be constants.</p>
<h3 id="Loopers"><a href="#Loopers" class="headerlink" title="Loopers"></a>Loopers</h3><p>It is your turn to write some codes.</p>
<ol>
<li>what declaration for <code>i</code> turns this loop into aninfinite one?</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i == i + <span class="number">1</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>what declaration for <code>i</code> turns this loop into aninfinite one?</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i != i) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When working with float number, remember that Java mandates the use of IEEE 754 floating-point arithmetic, <strong>which lets you represent infinity as a <code>double</code> or <code>float</code></strong>. And, infinity plus 1 is still infinity. Thus, for the first puzzle, you can initialize <code>i</code> by <code>double i = 1.0 / 0.0</code> or, better yet, <code>double i = Double.POSITIVE_INFINITY</code>.</p>
<p>Also, IEEE 754 floating-point arithmetic reserves a special value to represrent a quantity that is <em>not a number</em>, which is known as <code>NaN</code>. <strong>NaN is not equal to any floating-point value, <em>including itself</em>.</strong> Thus, for the second puzzle, you can initialize <code>i</code> by <code>double i = 0.0 / 0.0</code> or <code>double i = Double.NaN</code>.</p>
<p>In addition, NaN holds other similar surpises. <strong>Any floating-point operation evaluates to NaN if one or more of its operands are NaN</strong>.</p>
<h3 id="Ghost-of-Looper"><a href="#Ghost-of-Looper" class="headerlink" title="Ghost of Looper"></a>Ghost of Looper</h3><p>Provide a declaration for <code>i</code> that turns this loop in to an infinite loop:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i != <span class="number">0</span>)</span><br><span class="line">    i &gt;&gt;&gt;= <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>To solve this puzzler, you should be aware that <strong><em><code>&gt;&gt;&gt;=</code>  is a compound assignment operator and they will silently perform narrowing primitive conversions.</em></strong> Narrow primitive conversions can lose information about the magnitude or precision of numeric values. Thus, if we declare <code>i</code> with <code>short i = -1</code>, the program will do the following:</p>
<ol>
<li>As <code>1</code> is an <code>int</code>, Java will promote <code>i</code> to type of <code>int</code>, which turns <code>0xffff</code> into <code>0xffffffff</code>.</li>
<li>This value if then shifted to the right by one bit without sign extension to yield the <code>int</code> value <code>0x7fffffff</code>.</li>
<li>In order to store the <code>int</code> value into the <code>short</code> variable, Java performs the dreaded narrowing primitive conversion, which simply lops off the high-order 16 bits of the value, which is <code>0xffff</code> again.</li>
</ol>
<p>Remember: do not use compound assignment operators on <code>short</code>, <code>byte</code>, or <code>char</code> variables.\</p>
<h2 id="Exceptional-Puzzlers"><a href="#Exceptional-Puzzlers" class="headerlink" title="Exceptional Puzzlers"></a>Exceptional Puzzlers</h2><h3 id="Indecision"><a href="#Indecision" class="headerlink" title="Indecision"></a>Indecision</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Indecisive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(decision());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">decision</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We know that once it reaches a <code>return</code> statement in a function, the rest of the function will not execute anymore; on the other hand, <code>finally</code> block will always be executed. What is the fact?</p>
<p>The answer is <code>false</code>. <code>return</code> statement is called <em>abrupt completion</em>. When both the <code>try</code> and the <code>finally</code> block complete abruptly, the abrupt completion in the <code>try</code> block is discarded, and the whole <code>try-finally</code> statement completes abruptly for the same reason as the <code>finally</code> block. In this program, the abrupt completion caused by the <code>return</code> statement is the <code>try</code> block is discarded, and the <code>try-finally</code> statement completes abruptly because of the <code>return</code> statement in the <code>finally</code> block.</p>
<p>Remember, <strong><em>never exit a <code>finally</code> block with a <code>return</code>, <code>break</code>, <code>continue</code>, or <code>throw</code>, and never allow a checked exception to propagate out of a <code>finally block</code></em></strong>.</p>
<h3 id="Exceptionally-Arcane"><a href="#Exceptionally-Arcane" class="headerlink" title="Exceptionally Arcane"></a>Exceptionally Arcane</h3><p>Look at the three programs below and expect their behaviors.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Acrane1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Arcane2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// Nothing here</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Exception"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Type1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Type2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Type3</span> <span class="keyword">extends</span> <span class="title">Type1</span>, <span class="title">Type2</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Arcane3</span> <span class="keyword">implements</span> <span class="title">Type3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Type3 t3 = <span class="keyword">new</span> Arcane3();</span><br><span class="line">        t3.f();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You will get compile error in the first program, as the language specification says that <strong>it is a compile-time error for a <code>catch</code> clause to catch a checked exception type E if the corresponding <code>try</code> clause can’t throw an exception of some subtype of E</strong>.</p>
<p>By the same token, in the second program, it should not compile either, but it does. <strong><code>Catch</code> clauses that catch <code>Exception</code> or <code>Throwable</code> are legal regardless of the contents of the corresponding <code>try</code> clause</strong>.</p>
<p>Should the third program compile? Method <code>f</code> is declared to throw checked exceptions in <code>Type1</code> and <code>Type2</code>. Interface <code>Type3</code> inherits from <code>Type1</code> and <code>Type2</code>, so it would seem that invoking <code>f</code> on an object whose static type is <code>Type3</code> could potentially throw either of these exceptions. However, it is not true that <code>Type3.f</code> can throw either the exception declared on <code>Type1.f</code> or the one declared on <code>Type2.f</code>. <strong>Each interface limits the set of checked exceptions that method <code>f</code> can throw</strong>. The set of checked exceptions that a method can throw is the intersection of the sets of checked exceptions that it is declared to throw in all applicable types. Thus, the <code>f</code> method on an object whose static type is <code>Type3</code> can’t throw any checked exceptions at all.</p>
<h3 id="Hello-Goodbye"><a href="#Hello-Goodbye" class="headerlink" title="Hello, Goodbye"></a>Hello, Goodbye</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloGoodbye</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Goodbye world"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Recall the puzzler “Indecision”, you might remember that if there are abrupt completions in both <code>try</code> and <code>finally</code> block, we will follow the on in <code>finally</code> block. However, in this case, you will find that this program will only print <code>Hello World</code>.</p>
<p>It is true that a <code>finally</code> is executed when a <code>try</code> block completes execution whether normally or abruptly. In this program, however, the <code>try</code> block does not complete execution at all. <strong>The <code>System.exit</code> method halts the execution of the current thread and all others dead in their tracks.</strong> The presence of a <code>finally</code> clause does not give a method special permission to continue executing.</p>
<p>When <code>System.exit</code> is called, the virtual machine performs two cleanup tasks before shutting down. First, it executes all <em>shutdown hooks</em> that have been registered with <code>Runtime.addShutdownHook</code>. This is useful to release resources external to the VM. <strong>Use shutdown hook for behavior that must occur before the VM exits</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloGoodbye</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello world"</span>);</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(</span><br><span class="line">            <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Goodbye world"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The second cleanup task performed by the VM when <code>System.exit</code> is called concerns finalizers. If either <code>System.runFinalizerOnExit</code> or its evil twin <code>Runtime.runFimalizerOnExit</code> has been called, the VM runs the finalizers on all objects that have not yet been finalized. These methods were deprecated a log time ago and with good reason. <strong>Never call <code>System.runFinalizersOnExit</code> or <code>Runtime.runFinalizersOnExit</code> for any reason: They are among the most dangerous methods in the Java libraries</strong>.</p>
<p>In summary, <code>System.exit</code> stops all program threads immediately: it does not cause <code>finally</code> blocks to execute, but it does run shutdown hooks before halting the VM.</p>
<h3 id="The-Reluctant-Constructor"><a href="#The-Reluctant-Constructor" class="headerlink" title="The Reluctant Constructor"></a>The Reluctant Constructor</h3><p>Have you ever seen a <code>throws</code> clause in a constructor declaration? What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reluctant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Reluctant internalInstance = <span class="keyword">new</span> Reluctant();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Reluctant</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">throws</span> new <span class="title">Exception</span><span class="params">(<span class="string">"I'm not coming out!"</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Reluctant b = <span class="keyword">new</span> Reluctant();</span><br><span class="line">            System.out.println(<span class="string">"Surprise"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"I told you so!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems that the constructor will throw an exception when it is called, which is caught by the <code>try</code> clause in the main function. However, if you run this function, it throws a <code>StackOverflowError</code>. Why?</p>
<p>The error indicates an infinite recursion. When you invoke a constructor, the <strong>instance variable initializers run before the body of the constructor</strong>. In this case, the initializer for the variable <code>internalInstance</code> invokes the constructor recursively. The constructor, in turn, initializes its own <code>internalInstance</code> field by invoking the <code>Reluctant</code> constructor again and so on, ad infinitum, which leads to an infinite recursion.</p>
<p>In fact, do not assume that you will not write similar codes. It is very common for an object to contain instances of its own type.</p>
<p>Remember: <strong><em>a constructor must declare any checked exceptions thrown by its instance initializers.</em></strong></p>
<h3 id="Field-and-Stream"><a href="#Field-and-Stream" class="headerlink" title="Field and Stream"></a>Field and Stream</h3><p>This method copies one file to anotehr and was designed to close every stream it creates, even if encounters I/O errors. However, it doesn’t alwasy do this. Why?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(String scc, String dest)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> FileInputStream(scc);</span><br><span class="line">        out = <span class="keyword">new</span> FIleOutputStream(dest);</span><br><span class="line">        <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">while</span> ((n = in.read(buf)) &gt;= <span class="number">0</span>)</span><br><span class="line">            out.write(buf, <span class="number">0</span>, n);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) in.close();</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="keyword">null</span>) out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This bug might be really subtle as it is not always reproducable. The problem is in the <code>finally</code> block itself. The <code>close</code> method can throw an <code>IOException</code> too. Once that happens, the calls to <code>close</code> can cause the <code>finally</code> block to complete abruptly. Unfortunately, the compiler will not help you find the problem, because <code>close</code> throws the same exception type as <code>read</code> and <code>write</code>, and the enclosing method <code>copy</code> will propagate it for sure.</p>
<p>An important lesson is to make sure you have handled any checked exception that can be thrown within a finally block rather than letting it propagate. Furthermore, in a lot of cases you might want to keep you program running even when exceptions occur, so you might use <code>try finally</code> to handle and make program continue. But always remember that the <code>finally</code> is not that safe: it can throw exceptions as well (I also experienced this when I was working at Apple).</p>
<br>

<p>———— END OF THIS POST ————</p>
<p>If you want to read more puzzlers, please go to <a href="/2020/04/13/java2/">this</a> page!</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/01/18/hello-world/">Hello World</a>
            <span class="archive-item-date">Jan 18, 2020</span>
            <!-- <span style=> <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
</span> -->
        </article>
    
        

        
            <h1>2019</h1>
        

        <article class="archive-item">
            <a class="archive-item-link" href="/2019/12/01/distributedsystem/">Project: A Distributed, Reliable and Fault-tolerant Banking System</a>
            <span class="archive-item-date">Dec 1, 2019</span>
            <!-- <span style=> <p><img src="bank.png" alt="bank"></p>
<p>In <a href="/2019/04/21/shoppingweb/">a previous post</a>, we have introduced a distributed system where:</p>
<ul>
<li>Load balancing (scalability) is implemented;</li>
<li>Multi-tier hierarchy is exploited.</li>
</ul>
<p>However, this small project is far from enough: we still have a lot to learn in designing and implementing a more comprehensive distributed system. Now, we will do something more <strong>interesting</strong> and <strong>challenging</strong>.</p>
<p>In this team project, we designed and implemented a comprehensive distributed banking system. However, the application part is simple in our project as we want to mainly focus on the design and implementation of the distributed system and principles of strong consistency. Below are some highlights or features of our system:</p>
<ul>
<li>Industrial standard architecture (but simplified) of distributed system;</li>
<li>Support <strong>active replication</strong> and <strong>passive replications</strong> schemes;</li>
<li>Implement total ordering to ensure strong consistency;</li>
<li>Tolerant to changes of membership (i.e., able to handle the cases where new replicas join or existing replicas fail);</li>
<li>Implement web UI for each component;</li>
<li>Support some basic banking operations, e.g., create an account, deposit, withdraw, etc.</li>
<li>…</li>
</ul>
<p>Due to the CMU AIV policy, we will not release the codes of the project. If you have any question, please contact me or leave comments at the bottom of this page.</p>
<h1 id="Design-Overview"><a href="#Design-Overview" class="headerlink" title="Design Overview"></a>Design Overview</h1><p>In this section, we are going to give a brief introduction to our system.</p>
<h2 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h2><table>
<thead>
<tr>
<th>Name</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>RM</td>
<td>replication manager</td>
</tr>
<tr>
<td>GFD</td>
<td>global fault detector</td>
</tr>
<tr>
<td>LFD</td>
<td>local fault detector</td>
</tr>
<tr>
<td>Address</td>
<td>the IP and port number of a service (e.g. the RM, GFD, LFD or a replica)</td>
</tr>
<tr>
<td>Replica status</td>
<td>whether the replica is <strong>NEW</strong> (a new replica that is syncing up) or <strong>READY</strong> (the replica is up and running).</td>
</tr>
<tr>
<td>Local replica status</td>
<td>the replica status of all the replicas that are managed by an LFD.</td>
</tr>
<tr>
<td>Global replica status</td>
<td>the replica status of all the replicas that are managed by a GFD.</td>
</tr>
<tr>
<td>Replication configuration</td>
<td>the addresses of reachable replicas, the replication style, the primary replica if passive, etc.</td>
</tr>
<tr>
<td>Reachable replica</td>
<td>in the distributed system settings, it is hard to say if a replica is “running” or not, since it can happen that a replica is still running but can’t be reached by an LFD or GFD. To avoid such ambiguity, we would say that a replica is “unreachable”.</td>
</tr>
<tr>
<td>Service info</td>
<td>the replication configuration in the client’s point of view, including the addresses of replicas that the client needs to reach. In passive replication, a client only needs to reach the primary replica but in active replication, it needs to reach all active replicas.</td>
</tr>
</tbody></table>
<h2 id="Hierarchy-and-Components"><a href="#Hierarchy-and-Components" class="headerlink" title="Hierarchy and Components"></a>Hierarchy and Components</h2><p>We used a simplified version of an industry-standard architecture. The picture below shows a brief structure of the system.</p>
<p><img src="system.svg" alt="system"></p>
<p>Please note that each element in the picture (e.g., RM, GFD) would be a physical machine or a virtual machine or even a process. To simplify the system, we make RM and GFD on one physical machine. An LFD and several replicas would be included in a cluster, which, in our case, is a physical machine.</p>
<p>We will give a detailed description of each component in the picture above.</p>
<h3 id="Replication-Manager"><a href="#Replication-Manager" class="headerlink" title="Replication Manager"></a>Replication Manager</h3><p>The replication manager maintains a table of all replicas and their addresses (called replica status table), and also the replication style (either passive or active) and which is the primary replica in passive replication.</p>
<p>The replication manager also maintains a sequence number counter that monotonically increases.</p>
<p>The global fault detector periodically polls the status of all replicas and reports changes to the replication manager. The changes can be addition or removal of replicas. The replication manager is responsible for reacting appropriately to the changes. For example, in passive replication, if the primary replica is removed from the membership, the replication manager is responsible for choosing a new primary replica.</p>
<p>The replication manager assumes that the global fault detector never crashes.</p>
<h3 id="Global-Fault-Detector"><a href="#Global-Fault-Detector" class="headerlink" title="Global Fault Detector"></a>Global Fault Detector</h3><p>The global fault detector maintains a list of addresses of local fault detectors and the status of all replicas at the last check. <strong>It will never directly contact any replicas</strong>.</p>
<p>The global fault detector periodically asks all local fault detectors for replica status. The interval (a.k.a. the fault detection interval) is configured via a configuration file or command-line argument. If there are any changes between the new status and the previous one, it reports these changes to the replication manager.</p>
<p>That a replica becomes unreachable and that a local fault detector becomes unreachable both mean related replicas are removed from the membership. The GFD doesn’t distinguish between these two cases.</p>
<p>If a local fault detector is unreachable for one time, it is immediately removed from the list and all associated replicas under that local fault detector are considered as leaving the cluster. This is to avoid a local fault detector from fluctuating between reachable and unreachable due to temporary network malfunctioning.</p>
<h3 id="Local-Fault-Detector"><a href="#Local-Fault-Detector" class="headerlink" title="Local Fault Detector"></a>Local Fault Detector</h3><p>The local fault detector maintains a list of addresses of replicas that it monitors (which can be only one).</p>
<p>Each time the global fault detector queries replica status, it asks all the replicas on its list for their status and returns the result to the global fault detector.</p>
<p>If a replica is unreachable for one time, it is immediately removed from the list.</p>
<p>Please note that we used a 2-tier mechanism for failure detection (LFD and GFD), which could be efficient when there are many replicas across the whole system. A single fault detector, which manages all replicas, would show poor scalability.</p>
<h3 id="Replica"><a href="#Replica" class="headerlink" title="Replica"></a>Replica</h3><p>Replicas maintain the state of the application and respond to queries of the local fault detector.</p>
<p>When a new replica is added to the cluster, the replica will notify its LFD, and LFD will later notify GFD about this update. When the replication manager detects the addition of this replica via the report of the GFD, it sends a <code>updateReplicationConfig</code> to the new replica as well as all other replicas to trigger synchronization (the new replica can download checkpoints and logs from any other replicas).</p>
<h1 id="Interaction"><a href="#Interaction" class="headerlink" title="Interaction"></a>Interaction</h1><p>In this project, we use <strong>HTTP-based</strong> messages for communication between different components. That is to say, each component may act as an HTTP server, an HTTP client, or both. A clear and rigid workflow is also critical to make sure the system behaves as we expect. We will cover some cases that you might be interested in and explain the mechanism/workflow behind them.</p>
<h2 id="Startup"><a href="#Startup" class="headerlink" title="Startup"></a>Startup</h2><p>To simplify our implementation, all components in our system will be started manually. GFD and RM will be first started. GFD is configured with the address of the RM and its monitoring list is initially empty.</p>
<p>When a LFD starts, the LFD calls /addLocalFaultDetector of the GFD to add itself to the monitoring list of the GFD.</p>
<p>When a replica starts, the replica calls /addReplica of the LFD to add itself to the monitoring list of the LFD.</p>
<p>Next time that GFD polls replica status, it will detect the presence of the new replicas or absence of old replicas and report this change to the RM.</p>
<h2 id="Replica-Status-Polling"><a href="#Replica-Status-Polling" class="headerlink" title="Replica Status Polling"></a>Replica Status Polling</h2><p>The GFD performs replica status polling to know the liveness of all replicas and reports any changes since the last check to the replication manager.</p>
<p>The frequency of the GFD performing this polling is determined by the fault detection interval, which is part of the configuration file of GFD and can be modified by the RM.</p>
<h3 id="Detect-a-Failed-Replica"><a href="#Detect-a-Failed-Replica" class="headerlink" title="Detect a Failed Replica"></a>Detect a Failed Replica</h3><p>When a replica fails or becomes unreachable, LFD will first be aware of the issue and notify the GFD about this update. The GFD would notify the RM and RM would later send the new replication configuration that has removed the failed replica to all reachable replicas.</p>
<p>You may refer to the UML sequence diagram for a more accurate description.</p>
<p><img src="polling_1.svg" alt="polling_1"></p>
<h3 id="Detect-a-New-Replica"><a href="#Detect-a-New-Replica" class="headerlink" title="Detect a New Replica"></a>Detect a New Replica</h3><p>When a replica is started (note it could be a previously failed replica and now it recovers), it will first report to its LFD (a new replica will always be configured with the address of its LFD). LFD will deliver this message to GFD, who will also notify RM if there are changes in the replica configuration.</p>
<p>On the RM’s side, when a new replica is detected, the RM broadcasts the replication configuration containing the new replica to all reachable replicas. After knowing other replicas, the new replica can download checkpoints and logs from any up and running replica.</p>
<p>When the primary replica is unreachable in passive replication, the RM chooses a new primary and broadcasts the new configuration to all reachable replicas. (We will give more information for this part later)</p>
<p>The sequence interaction diagram shows how the GFD conducts replica status polling and what would happen if a new replica is detected.</p>
<p><img src="polling_2.svg" alt="polling_2"></p>
<h2 id="Client-Operation"><a href="#Client-Operation" class="headerlink" title="Client Operation"></a>Client Operation</h2><p>When a client initializes a request, the request will go through many components and trigger various behaviors, which could be <strong>highly complicated and interactive</strong>. Our goal in processing clients’ requests is to guarantee strong consistency across all replicas by implementing <strong>total ordering</strong>. In addition, we are also supposed to design and implement different workflows under different replication style/schemes (active or passive). We will skip this section and give more explanation when we talk about replication styles later.</p>
<h1 id="Request-Handling"><a href="#Request-Handling" class="headerlink" title="Request Handling"></a>Request Handling</h1><p>Up to now we already know how the system keeps detecting new or failed replicas. However, you may still have questions:</p>
<ol>
<li>How do you handle a request while ensuring strong consistency?</li>
<li>Consider a case where multiple clients may send requests simultaneously. How do you implement total ordering to guarantee consistency?</li>
<li>Consider a case where the whole system has been running for a while and have handled some request. Now a new replica joins. How does it synchronize to the most recent state? In other words, how do you implement logging and checkpointing?</li>
</ol>
<p>No worry. Before we start, let’s dive deep into the replication style.</p>
<h2 id="Replication-Style"><a href="#Replication-Style" class="headerlink" title="Replication Style"></a>Replication Style</h2><p>In this project, we support two different replication styles.</p>
<h3 id="Active-Style"><a href="#Active-Style" class="headerlink" title="Active Style"></a>Active Style</h3><p>In active replication style, once a client sends a request, <strong>ALL</strong> replicas will have to execute the request and, if necessary, make state changes. Active replication style promises faster recovery from faults but it normally requires more memory and processing costs.</p>
<p>If many clients send requests simultaneously, it is highly possible that different replicas will receive different orders of requests. In this case, strong consistency might be compromised, and we need <strong>total ordering</strong> to address this concern. We will talk about it later.</p>
<h3 id="Passive-Style"><a href="#Passive-Style" class="headerlink" title="Passive Style"></a>Passive Style</h3><p>In passive replication style, only the <strong>primary replica</strong> will receive and handle this request. For other replicas (a.k.a <strong>secondary replicas</strong>), they will only get checkpoints from primary replica periodically (the frequency is determined by a parameter called <em>checkpointing interval</em> which can be modified while the system is running). Passive replication style requires less memory and processing costs but may take longer to recover from faults/failures.</p>
<p>Total ordering will be trivial here as there is only one replica that executes requests. However, it may complicate other parts. For example, if the primary replica fails, how can we determine a new replica as the primary replica? Some consensus protocols might be helpful (e.g., PAXOS), but remember: <em>implementing a consensus protocol would be highly complicated and painful.</em></p>
<p>No worry. We will introduce our solution later.</p>
<h2 id="Total-Ordering"><a href="#Total-Ordering" class="headerlink" title="Total Ordering"></a>Total Ordering</h2><p>Here are many ways to implement total ordering in active replication style. Let’s list some:</p>
<ol>
<li>Ask every client to grab a <strong><em>sequence number</em></strong> from RM or another agency every time it wants to send a request. The request and its assigned sequence number will then be delivered to all replicas, and replicas will handle requests in the order of request’s sequence number (like what we do in TCP protocol).</li>
<li>Ask all clients to send requests to RM (or another agency) and let the RM decide the order of requests to process. Replicas will get requests from RM.</li>
</ol>
<p>However, these schemes might be fragile if we consider some extreme cases:</p>
<ol>
<li>In the first scheme, what if a client grabs a sequence number and holds it for a long time before sending a request? What may happen is that replicas will block in order to wait for that request’s arrival.</li>
<li>In the second scheme, what if we have many replicas sending requests? Scalability would be an issue and the RM (or the agency receiving all requests) would become the bottleneck.</li>
</ol>
<p>We would instead use a new scheme in our project. This scheme only involves replicas themselves and it is easy to implement.</p>
<h3 id="Polite-Client-Assumption"><a href="#Polite-Client-Assumption" class="headerlink" title="Polite Client Assumption"></a>Polite Client Assumption</h3><p>First, we have the following assumptions:</p>
<ul>
<li>The RM first notifies all clients of the new replication configuration, then notifies all replicas of the new config.</li>
<li>Whenever the client knows there is a replica whose state is NEW (which means the synchronization for this NEW replica is undergoing and have not finished), it stops sending requests until all replicas are READY. <strong><em>You will later see that this assumption is strong and it greatly simplifies the implementation of total ordering.</em></strong></li>
</ul>
<h3 id="Handling-Client-Requests"><a href="#Handling-Client-Requests" class="headerlink" title="Handling Client Requests"></a>Handling Client Requests</h3><p>Let’s first talk about how a replica handles a client request.</p>
<p>By <em>Polite Client Assumption</em>, we know that a new replica never receives client requests. A replica only receives requests when it is in READY state.</p>
<p>The procedure is:</p>
<ol>
<li>Put the client request in the <strong><em>RequestPool</em></strong> and waits for it to complete. When this thread is waiting, other threads do consensus and request processing work. When everything is done, this thread is woken up with the result.</li>
<li>Return the result to the client.</li>
</ol>
<p>The RequestPool is a bridge between the client side and the consensus side. The client side doesn’t care how the consensus is done, and the consensus side doesn’t care where the request comes from and where it goes to.</p>
<p>So now we have a <strong>clear separation</strong> between client request handling and consensus protocol.</p>
<h3 id="Executor-Thread"><a href="#Executor-Thread" class="headerlink" title="Executor Thread"></a>Executor Thread</h3><p>Before talking about consensus protocol, let’s first assume that we already have a total order by running consensus. Now how do we actually process those requests?</p>
<p>The truth is that <strong>the replica has a long-running Executor thread. The thread runs a while(true) loop that checks if it has any work to do repeatedly</strong>.</p>
<p>It has an internal counter <code>nextProcLid</code> that is the next log ID to process. We use log ID (or Lid) to refer to the <em>index of a message in the total order</em>.</p>
<p>It also needs to read a global variable <code>lastCommitLid</code> that is the last committed log ID (which means you can process all the logs up to this lid, but not those after this lid). For now, we can assume that <code>lastCommitLid</code> is always the ID of the last log entry in its log. Later, we’ll talk about why it is not.</p>
<p>The thread work as follows:</p>
<ol>
<li>Check if <code>nextProcLid &lt;= lastCommitLid</code> and there is a request in the RequestPool with the log ID equal to <code>nextProcLid</code>. If false, then we have processed all committed requests, so we have nothing to do.</li>
<li>If false, we sleep 100 ms and go to step 1. If true, we process that request, hand over the response to the RequestPool and increment <code>nextProcLid</code>. By giving the response to the RequestPool, the Executor thread wakes up the client request thread that is waiting for it.</li>
<li>Go to step 1. We want to process as many as possible.</li>
</ol>
<p><img src="executor_thread.svg" alt="executor-flow"></p>
<p>The RequestPool has an API that allows us to find a request by the log ID. The log ID is not assigned by the client request thread. It is set by the consensus protocol.</p>
<p>We have already talked about how to handle client requests and how to process a request. All the “request-related” things have been discussed. The only thing left is how to achieve consensus on the order of requests.</p>
<p>In the rest of the section, we will focus our eyes only on the request ID (which is generated uniquely by the client) and the log ID. We will ignore the content of the requests.</p>
<h3 id="Prosper-and-Acceptor"><a href="#Prosper-and-Acceptor" class="headerlink" title="Prosper and Acceptor"></a>Prosper and Acceptor</h3><p>A replica can be either a <strong><em>proposer</em></strong> or an <strong><em>acceptor</em></strong>, but not both.</p>
<ul>
<li>A proposer dictates the order of messages.</li>
<li>An acceptor accepts whatever the proposer says.</li>
</ul>
<p>The proposer has a Proposer thread running in the background.</p>
<p>The Proposer thread has an internal counter <code>nextProposeLid</code> that is the next log id to propose.</p>
<p>The Proposer thread also has an internal hash map <code>lastLidMap</code> whose key is a replicaId, and whose value is the lastLid of that replica (the ID of the last log that replica has).</p>
<p>The proposer periodically executes this:</p>
<ol>
<li>Get all unassigned requests from the RequestPool. An unassigned request has no lid. After it is proposed, it is assigned a lid. So we ensure that a request can be proposed only once.</li>
<li>Assign <code>nextProposeLid</code> to an unassigned request and then increment <code>nextProposeLid</code>, repeat for all unassigned requests. This is how the requests in the RequestPool are assigned.</li>
<li>Append these <code>requestId</code> to the local log that it has. <code>requestId</code> is the unique identifier generated by the client in the request. The index of the requestId in the log is its lid.</li>
<li>Send <code>appendLog(lastCommitId, logs)</code> to all ready acceptors; logs start from <code>lastLidMap[replicaId]+1</code> for each replica. After doing <code>appendLog</code>, all ready replicas are informed of the assignments. But these new logs are not committed yet.</li>
<li>Set <code>lastCommitId</code> to the last lid in its log. After informing all replicas, we can commit these logs. This value will be updated to all replicas in the next round.</li>
</ol>
<p>Periodically, even if there is no unassigned request, the proposer will still send an <code>appendLog(lastCommitId, [])</code> to all replicas (to inform them of the new commit ID, for example).</p>
<p><img src="proposer_thread.svg" alt="proposer_workflow"></p>
<p>The acceptor reacts to appendLog request from the proposer by doing the following things:</p>
<ul>
<li>Assign <code>lastCommitId</code> to the value in <code>appendLog</code>.</li>
<li>If the RequestPool has the requests, assign the lids to the requests.</li>
<li>If not, tell the RequestPool to save the pair <code>(lid, requestId)</code> somewhere and assign the lids to those requests when it sees the requests later.</li>
</ul>
<p>By doing so, the Executor thread in the acceptor will eventually process the request.</p>
<h3 id="New-Proposer-Confirmation"><a href="#New-Proposer-Confirmation" class="headerlink" title="New Proposer Confirmation"></a>New Proposer Confirmation</h3><p><strong>When a new replica joins the cluster, the RM assigns a <code>replicaRank</code> to the replica.</strong> The replicaRank is an integer increasing from 0. It marks when a replica joins the cluster. New replicas have greater ranks.</p>
<p>Whenever a replica receives a <code>updateReplicationConfig</code> request from the RM, <strong><em>it recognizes the replica with the smallest rank as the proposer</em></strong>.</p>
<p>Since a new proposer will appear only AFTER the old proposer crashes, there will never be two proposers at the same time. There will be times when there is no proposer at all, but it’s okay. Eventually, there will be a proposer.</p>
<p>We also know that the transition is one-directional: an acceptor can become a proposer, but a proposer can never become an acceptor (it’s a dictator for life).</p>
<p>Whenever there is a proposer change, the new proposers and the acceptors will perform a proposer confirmation process.</p>
<ol>
<li>The proposer sends <code>confirm(lastLid)</code> to all ready acceptors (a) to tell all replicas the last log ID that the proposer has and (b) to ask them to tell the proposer the last log ID that they have. The new proposer might not be the one who has the longest log.</li>
<li>Each acceptor responds with the latest log ID it has to the proposer; if an acceptor has longer logs, it also put these additional logs in the response.</li>
<li>Upon receiving all responses, for all acceptors’ responses,<ul>
<li>If an acceptor has a longer log, the proposer will append the missing part to its log. Now the proposer has the longest log.</li>
<li>Set lastLidMap[replicaId] to the lid in the response. Next time the proposer will send logs to this replica from this position.</li>
</ul>
</li>
<li>If the RequestPool has no unassigned requests for now, put a <strong><em>NoOp(do-nothing)</em></strong> request in the pool. The proposer might have some assigned but uncommitted requests. If we don’t commit them, the clients might be blocked. However, the way we commit them is not to modify the <code>lastCommitLid</code> directly, but to propose a NoOp request, which in turn triggers the <code>appendLog</code> procedure, committing the NoOp request and all the uncommitted requests ahead of it.</li>
</ol>
<p>After the new proposer finishes the confirmation, it will start the Proposer thread. There might be some unassigned requests left when it was an acceptor, the new proposer will propose these requests eventually. No requests will be lost.</p>
<p><img src="new_proposer.svg" alt="new_proposer"></p>
<p>Up to now, you might be confused with the description above. Let’s address some questions again.</p>
<blockquote>
<p><strong>Q: Why do we need a <code>lastCommitLid</code>?</strong></p>
</blockquote>
<p>There are <strong>three parts</strong> in the log:</p>
<ul>
<li>the first part is what is committed and processed;</li>
<li>the second part is what is committed but unprocessed (the executor hasn’t processed them though it can do so);</li>
<li>the third part is what is uncommitted (the executor is not allowed to process them).</li>
</ul>
<p>Why can’t we assume all logs are committed?</p>
<p>Think of this scenario of three replicas: the proposer appended the log X to acceptor A, but before appending to acceptor B, crashed. Acceptor A crashed simultaneously (a.k.a. two simultaneous faults). Acceptor B becomes the new proposer.</p>
<p>Do you see the problem?</p>
<p>Acceptor B has no possibility of knowing that X is in the log. It may propose something different, for example, an unassigned request Y, before re-proposing X. But since acceptor A knows X, it might already have returned the response to the client.</p>
<p>Now we have an <strong>inconsistency</strong>: the client thought X happened before Y, but in the new “world”, the new proposer said Y happened before X!</p>
<p>The way to avoid this from happening is to commit (allowing processing a request) <strong><em>only after all replicas know the log</em></strong>, which is a typical consensus behavior (you may compare it with 2-phase commit or PAXOS). That’s why we need a <code>lastCommitLid</code>.</p>
<p>In other words, uncommitted logs are changeable during proposer changes.</p>
<blockquote>
<p> <strong>Q: Why do we need a NoOp request?</strong></p>
</blockquote>
<p>This issue raises from committing.</p>
<p>Let’s look at a new proposer. It has some assigned but uncommitted requests. These uncommitted requests block the clients who are waiting for responses. And in turn, since the clients are blocked, they can’t send new requests.</p>
<p>And now comes the problem: the proposer can commit only when receiving new requests! It’s a deadlock.</p>
<p>To avoid it from happening, if the proposer has no unassigned requests, it proposes a NoOp request that does nothing. By the time the NoOp request is committed, all the requests before the NoOp are committed as well! Remember lastCommitLid means that <strong>ALL</strong> the requests before and equal to that lid are committed.</p>
<h3 id="New-Replica"><a href="#New-Replica" class="headerlink" title="New Replica"></a>New Replica</h3><p>Let’s first recap the <strong><em>Polite Client Assumption</em></strong>. No client interactions during new replica synchronization.</p>
<p>Upon receiving updateReplicationConfig, the proposer checks if there is a NEW replica that it sees for the first time. If so, it starts the following synchronization step.</p>
<ol>
<li>The proposer first asks if the NEW replica is still in the NEW state. The latency of information propagation can cheat. That’s why we need to confirm the state of the new replica.</li>
<li>If the replica says READY, the proposer internally marks it as READY and finish. If the replica says NEW, do the following. By internally marking as READY, the proposer will ignore any state of that replica in later updateReplicationConfig. There might be some delay for it to become ready.</li>
<li><strong>The proposer waits until all the requests are processed</strong>. This is to ensure that its state is the newest state. If it has some requests left undone, its state is earlier than the latest.</li>
<li>The proposer checkpoints the state. It contains the balance of all accounts and the last processed log ID and the last committed log ID.</li>
<li>The proposer sends the checkpoint to the new replica.</li>
<li>The new replica accepts and recovers the state from the checkpoint. <strong>Now the new replica is in the same state as the proposer.</strong></li>
<li>The new replica switches to READY state. If the old proposer crashes, the new proposer will ask if the new replica is still new first (this is a corner case that we might ignore).</li>
<li>The proposer internally marks the replica as READY and will never perform the synchronization on that replica again, even if later <code>updateReplicationConfig</code> says it is still NEW (due to the latency of fault detectors).</li>
</ol>
<p><img src="new_replica.svg" alt="new_replica"></p>
<p>Up to now, you may have a more comprehensive understanding of how requests are handled and what would happen if some faults come to appear (e.g., the proposer fails, a replica joins). A very important note is that: <strong>all contents discussed up to now are only for active replication.</strong> We have emphasized it many times in order to avoid confusion. What would be different in passive replication? We will talk about it now.</p>
<h2 id="Passive-Replication-Highlights"><a href="#Passive-Replication-Highlights" class="headerlink" title="Passive Replication Highlights"></a>Passive Replication Highlights</h2><p>We will only highlight the differences between these two replication schemes.</p>
<p>Let’s first recall the definition of passive replication: only one replica (<strong>primary replica</strong>) will in fact execute the requests and all other replicas (<strong>secondary replicas</strong>) will periodically get checkpointing from the primary one.</p>
<p>Under active replication style, the RM will send full membership info (i.e., information of all existing replicas) to all replicas and clients (we probably did not note this previously, but it is not late to say it now! ). However, in passive replication, <strong>the RM should send clients only the information of primary replica, while still send full membership information to all replicas</strong>. With this trick, our client will not (and should not) be aware of the current replication method: all it has to do is to just send requests to replicas that are included in the config info.</p>
<p>Wait, how can we determine who is the primary replica? It is similar to the proposer-acceptor pattern in active style: <strong>among all alive replicas, the one with the lowest rank number is always the primary replica.</strong></p>
<p>Now only the primary replica would be able to receive requests from clients. The process to handle a request from a client would also be simpler compared with the active replication method. When the request pool is not empty, the primary replica would also do the following:</p>
<ol>
<li>Get a request from request pool (in the order of time), assign a lid for this request and increment <code>nextProposeLid</code>;</li>
<li>Append these requestIds to the local log that it has;</li>
<li>Send <code>(lid, request)</code> to all secondary replicas. The primary replica would try to process this request only after receiving ACKs from all secondary replicas. Note that, for secondary replicas, instead of immediately processing requests from the primary replica, they will only store requests and states remain unchanged until checkpointing is conducted in the future;</li>
<li>Primary replica returns results to clients and proceeds to the next request.</li>
</ol>
<h2 id="Checkpointing"><a href="#Checkpointing" class="headerlink" title="Checkpointing"></a>Checkpointing</h2><p>We keep a really simple application in the system: each back system is in fact a list of accounts, and each account contains user id and balance. Making a checkpoint is in fact dumping a data structure into JSON data while parsing checkpoint reading JSON data.</p>
<h1 id="Web-UI"><a href="#Web-UI" class="headerlink" title="Web UI"></a>Web UI</h1><p>To monitor our system in a better way, we implement web UI for each component in our system. They might be naive and simple, but highly helpful.</p>
<p>To present the demo of the web UIs, we initialized a small system here which includes:</p>
<ol>
<li>One replication manager;</li>
<li>One global fault detector;</li>
<li>One local fault detector and two replicas under it;</li>
<li>Two independent clients.</li>
</ol>
<p>The web UIs would be able to provide some useful information of the system and you may as well perform some simple operations.</p>
<h2 id="GFD"><a href="#GFD" class="headerlink" title="GFD"></a>GFD</h2><p>As mentioned before, GFD will directly communicate with all local fault detectors (though we only have one in this case) and it also has the complete membership information (i.e., replicas in the system), and you are able to see all of these on the UI.</p>
<p>In addition, “Activity Log” will show the important events that GFD experienced. You can also set the fault detection interval, which can impact the recovery time if faults happens (but we will not discuss it here).</p>
<p><img src="gfd_ui.png" alt="gfd-ui"></p>
<h2 id="LFD"><a href="#LFD" class="headerlink" title="LFD"></a>LFD</h2><p>While the whole system is running, an LFD will keep monitoring the status of all replicas under its supervision. In our demo, there is one LFD which has two replicas. The web UI will show the last fault detection time (real-time) and IP address of all monitoring replicas.</p>
<p><img src="lfd_ui.png" alt="lfd-ui"></p>
<h2 id="RM"><a href="#RM" class="headerlink" title="RM"></a>RM</h2><p>The web UI of the replication manager would show information including current replication style (active or passive), information of all replicas, and IP address of all clients.</p>
<p>In “All Replicas” table, you will get each replica’s “Replica ID” and “Replica Rank”. Please note that the “Replica Rank” is the <code>replicaRank</code> we previously discussed, which will be used to determine which is the proposer (in active style) or primary replica (in passive style).</p>
<p>You can also set the checkpointing interval via the UI.</p>
<p><img src="rm_ui.png" alt="rm-ui"></p>
<h2 id="Replica-1"><a href="#Replica-1" class="headerlink" title="Replica"></a>Replica</h2><p>The web UI will show some information of one replica, including ID, IP address, replication style, status (NEW or READY), and a simple bank “database” (accounts and their balance). Checkpoint messages and total ordering messages are also showed.</p>
<p>If a replica is a proposer or primary replica, you are supposed to see “(Primary Replica)” in red color under “Replica ID”. Otherwise, it will show as “(Acceptor)” in black. The naming might be confusing and we apologize for it.</p>
<p>If the replica state is “NEW”, it means that the replica is still under synchronization. According to the “polite client assumption”, clients will not send any requests if any replica is under “NEW” state.</p>
<p>There are two kinds of checkpoint messages: “get” and “set”. “get” simply means the replica records its database into a checkpoint (JSON data) and store it locally; while “set” simply means one replica acquires checkpoint data from another replica and restores data from it.</p>
<p>An interesting part is “Total Order Messages”. All logs showed here have the following format:</p>
<pre><code>[message_order]:Transaction ([client_ID], [request_ID])</code></pre><p><code>message_order</code> is the order of the message decided by the proposer. The tuple <code>([client_ID], [request_ID])</code> is generated by the replica which sends this message; in other words, it acts as a unique ID of the request across the whole system.</p>
<p>The picture above shows the web UI of the proposer replica under active replication. Once the replica is started, it will first try to set a checkpoint from someone else (but it will not take any effects as it is the first one to start in the system). When another replica starts, it will ask the proposer for a checkpoint, so the proposer will “get” one and send it to the secondary replica. This is why you can see one “set” and one “get” in the proposer’s UI.</p>
<p><img src="r_active_1.png" alt="replica-active-primary"></p>
<p>Accordingly, you will only see one “set” on the second (acceptor) replica’s UI (see below). <strong>Please remember: in active replica, getting and setting checkpoints will only happen when a new replica appears.</strong></p>
<p><img src="r_active_2.png" alt="replica-active-second"></p>
<p>However, if we switch the replication style from active to passive, things would be different: primary replica will periodically get checkpoints and sent them to all other replicas, so primary replica will have a list of “get” checkpoint messages and other replicas will have a list of “set”; lists will keep growing as long as the system is still running. See the pictures below for a demo.</p>
<p><img src="r_passive_1.png" alt="replica-passive-primary"></p>
<p><img src="r_passive_2.png" alt="replica-passive-second"></p>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>For the web UI of clients, we used some elements from Bootstrap. The picture below is the main interface of this UI.</p>
<p><img src="client_main_ui.png" alt="client-main"></p>
<p>On the main interface you will see the system status: either <strong>“Ready for Request”</strong> or <strong>Service Not Available</strong>. Note that the status will be “Ready for Request” only when all replicas are under “READY” states.</p>
<p>You may also see a list of replicas. Please note that, under active style, all replicas will be listed here; while there will be only one replica (the primary one) under passive style. Thus, you might not know the current replication style just via this interface. In fact, this is what we want: the client should never care about the replica style. If we switch the replication style to passive (but still run 2 replicas), the client UI will be different:</p>
<p><img src="client_main_ui_passive.png" alt="client-main-passive"></p>
<p>We also show the most 20 logs on the UI. It shows all messages sent from this client and the response from corresponding replicas. Remember clients will always send a request to all replicas it knows (but, once again, it will only know the presence of primary replica under passive style).</p>
<p>You may also execute some basic operations on the bank account. Once you submit the operation, you will be directed to the main interface and the result (success or failure) of this operation will pop up here.</p>
<p>UI for “deposit”:<br><img src="client_deposit.png" alt="client_deposit"></p>
<p>Results of “deposit”:<br><img src="client_success.png" alt="client_return"></p>
<p>We also implemented a button “Start Testing” on the main UI, so a client can continuously send requests to replicas without manually clicking buttons. This feature is mainly used for testing.</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2019/11/29/socialnetwork/">Project: Social Network Data Visualization and Analysis Framework</a>
            <span class="archive-item-date">Nov 29, 2019</span>
            <!-- <span style=> <p><img src="0.png" alt="banner"></p>
<p>In this project we work as a team to design and implement an extensible data visualization and analysis framework, consisting of an interactive GUI tool and underlying interfaces and implementations.</p>
<p>Social media posts share people’s opinions, ideas and events in small pieces of content. The power that lies behind these posts are way more than they seem to be - they represent the trend of our daily life. What is going on in this world? What if we could analyze the social network post data in various dimensions, and demonstrate the trend visually in the form of graph, charts, and even more than that?</p>
<p>Our framework offers a feasible way to analyze social network posts data and query data based on user-defined requirements, as well as display the analysis result in multiple ways with extensible display plugins. Users may design and implement their own plugins, register them to the framework, and that’s it! Our framework will bring all together to you.</p>
<p>Across the project, we kept asking some questions to us:</p>
<ul>
<li>How can you guarantee extensibility and flexibility if you want to design and implement a framework that might be used by many people across different domains?</li>
<li>“Maximizing reuse minimizes use.” (<em>C. Szyoerski</em>) So how do you trade off between “use” and “reuse”?</li>
<li>Have you ever consider a proper name for your APIs?</li>
</ul>
<p>This team project is a course project at CMU, and <strong>it is selected as the “Best Framework”</strong> among all teams from the class.</p>
<p>Contributors: <a href="https://github.com/shengguan13" target="_blank" rel="noopener">Sheng Guan</a>, <a href="https://github.com/OpusA" target="_blank" rel="noopener">Qingyi Wang</a></p>
<p>(<strong>Note:</strong> due to the CMU academic integrity policy, the code of this project will not be publicized. If you are <strong>NOT</strong> taking this course currently <strong>AND</strong> you will <strong>NOT</strong> take this course in the future, please leave comments or contact me by e-mail in case you want more information.)</p>
<h2 id="Framework-Overview"><a href="#Framework-Overview" class="headerlink" title="Framework Overview"></a>Framework Overview</h2><h3 id="Plugins-and-Interfaces"><a href="#Plugins-and-Interfaces" class="headerlink" title="Plugins and Interfaces"></a>Plugins and Interfaces</h3><p>In order to use the framework, users need to design and implements two types of plugins: <em>data source plugin</em> and <em>display plugin</em>.</p>
<h4 id="Data-Source-Plugin"><a href="#Data-Source-Plugin" class="headerlink" title="Data Source Plugin"></a>Data Source Plugin</h4><p>Data source plugin is responsible for reading data from somewhere (e.g., web APIs, local JSON files) and process data into a specific data format. We have defined an interface <code>DataSourcePlugin</code> and each data source plugin <strong>MUST</strong> implement this interface. The interface contains the following methods that should be implemented:</p>
<p>(<strong>Note</strong>: due to the CMU academic integrity policy, this part cannot be publicized as it is a part of homework’s solution. If you are <strong>NOT</strong> taking this course currently <strong>AND</strong> you will <strong>NOT</strong> take this course in the future, please leave comments or contact me by e-mail in case you want more information about this part.)</p>
<h4 id="Display-Plugin"><a href="#Display-Plugin" class="headerlink" title="Display Plugin"></a>Display Plugin</h4><p>Display plugin is supposed to query data using our built-in functions in the framework and visualize the data in its own way. If users want to design a display plugin, it must implement the interface <code>DisplayPlugin</code>, which has following methods:</p>
<p>(<strong>Note</strong>: due to the CMU academic integrity policy, this part cannot be publicized as it is a part of homework’s solution. If you are <strong>NOT</strong> taking this course currently <strong>AND</strong> you will <strong>NOT</strong> take this course in the future, please leave comments or contact me by e-mail in case you want more information about this part.)</p>
<h4 id="Framework-Interfaces"><a href="#Framework-Interfaces" class="headerlink" title="Framework Interfaces"></a>Framework Interfaces</h4><p>Users do not need to know the implementation details of framework, but there are some highly helpful built-in methods provided by our framework that can be used in users’ customized plugins:</p>
<p>(<strong>Note</strong>: due to the CMU academic integrity policy, this part cannot be publicized as it is a part of homework’s solution. If you are <strong>NOT</strong> taking this course currently <strong>AND</strong> you will <strong>NOT</strong> take this course in the future, please leave comments or contact me by e-mail in case you want more information about this part.)</p>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><p>Once you run the program, you will see the main interface of our framework.</p>
<p><img src="1.png" alt="welcome-pic"></p>
<p>The left sidebar shows all registered plugins. You need to select ONLY one data source plugin and AT LEAST one display plugins.</p>
<p>Say now we select the “JSON File Data Plugin” and all display plugins, then click the button “Visualize”, a separate window will prompt asking for value of the parameter “File Path”, and you should enter the path of the JSON file.</p>
<p><img src="2.png" alt="param">  </p>
<p>Please note that multiple parameters might be asked. If we select “Twitter Search Plugin”, which accesses twitter official API, you are required to give values of multiple parameters.</p>
<p><img src="3.png" alt="param-2"><br>We choose the “JSON File Data Plugin” as the data source plugin and select all display plugins, then click “Visualize”. The dataset we use here contains about 5000 most recent tweets from Twitter (by 11/10/2019 11:59 PM).</p>
<p>As we use three display plugins, we could see three tabs on the right section of the main interface. The first one (see the picture below) is a bar chart plugin, which shows the top 20 popualr post entries (popularity is determned by sum of “Favorites” and “ReTweets”); it also lists the contents of the top 3 popular post entries.</p>
<p><img src="4.png" alt="analysis-res-1"></p>
<p>The second one is the “Word Cloud Plugin”, which shows the most frequent words across all post entries in the dataset. A word with a bigger font size also indicates higher frequency of appearance.</p>
<p><img src="5.png" alt="analysis-res-2"></p>
<p>Another display is “Pie Chart Plugin”. It categorizes all post entries by location (USA state), and shows the results in a pie chart. In addition, you can choose a US state and the plugin is able to show the top post from the state.</p>
<p><img src="6.png" alt="analysis-res-3"></p>
<p>The display plugins are highly informative as they might provide much information about your dataset that is processed by our framework.</p>
<p>For example, from the word cloud diagram, we found that the most frequent words are all politics-related (e.g., “impeachment”, “president”, “racists”, “voters”, …) and some of the words are strongly related with President Trump’s personal tweets (e.g., “great”, “democrat”, “treason”, “liar”, …). This observation is not surprising, as President Trump is famous for its speeches on Twitter and people are enthusiastic about making fun with his personal slogans.</p>
<p>It is also found, from the pie chart plugin, that most of the posts are from Southern or Central states in the USA (e.g., TX, FL, AZ, OH, …). It also corresponds to our assumptions that most of Trump’s supporters are from Southern and Central states and people who tweeted with “trump2020” are more likely to be Trump’s supporter.</p>
<p>The content above is only one example of plugins you can design and implement. You may also design you own ones: the only thing you have to do is to implement our pre-defined interfaces (<code>DataSourcePlugin</code> and <code>DisplayPlugin</code>) adn register them into our framework.</p>
<h2 id="Community-Support"><a href="#Community-Support" class="headerlink" title="Community Support"></a>Community Support</h2><p>This project was selected as one of the “Best Framework” in the CMU course 17514, and some other teams need to use our framework and implement their own plugins. In order to do this, we publicized the code to the whole class, wrote a detailed documentation, and continuously provided help and support through GitHub platform.</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2019/11/01/carcassonne-1/">Project: Carcassonne Game in Java</a>
            <span class="archive-item-date">Nov 1, 2019</span>
            <!-- <span style=> <p><img src="0.jpg" alt="game-pic"></p>
<p>In this individual project, the classical board game <a href="https://en.wikipedia.org/wiki/Carcassonne_(board_game)" target="_blank" rel="noopener">Carcassonne</a> is designed and implemented in Java.</p>
<p>The project contains a full cycle of software design and development, which means it also involves GUI design/implementation, testing and deployment.</p>
<p><strong>Note</strong>: due to the CMU academic integrity rules, the project codes cannot be publicized.</p>
<h2 id="Game-Overview"><a href="#Game-Overview" class="headerlink" title="Game Overview"></a>Game Overview</h2><p>Once you run the program, you will first be required to enter the number of players:</p>
<p><img src="1.png" alt="game-init"></p>
<p>You are required to enter names of all players. The number of players should be between 2 and 5 (both inclusive).</p>
<p>Say now we have three players: Alice, Bob, and Evil. Then we start the game.</p>
<p><img src="2.png" alt="game-start"></p>
<p>Below is the main interface of the game:</p>
<p><img src="3.png" alt="game-main"></p>
<p>In the real board game, there exists a deck and each player is supposed to get a tile from the top of the deck in turn, and then put the tile on the game board accordingly. We also simulate the real game experience through the GUI design:</p>
<ul>
<li><strong>Current Player</strong>: the player who is supposed to get a tile from the deck and put it on the game board;</li>
<li><strong>Current Tile</strong>: the tile on the top of the tile, which is assigned to the current player. It can be rotated (90 degree, clockwise) by clicking the button “Rotate Tile”;</li>
<li><strong>Action</strong>: action which the current player needs to take right now. It could be:<ul>
<li>“Please put a tile”: the player now should place the tile on the board. The tile may be rotated by the player. The “+” sign on the grid represents the positions that the tile can be placed on if the tile will not be rotated anymore;</li>
<li>“Please put a meeple”: the player now should put a meeple on the tile which is just previously placed on the board. Once a meeple is placed, a small solid circle is drawn on the board, in the same color of the player’s name. If a pattern is completed, meeples on that pattern will be revoked.</li>
<li>“Please skip putting a meeple”: if will happen if there are not any available positions, or the current players has no meeples right now. In this case, the player should click the button “Skipping Putting a Meeple” below to finish the current round.</li>
</ul>
</li>
<li><strong>Scores</strong>: real-time scores and number of available meeples for each player.</li>
</ul>
<p>Note it is also possible that a tile cannot be placed on any positions, even if it is rotated. In this case, simply click the button “Skip the Current tile” to drop the current tile and get the next tile.</p>
<p>The picture below is a screenshot of the main interface. The grid will automatically extend if necessary.</p>
<p><img src="4.png" alt="game-process"></p>
<p>Once all tiles are used (dropped or placed), the game is over, and the final ranking will appear on the sidebar.</p>
<p><img src="5.png" alt="game-over"></p>
<h2 id="Software-Design-and-Patterns"><a href="#Software-Design-and-Patterns" class="headerlink" title="Software Design and Patterns"></a>Software Design and Patterns</h2><p>In a Java project, it is highly important to use some suitable design patterns and some strategies, in consideration of robustness, flexibility and extensibility.</p>
<h3 id="Design-Goal"><a href="#Design-Goal" class="headerlink" title="Design Goal"></a>Design Goal</h3><p>The design goal in this project is to construct a comprehensive system that contains all concepts in the game and is able to execute all operations during the game. It should also correctly records the state of the game and return the correct results once the game is over.</p>
<p>As the game contains multiple objects, coupling between each object should be low, which may be helpful for debugging and implementation. Thus, each object should have clear responsibility and appropriate size of information, which should be helpful for implementation of algorithm in the future.</p>
<h3 id="Object-Model"><a href="#Object-Model" class="headerlink" title="Object Model"></a>Object Model</h3><p>(<strong>Note</strong>: due to the CMU academic integrity policy, this part cannot be publicized as it is a part of homework’s solution. If you are <strong>NOT</strong> taking this course currently <strong>AND</strong> you will <strong>NOT</strong> take this course in the future, please leave comments or contact me by e-mail in case you want more information about this part.)</p>
<h3 id="Hierarchy-and-structure"><a href="#Hierarchy-and-structure" class="headerlink" title="Hierarchy and structure"></a>Hierarchy and structure</h3><p>(<strong>Note</strong>: due to the CMU academic integrity policy, this part cannot be publicized as it is a part of homework’s solution. If you are <strong>NOT</strong> taking this course currently <strong>AND</strong> you will <strong>NOT</strong> take this course in the future, please leave comments or contact me by e-mail in case you want more information about this part.)</p>
<h3 id="Design-Highlights"><a href="#Design-Highlights" class="headerlink" title="Design Highlights"></a>Design Highlights</h3><p>(<strong>Note</strong>: due to the CMU academic integrity policy, this part cannot be publicized as it is a part of homework’s solution. If you are <strong>NOT</strong> taking this course currently <strong>AND</strong> you will <strong>NOT</strong> take this course in the future, please leave comments or contact me by e-mail in case you want more information about this part.)</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2019/04/21/shoppingweb/">Project: A Distributed and Auto-Scalable Online Shop Web Server</a>
            <span class="archive-item-date">Apr 21, 2019</span>
            <!-- <span style=> <img src="head.jpeg" alt="drawing" width="500"/>

<p>If you have ever get along with AWS EC2, you must know that the most critical feature it provides is load balancing, which is capable of automatically killing or launching machines (or VMs) according to the real-time metrics (e.g., CPU utilization). In this project, we also wanted to do something similar.</p>
<p>We implemented a distributed web server which can emulated online shopping (browse buy). The system consists of multiple tiers, and is able to scale in or out accordingly, depending on the current QPS.</p>
<p>Please note that it is a small project, and there is, in fact, no any real shopping applications, we as want to mainly pay attention to design and implementation of scalability and system hierarchy.</p>
<p>We also want you to keep in mind that:</p>
<ul>
<li>Though we talks about “servers” here, each server in fact is a process, which act as a VM and can easily be killed or launched.</li>
<li>You cannot by anything though our web :)</li>
</ul>
<h1 id="System-Hierarchy"><a href="#System-Hierarchy" class="headerlink" title="System Hierarchy"></a>System Hierarchy</h1><p>Refer to the picture below for the system, hierarchy:</p>
<p><img src="structure.svg" alt="hierarchy"></p>
<h2 id="Front-end-Server"><a href="#Front-end-Server" class="headerlink" title="Front-end Server"></a>Front-end Server</h2><p>The responsibility of front-end servers is to receive requests (but not process them). Thus, there should be something like “request pool” to store all requests. Who should be responsible for maintaining this “pool”? In order to do that, we also divided all front-end servers into 2 categories:</p>
<h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><p>The master front-end server is supposed to maintain a <strong><em>central queue</em></strong> which has all requests received by front-end servers. Please note, the master server itself will also receive requests, just like slave servers (explain below). There is only and at least one master in our system. Another critical feature for master server is that it also takes charges of scaling in/out, according to the length of central queue.</p>
<h3 id="Slave"><a href="#Slave" class="headerlink" title="Slave"></a>Slave</h3><p>Slave front-end servers have less workload compared to the master. It will only receive requests and push them into the central queue on master front-end servers. There might be multiple slave masters.</p>
<h2 id="Middle-end-Server"><a href="#Middle-end-Server" class="headerlink" title="Middle-end Server"></a>Middle-end Server</h2><p>Each middle-end server would continuously get a request from the master front-end server and process it with the cache. In addition, it will also detect whether scale-in or scale-out for middle-tier is necessary. If so, it would notify the master server to kill or launch middle-end servers accordingly.</p>
<h2 id="Cache-and-Database"><a href="#Cache-and-Database" class="headerlink" title="Cache and Database"></a>Cache and Database</h2><p>When it comes to database and cache, consistency appears to the top priority. While read-only operations might be executed on cache directly, write operations might cause more trouble as we have to go all the way to the database, and might have to invalidate some cache entries as well. It would become more complex and troublesome if there are multiple clients or caches in the system.</p>
<p>In this project, we will not do anything about database and cache, not to mention any consistency models. We only wrote a very simple interface to execute some operations on a cache. If you want to learn more about cache-related technologies, you may refer to my another post on distributed system and file caching. (If you do not see such a post, probably I am still working on it)</p>
<h1 id="Scalability"><a href="#Scalability" class="headerlink" title="Scalability"></a>Scalability</h1><h2 id="Middle-Tier"><a href="#Middle-Tier" class="headerlink" title="Middle Tier"></a>Middle Tier</h2><p>Scaling on middle tier is <strong>determined</strong> by middle-end servers and <strong>done</strong> by master front-end server.</p>
<h3 id="Scaling-Out"><a href="#Scaling-Out" class="headerlink" title="Scaling Out"></a>Scaling Out</h3><p>As we mentioned earlier, middle-end servers will continuously poll requests from master server. In fact, when it tries to get a request, it will also check the length of the central queue. If it detects a “too long” queue <strong>for consecutive two times</strong>, we will launch two more servers.</p>
<h3 id="Scaling-In"><a href="#Scaling-In" class="headerlink" title="Scaling In"></a>Scaling In</h3><p>Consider the case where this is no pending requests in the central queue. Now, a middle-end server cannot get a request, and it will wait until timeout. If there are three consecutive timeouts, master server will be notified to scale in by killing some servers.</p>
<h2 id="Front-Tier"><a href="#Front-Tier" class="headerlink" title="Front Tier"></a>Front Tier</h2><p>The number of front-end servers is dynamically adjusted by number of the middle-end servers. The master front-end server will check it when the number of middle-end servers change. By doing so, we can always keep an optimal ratio of front-end and middle-end servers, which is helpful in avoiding waste of resource.</p>
<h2 id="Benchmarking"><a href="#Benchmarking" class="headerlink" title="Benchmarking"></a>Benchmarking</h2><p>You may now be aware that we have many parameters in out system, and probably we need to conduct some experiments to determine the optimal values. That’s right. We need benchmarking and experiments to answer the following questions:</p>
<ol>
<li>What is the initial number for front-end server and middle-end server (based on the QPS)?</li>
<li>What is value of timeout when a middle-end server tries to get a request from the master?</li>
<li>What is the optimal ratio of front-end and middle-end servers? The optimal value might different under different load pattern.</li>
</ol>
<p>Designing an auto-scalable system is not only about algorithms and strategies. We also need to carefully study the load pattern and conduct some experiments to determine how we should tweak our system.</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2019/02/26/spark/">Project: Apache Spark - Process Large Web Crawl Data and Train ML Model</a>
            <span class="archive-item-date">Feb 26, 2019</span>
            <!-- <span style=> <img src="spark.png" alt="drawing" width="500"/>

<br>

<p>Apache Spark is an open source, distributed parallel computing framework, which is very powerful in processing and analyzing a large amount of data. It also has some additional advantages over MapReduce.</p>
<p>In this project, I will use Apache Spark to finish two tasks:</p>
<ol>
<li>Use Spark to preprocess an existing corpus crawled from the Internet to generate output in a specific format: extract, load, and transform (ELT).</li>
<li>Write a scalable distributed iterative ML program using Apache Spark.</li>
</ol>
<p>The two tasks listed above, in fact, seem not challenging at the first glance. Yes, you are right. By briefly studying the official documents and some example programs, you can finish the job easily. <strong>However, please consider some special requirements or scenarios before drawing any conclusions</strong>:</p>
<ul>
<li>There is an upper limit for the running time of the program. In other words, your program should preform efficiently in terms of time.</li>
<li>We have limited computing resources, i.e., memory, CPU cores, etc.</li>
<li>Program should be reliable and tolerant for failures (though Spark has some built-in mechanisms for fault-tolerance).</li>
</ul>
<p>You will gradually see that programming with Spark is never easy, especially when you wish your program has high performance.</p>
<p>Please note that, in this project, I also used HDFS and Amazon EC2 to manage our machines and distribute data/files, which, however, is not our focus, so I just exploited some existing framework/scripts for this part.</p>
<p style="color:#F13E3E"><b>Note</b>: due to the CMU academic integrity policy, some contents in this post are disabled as they are directly related to my codes or design. Please contact me or leave comments if you want to learn more about this project and <u><b>AND</b></u> will not take this course in the future!</p>

<h1 id="Preprocessing-with-Spark"><a href="#Preprocessing-with-Spark" class="headerlink" title="Preprocessing with Spark"></a>Preprocessing with Spark</h1><p>In this task, I was given an open repository of web crawled data (we only choose WET format file). These data should be processed following the steps below:</p>
<ol>
<li>Retrieve all documents (payloads) from some WET files with some third-party Python APIs; a WET file could be large and have many documents;</li>
<li>Discard all tokens that are not valid (e.g., invalid words contain characters rather than English letters and some simple characters);</li>
<li>Standardize all valid tokens from step 2 (including stripping away some invalid leading or tailing characters, convert all characters to lower-case, etc.);</li>
<li>Discard some documents whose length is lower than a limit;</li>
<li>Remove “stop” words (stop words refer to common words in English, e.g., “a”, “the” and domain-specific common words, which appear in more than 90% of all documents);</li>
<li>Remove typo words. Typo words can be identified by checking the number of documents that the word appears in. If the number is below a limit, we may treat this word as a typo.</li>
<li>sort all words by their lexicographical order and give them index number starting from 0.</li>
<li>Generate “word:count” pair for all words and computer statistic data of processed corpus.</li>
</ol>
<p>All steps listed above, in fact, do not require complex algorithms. You may find that we could parallelize some operations, e.g., discard invalid tokens, as each machine can independently finish this job. Some other operations may need <code>Reduce</code> operation, e.g., removing typo, as we have to know the document frequency of this word across the entire corpus.</p>
<p>But, what makes the program so slow?</p>
<h2 id="Performance-Analysis"><a href="#Performance-Analysis" class="headerlink" title="Performance Analysis"></a>Performance Analysis</h2><h3 id="Shuffle"><a href="#Shuffle" class="headerlink" title="Shuffle"></a>Shuffle</h3><p>Shuffle mechanism is used to redistribute the partitioned RDDs to satisfy certain conditions. For example, in order to detect domain-specific “stop” words, we need to count the document frequency of each word, which may require <code>reduceByKey</code> operations. <strong>Shuffle is an expensive operation.</strong> It normally requires a lot of disk IO and network IO costs. Also, each node (worker) will not be independent anymore, so one slow worker can make the whole process slow.</p>
<h3 id="Transformations-and-Actions"><a href="#Transformations-and-Actions" class="headerlink" title="Transformations and Actions"></a>Transformations and Actions</h3><p><a href="https://spark.apache.org/docs/latest/rdd-programming-guide.html#transformations" target="_blank" rel="noopener">Transformations</a> and <a href="https://spark.apache.org/docs/latest/rdd-programming-guide.html#actions" target="_blank" rel="noopener">actions</a> are different, and you should be aware of how they behave differently.</p>
<p>Note that, if there is no actions, Spark could record the dependency information between RDDs without evaluating them, which is called “lazy evaluation”. Thus, several distinct steps could be merged and be executed seamlessly. This is very helpful in boosting computing performance. Thus, do not invoke actions unless required.</p>
<h2 id="Ideas"><a href="#Ideas" class="headerlink" title="Ideas"></a>Ideas</h2><p>Here are some ideas I used for this task. They show great improvement in the performance.</p>
<h3 id="Reorder-the-Workflow"><a href="#Reorder-the-Workflow" class="headerlink" title="Reorder the Workflow"></a>Reorder the Workflow</h3><p style="color:#F13E3E">[Contents are disabled]</p>

<h3 id="Consider-Intermediate-Results"><a href="#Consider-Intermediate-Results" class="headerlink" title="Consider Intermediate Results"></a>Consider Intermediate Results</h3><p>This trick is super helpful and effective.</p>
<p>At first, let’s talk about a sorting algorithm. We all know “merge sort” algorithm, which divides the array into many smaller subarrays, sorts these subarrays then merges. It shows a principle called “divide and conquer”. <strong>This principle will give us some ideas in designing the program</strong>.</p>
<p style="color:#F13E3E">[Contents are disabled]</p>

<h3 id="Distribute-Workload-Evenly"><a href="#Distribute-Workload-Evenly" class="headerlink" title="Distribute Workload Evenly"></a>Distribute Workload Evenly</h3><p>If there is an action which needs <code>Reduce</code> and shuffle, the reducer needs to wait all mappers to finish their work before the reducer could start its job.</p>
<p>Is it possible that there is a mapper takes much longer to finish its job, which slow down the whole pipeline? In this case, some mappers might be idle and reducer cannot start its job either.</p>
<p>The answer is yes, and it is even highly possible. Suppose when we have 4 workers and 5 WET files. The first step is to initialize 5 RDDs (corresponding to 5 WET files) and distribute them to 4 workers. However, even under the best allocation strategy, there is always one worker who has 2 WET files to process. As we mentioned earlier, it may take a long time to process just a single WET file. Thus, we will expect a period of time when three workers are idle and one working (which is called “straggler”).</p>
<p>This poor strategy is highly possible to lead to waste of resources. Normally, if the size of RDD is smaller (and number of RDD increases), we are less likely to see a worker become the “straggler”. For example, we could make each document as a RDD partition. However, it also leads to more overhead which consumes storage and computing resources as well.</p>
<h2 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h2><p>To process 400 WET files (~200 GB) with 16 AWS <code>m4.xlarge</code> slaves instance, the original and naive program needs to take <strong>more than 3 hours</strong>, while the improved program (which used the tricks above) only takes <strong>within 35 minutes</strong>.</p>
<p>Though these tricks seem very intuitive and easy to implement, they might not come to your mind when you write Spark programs the first time. Spark in fact provides us with interactive and informative UIs, showing the real-time workflow and metrics of each worker. <strong>It is an important source for you to spot the bottleneck of your program and figure out a solution.</strong> We will talk about it at the end of this post.</p>
<h1 id="Iterative-ML-Model-Training"><a href="#Iterative-ML-Model-Training" class="headerlink" title="Iterative ML Model Training"></a>Iterative ML Model Training</h1><p>Remember what I said at the beginning of this post: Spark has some additional advantages over MapReduce. The most important features that Spark brings to us is <strong>in-memory processing</strong>.</p>
<p>This feature will be more prominent when the task is iterative: we may need to access or process the same data multiple times. Resilient Distributed Datasets (RDDs) enable multiple map operations in memory, while Hadoop MapReduce has to write interim results to a disk, which may involve some additional IO cost.</p>
<p>Thus, here comes the second task: given a lot of training data and multiple nodes (instances), how can we efficiently train our machine learning model in parallel. The ML model itself may has a large amount of features.</p>
<p>The ML model here is a simple logistic regression, and we are going to use gradient descent to update our model. This model starts with a random guess of the model feature weights and refines them over many iterations. In a single iteration, each data sample in the training set is processed to generate an incremental update to the model features. The model features updates are accumulated and not applied until the end of an iteration. <strong>This algorithm enables us to implement a training workflow which involves many nodes:</strong></p>
<ul>
<li>In an iteration, each node can compute and accumulate gradient independently;</li>
<li>The reducer can then accumulate updates from all mappers, get the final updates in the current iteration, update the feature weights, and broadcast new feature weights to all mappers;</li>
<li>Mappers start a new iteration.</li>
</ul>
<p>This workflow is really suitable for Spark: in each iteration, the nodes need to access the same training data and compute the gradient, as Spark can keep data in memory, nodes do not have to load data from disk through IO (this is what MapReduce does). The whole process would be much faster and more efficient.</p>
<p>However, some problem will appear when you are writing you program: sometimes your program will encounter out-of-memory issue and then crashes, or it has to take a long time to finish its job.</p>
<p>Compared with the first task, this task also forces you to figure out how you should manage the computing resources appropriately. Apparently, out-of-memory issue happens due to the exhaustion of memory. Is this because the memory stores too much data? Another question is, are there any other ways to make my program faster (in addition to the tips mentioned in the first task)?</p>
<p>No worry. I will summarize some useful tricks.</p>
<h2 id="Join-based-Parameters-Communication"><a href="#Join-based-Parameters-Communication" class="headerlink" title="Join-based Parameters Communication"></a>Join-based Parameters Communication</h2><p>As we mentioned earlier, the number of ML features may be huge (millions in this task). However, each data sample may not have so many nonzero values (probably only have tens of nonzero values). Also, processing each data sample only requires reading the weight values for its nonzero features and generating updates for its non-zero feature. Thus, <strong>a node does not need to get all feature weights from the ML model.</strong> This practice is critical in this project. In fact, trying to store a full copy of the weights or all updates on any of the machines will case failure: remember, memory is expensive and limited.</p>
<p>In order to take advantage of this feature, we might exploit some methods, such as inverted indices (which is popular in many area such as search engine) to design a better workflow.</p>
<h2 id="Ideas-1"><a href="#Ideas-1" class="headerlink" title="Ideas"></a>Ideas</h2><h3 id="A-Better-Workflow"><a href="#A-Better-Workflow" class="headerlink" title="A Better Workflow"></a>A Better Workflow</h3><p>We have mentioned that workflow is very important in implementing a Spark program. But, in the previous example, we just reordered some tasks to reduce the work load. For a different task, the workflow might be much harder to design or improve.</p>
<p style="color:#F13E3E">[Contents are disabled]</p>

<h3 id="Optimization-on-join"><a href="#Optimization-on-join" class="headerlink" title="Optimization on join"></a>Optimization on <code>join</code></h3><h4 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h4><p>When using <code>join</code> in your code, remember:</p>
<p><strong><em>When joining an RDD of N partitions with an RDD of M partitions, the resulting RDD may contain N*M partitions. You may want to explicitly control the number of partitions for the resulting RDD.</em></strong></p>
<p>So, if possible, remember to use some built-in APIs (e.g., <code>partitionBy</code>) to partition your RDDs again.</p>
<h4 id="Shuffle-1"><a href="#Shuffle-1" class="headerlink" title="Shuffle"></a>Shuffle</h4><p>Shuffle in always expensive and “join” operation may also involve shuffle. However, <strong><em>When two RDDs are already partitioned by the same function, joining them does not require a shuﬄe</em></strong>.</p>
<p>Why? And what does this indicate?</p>
<p>In fact, every time we create RDDs, we need to use some partitioner function to partition data and distribute data on all nodes. If two RDDs have the same partitioner functions, it indicate that data entries with same key will also reside on the same node; nodes then does not need to communicate with nodes to do “join”, which leads to shuffle.</p>
<p>The default partitioner function is hash function. But how can you make sure two RDDs have the same partitioner function?</p>
<p>There are many possible cases where partitioner functions are changed. But the most important one is: <strong><em>if you applied any custom partitioning to your RDD (e.g. using <code>partitionBy</code>), using <code>map</code> or <code>flatMap</code> would “forget” that partitioner function.</em></strong> This is because Spark cannot know if the key is changed after <code>map</code>. Instead, <code>mapValues</code> is better as you could only change the value with this function.</p>
<p><strong>A caveat</strong>: always choose <code>mapValues</code> or <code>flatMapValues</code> if you don’t intend to change the key.</p>
<h3 id="Manage-Your-Resources"><a href="#Manage-Your-Resources" class="headerlink" title="Manage Your Resources"></a>Manage Your Resources</h3><p>You may see some out-of-memory (OOM) issue when running your spark program. This is because Spark by default will keep RDD in memory, when we need to create another RDD (by some action), they will also be placed in memory. E.g., in this task, we need to maintain a training data RDD while generating the updates RDD. What if the memory is limited?</p>
<p style="color:#F13E3E">[Contents are disabled]</p>

<h3 id="Find-the-Bottleneck"><a href="#Find-the-Bottleneck" class="headerlink" title="Find the Bottleneck"></a>Find the Bottleneck</h3><p>Spark gives you the live monitoring web UI to help you track the task and find the bottleneck.</p>
<p>Normally, the first thing to check is <strong>job</strong>. Clicking a job shows the details of this job, including its event timeline and a DAG visualization. You can easily figure out which operations belong to which stage and the locations where shuffle occurs.</p>
<p>The web UI also shows statistics/metrics for tasks. You may also access status of each machine and check if any nodes are dead already. You can also detect any stragglers by checking the task numbers of each machine from the web UI.</p>
<h2 id="Benchmark-1"><a href="#Benchmark-1" class="headerlink" title="Benchmark"></a>Benchmark</h2><p>The improved program could finish 2 iterations within 30 mins with 40GB Criteo dataset as training data (ML model with 88M features) on AWS 16 <code>c4.xlarge</code> instances; or 4 iterations within 40 mins with 10 GB KDD2012 dataset (ML model with 54M features) on 16 <code>c4.xlarge</code> instances.</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2019/02/01/rpc/">Project: A Distributed System with Multiple RPCs and File Fetching Cache</a>
            <span class="archive-item-date">Feb 1, 2019</span>
            <!-- <span style=> <img src="rpc.png" alt="drawing" width="500"/>

<p>You may have seen many awesome and outstanding distributed systems which work for some real-life applications. Today, we will go all to the way to the system level and see how distributed computing could be implemented here.</p>
<p>This project consists of two tasks:</p>
<ol>
<li>build an RPC system to allow remote file operations (<code>open</code>, <code>read</code>, <code>write</code>, …); these RPC stubs will be interposed in place of the C library functions that handle file operation. For example, if you execute <code>cat foo</code> command on the local machine, instead of opening and printing the contents of a local file, it will access the contents of file <code>foo</code> on the remote server machine.</li>
<li>based on the task 1, a proxy containing a cache should be implemented and placed between the clients and the server. Multi-clients and multi-proxy will be supported. You should also exploit some cache policies and strategies to guarantee consistency.</li>
</ol>
<p><font color="#F13E3E">Due to the CMU academic integrity policy, the code will not be publicized and some contents in this post will also be disabled as there are directly related to the design of my solution. </font></p>
<h1 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h1><p>It is very common for us to access resources located on remote machines. We may easily write some applications to use the network to communicate between different components running on different machines, which, however, is tedious and inelegant to insert ad-hoc networking code every place our software needs to access remote resources.</p>
<p>Instead, we could implement remote procedure calls to hide the network complexities and to access the remote resources in a clean abstraction. Users of these RPCs will not need to care anything on networking, and they could also develop more applications on the top of them.</p>
<h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><p>The purpose of this task is to enable clients to use some commands (such as <code>cat</code>, <code>ls</code>) to access files on remote machine. In order to do this, we need to rewrite the standard C library calls and replace the original ones:</p>
<pre><code>open, close, read, write, lseek, stat, unlink, getdirentries</code></pre><p>We will also implement the non-standard calls <code>getdirtree</code> and <code>freedirtree</code>. The course will provide us a library containing these two functions.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct dirtreenode* <span class="title">getdirtree</span><span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *path )</span></span>;</span><br></pre></td></tr></table></figure>
<p>Function <code>getdirtree</code> recusively descend through directory hierarchy starting at directory indicated by path string. Allocates and constructs directory tree data structure representing all of the directories in the hierarchy.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freedirtree</span><span class="params">( struct dirtreenode* dt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>Function <code>freedirtree</code> recursively frees the memory used to hold the directory tree structures, including the name strings, pointer arrays, and <code>dirtreenode</code> structures.</p>
<p>These two function enables you to use <code>tree</code> on the terminal which will print out the file tree structure on the terminal. The library only makes sure you can execute the command locally, and we need to implement a RPC for it.</p>
<h2 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h2><p>This task will be completed in C, so it may involve some basic practice on memory management, networking programming (we use TCP here) and some file operations. In addition, we also need to design some protocols.</p>
<h3 id="Serialization-and-Deserialization"><a href="#Serialization-and-Deserialization" class="headerlink" title="Serialization and Deserialization"></a>Serialization and Deserialization</h3><img src="serial.png" alt="drawing" width="600"/>

<p>The picture below shows what will happen once a RPC is called. We need to design how should we:</p>
<ol>
<li>pack RPC name and corresponding parameters into a string (serialization on client side) and send it to server;</li>
<li>unpack RPC name and parameters, call corresponding local function, get results, pack results into a string and send back to client (deserialization and serialization on server side);</li>
<li>unpack results from server and show locally.</li>
</ol>
<p>Due to CMU academic policy, we will not discuss any detail on these protocols. Please note that you may need some a little bit more complicated algorithm when dealing with <code>getdirtree</code>, as we have to serialize a tree structure into a string and deserialize from a string.</p>
<h3 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h3><p>We must handle the situation where multiple clients are accessing to a single remote machine. A simple solution is using the multi-process mode. Each client will be handled in a specific child process, which has its own file descriptor table and will not conflict with other clients’ FD tables.</p>
<h3 id="Local-and-Remote-File-Descriptor"><a href="#Local-and-Remote-File-Descriptor" class="headerlink" title="Local and Remote File Descriptor"></a>Local and Remote File Descriptor</h3><p>a very subtle but important problem is, for client, how can we distinguish between the local and remote file descriptor.</p>
<p>You may ask, why we have to do this? <strong><em>This is because some programs on the client still needs to access local resources.</em></strong> For example, a client opens a remote file and the FD is <code>3</code> (this is created by the remote machine) and a local file, which returns a FD <code>3</code> as well. In this case, if we continue some file operations such as <code>read</code>, we don’t know which file we exactly need to read. Thus, there must be a mechanism to tell the origin of the FD (i.e., it is from local or remote).</p>
<p style="color:#F13E3E">[Contents are disabled]</p>

<h1 id="File-Cache"><a href="#File-Cache" class="headerlink" title="File Cache"></a>File Cache</h1><p>In the previous task, we already have a simply distributed system, where clients and servers could communicate via RPCs. Now, we will design and implement a cache in Java between these two components.</p>
<p>Caching is a great technique for improving the performance of a distributed system. It can help reduce data transfers, and improve the latency of operations. This task will continue to use existing binary tools in task 1 and interpose on their C library calls. Instead of directly connecting the server, clients now will only access the proxy (which contains a cache) to execute some operations:</p>
<img src="cache.jpg" alt="drawing" width="500"/>

<br>

<p>Seems easy, right? Well, let’s talk about some details on requirements.</p>
<h2 id="Requirements-1"><a href="#Requirements-1" class="headerlink" title="Requirements"></a>Requirements</h2><p>Here are something we need to consider through this task.</p>
<ol>
<li><strong><em>Cache policy</em></strong>. Remember that a cache always have limited space, so we need to evict some cache entries under a policy we design;</li>
<li><strong><em>Concurrency</em></strong>. The system must support multiple proxies and clients running simultaneously (especially when there are many writers);</li>
<li><strong><em>Consistency</em></strong>. We have to make sure clients will not get stale contents;</li>
<li><strong><em>Atomicity</em></strong>. If one client opens a client, it should be interrupted by other clients accessing the same file. In other words, clients will have a fixed view during the open-close session.</li>
</ol>
<h2 id="Design-1"><a href="#Design-1" class="headerlink" title="Design"></a>Design</h2><h3 id="LRU-policy"><a href="#LRU-policy" class="headerlink" title="LRU policy"></a>LRU policy</h3><p>We will use a “Least Recently Used” policy to decide which cache entries should be evicted when the cache is full.</p>
<p style="color:#F13E3E">[Contents are disabled]</p>

<h3 id="Concurrency-1"><a href="#Concurrency-1" class="headerlink" title="Concurrency"></a>Concurrency</h3><p>Some Java built-in libraries could be exploited to make data safe in concurrent condition. In addition, we always ensure there is only reader instance and multiple writer instances: multiple readers can read a single reader instance but each writer needs an exclusive writer instance. How can we achieve that?</p>
<p style="color:#F13E3E">[Contents are disabled]</p>

<h3 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h3><p>We will exploit an idea called “check on use” to make sure that the clients will not get stale contents. Specifically speaking, every time a client wants to read some contents from the proxy (cache), the proxy needs to connect the server and verify if the contents are most recent. In addition, if a client writes something new to a file (on proxy), the proxy should also make the changes on server side as well.</p>
<p style="color:#F13E3E">[Contents are disabled]</p>


<h3 id="Open-close-Semantics"><a href="#Open-close-Semantics" class="headerlink" title="Open-close Semantics"></a>Open-close Semantics</h3><p>Once a client opens a file, the client should have a fixed view of the file before “close”, though some other clients are reading or writing this file at the same time. How can we achieve that?</p>
<p style="color:#F13E3E">[Contents are disabled]</p>
</span> -->
        </article>
    
        

        
            <h1>2018</h1>
        

        <article class="archive-item">
            <a class="archive-item-link" href="/2018/12/05/searchengine/">Project: A Text-based Multi-model Search Engine</a>
            <span class="archive-item-date">Dec 5, 2018</span>
            <!-- <span style=> <p>Below is a brief summary of this project:</p>
<ul>
<li>Implemented a text-based large-scale search engine with Lucene API on corpus of 500,000+ documents.</li>
<li>Supported multiple retrieval models (unranked/ranked Boolean, Okapi BM25, Indri) and multiple operators.</li>
<li>Realized pseudo-relevance feedback that smartly expands original queries to improve retrieval performance.</li>
<li>Exploited machine learning ideas to implement Learning-to-Rank by calling SVMrank to train retrieval model.</li>
<li>Enhanced diversity of search results by implicitly/explicitly considering multiple intents in the retrieval results.</li>
</ul>
</span> -->
        </article>
    
    

</div>

</div>



        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Yihang (Ian) Ding | Powered by <i><a href="https://hexo.io" target="_blank">Hexo</a></i> & <i><a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></i></span>
    </div>
</footer>

    </div>
</body>
</html>
