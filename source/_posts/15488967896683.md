# RPC Design Protocol
by Yihang Ding (andrew ID: yihangd)
### Serialization and Deserialization
When one client conducts one RPC, all parameters, along with the RPC name, will be packed into a package in the following format

    ${rpc_name} ${para_1} ... ${para_n}\n

for package without payload data (e.g., `read`, `getdirtree`), where each parameter is separated by a whitespace. If payload data has to be included (e.g., `write`), the following format would be applied,

    ${rpc_name} ${para_1} ... ${para_n} ${payload_size}\n${payload_data}

where the payload data is separated from the header using a `\n`. Once the server receives and parses this package, it would execute the corresponding function and pack all execution results in the following format

    ${package_size} ${res} ${error}\n
    
if there is no payload data, or the format

    ${package_size} ${res} ${error} ${payload_size}\n${payload_data}
    
if there exists payload data. The `${package_size}` is the size of a part of the package that starts from `${res}`. `${res}` is the returned value of the original function and `&{error}` represents the `errno` after invocations of RPC.

The tree is also serialized in the following format,

    ${node_num}
    ${node1_label} ${node1_name} ${node1_num_subdirs}
    ${node2_label} ${node2_name} ${node2_num_subdirs}
    ...

where `${node_num}` is the total number of node in the tree; each node is represented by its label (which helps find its parent node for deserialization), its name and its number of sub directories. For example, the label of root node is always `0`, and the child nodes of root node have labels `0-0`, `0-1`, `0-2`, ... and so on.

### Concurrency and File Descriptor

To handle concurrent requests from multiple clients, I exploit multiple-process method, by simply creating a new child process using `fork()` to handle requests from one specific client. In this case, each client has its own file descriptor table on server (supported by its corresponding child process), which also introduces isolation among other clients.

To distinguish the locally given file descriptors and the remotely given file descriptor, a offset number `FD_SHIFT` is introduced: for example, if the server opens a file and gives the file descriptor `3`, the corresponding file descriptor on the client side would be `3 + FD_SHIFT`. With it, it will be easy for clients to tell the origin of file descriptors.

