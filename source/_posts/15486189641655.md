# 2. Xen and the Art of Virtualization

- **Xen**: an x86 virtual machine monitor which allows multiple commodity operating systems to share hardware in a safe and resource managed fashion.
- **target here**: host up to 100 virtual machine instances simultaneously on a modern server.

## VM technology: an overview

- **definition**: partitioning of a machine to support the concurrent execution of multiple operating systems
- **challenges**: 
    - isolation
    - to support different OS
    - performance overhead
- **One problem**: how to build a system to host multiple application? multiplexes physical resources at the granularity of an entire operating system and is able to provide performance isolation between them. But in this case, need to run a full operating system, which requires more cost (such cost is needed).

## Xen

### Overview

- **full virtualization**: use unmodified operating systems, but has some drawbacks.
- **paravirtualization**: avoid the drawbacks of full virtualization by presenting a virtual machine abstraction that is similar but not identical to the underlying hardware. It needs to modify the OS more.
- **Compare to Denali**: 
    - Denali does not target existing ABIs;
    - Denali only supports a single-user single application OS
    - Denali performs all paging to and from disk because of lack of memory management.
    - in Denali, VM has no access to physical addresses.

### VM interface

- **Three parts**: memory management, CPU, device I/O
- **Memory management**:  
    - easier to do with software managed TLB or tagged TLB, but in x86 there is no: need to flush the entire TLB when switching address space
    - **1** guest OSs are responsible fro allocating and managing the hardware page table **2** Xen exists in a 64MB section at the top of every address space
    -  Each time a guest OS requires a new page table, perhaps because a new process is being created, it allocates and initializes a page from its own memory reservation and registers it with Xen.
- **CPU**:
    - OSes must be modified to run at a lower privilege level
    - 4 rings: 0-3. Ring 0 for OS code while 3 for application; Guest OS executes in ring 1 to avoid directly executing privileged instructions
    - Only Xen executes at a sufﬁciently privileged level
    - A table describing the handler for each type of exception is registered with Xen for validation.
    - but page fault will always be delivered via Xen 
- **Device I/O**:
    - a set of clean and simple device abstractions: I/O data is transferred to and from each domain via Xen

### porting an OS to Xen

Less modification to Linux than XP

### control and management

![-w596](media/15486189641655/15486271229214.jpg)

- Domain 0: responsible for hosting the application-level management software (control interface): allows convenient management of the entire server:

## Design

### Control transfer: hypercalls and events

Two mechanisms exist for control interactions between Xen and an overlying domain: 
1. synchronous calls from a domain to Xen may be made using a hypercall;
2. notiﬁcations are delivered to domains from Xen using an asynchronous event mechanism.

### Data transfer

- Two main mechanisms: resource management and event notification
- I/O descriptor rings

### subsystem virtualization

-

#### CPU Scheduling

Borrowed Virtual Time (BVT) scheduling algorithm due to **low latency dispatch**

#### Time and timers

- notion of real time and virtual time
- **Real time** is expressed in nanoseconds passed since machine boot and is maintained to the accuracy of the processor’s cycle counter and can be frequency-locked to an external time source
- **Virtual time** only advances while it is executing

#### virtual address translation


#### Physical memory

#### Network

#### Disk

### Building a New Domain

delegated to Domian0: access the new domain's memory and inform Xen of initial register state (**NOT** build it totally within Xen), which may **provide much richer diagnostics and debugging support**

## Evaluation

- Xen signiﬁcantly outperforms ESX Server.

- the performance of XenoLinux over Xen is practically equivalent to the performance of the baseline Linux system.


 