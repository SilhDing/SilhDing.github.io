<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Yihang (Ian) Ding">


    <meta name="subtitle" content="Glad you reach here.">




<title>Archives: 2020/4 | Yihang&#39;s Blog</title>



    <link rel="icon" href="/favicon.png">


<link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,700|Noto+Serif+KR:300,700|Source+Code+Pro:400,400i,700,700i&display=swap" rel="stylesheet">



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
            <a href="/">楽しんでね。| Yihang&#39;s Nest</a>
            </div>

            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">✐  Post</a>
                
                    <a class="menu-item" href="/category">➭  Category</a>
                
                    <a class="menu-item" href="/tag">✰  Tag</a>
                
                    <a class="menu-item" href="/about">❐  Résumé</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">楽しんでね。| Yihang&#39;s Nest</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">✐  Post</a>
                
                    <a class="menu-item" href="/category">➭  Category</a>
                
                    <a class="menu-item" href="/tag">✰  Tag</a>
                
                    <a class="menu-item" href="/about">❐  Résumé</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>

        <div class="main">
            <div class="post-wrap archive">
	<h1> ✐ | Post </h1>
</div>
<div class="post-wrap archive">
    
    
        

        
            <h1>2020</h1>
        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/18/string-algorithm/">Algorithms Case Study: String</a>
            <span class="archive-item-date">Apr 18, 2020</span>
            <!-- <span style=> <p>In this post, we want to study and summarize some well-known algorithms for Strings.</p>
<h2 id="String-Sorts"><a href="#String-Sorts" class="headerlink" title="String Sorts"></a>String Sorts</h2><h3 id="LSD"><a href="#LSD" class="headerlink" title="LSD"></a>LSD</h3><p>If we want to sort some items and each item is associated with a key (or ID). We could use <em>key-indexed</em> counting to sort, which is very efficient. This method also indicates that we could follow the same idea to sort <strong>fixed-length</strong> strings, which is called <strong><em>least-significant-digit first (LSD)</em></strong> sort.</p>
<p>The basic idea is to conduct key-indexed counting for w times, where w is the length of each string.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LSD</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a, <span class="keyword">int</span> W)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// W is the length of each string in a</span></span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        String[] aux = <span class="keyword">new</span> String[N];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> d = W - <span class="number">1</span>; d &gt;= <span class="number">0</span>; d--) &#123;</span><br><span class="line">            <span class="comment">// Sort by key-indexed counting on dth char.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span>[] count = <span class="keyword">new</span> <span class="keyword">int</span>[R+<span class="number">1</span>];</span><br><span class="line">            <span class="comment">// Computer frequency counts.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                count[a[i].charAt(d) + <span class="number">1</span>] ++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Transform counts to indices.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> r = <span class="number">0</span>; r &lt; R; r++) &#123;</span><br><span class="line">                count[r+<span class="number">1</span>] += count[r];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Distribute.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                aux[count[a[i].charAt(d)]++] = a[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Copy back.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                a[i] = aux[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] a  = &#123;<span class="string">"43FRFN"</span>, <span class="string">"423FFE"</span>, <span class="string">"D439JN"</span>, <span class="string">"10NE2E"</span>,</span><br><span class="line">                        <span class="string">"DDERFR"</span>, <span class="string">"340FEW"</span>, <span class="string">"104FDS"</span>, <span class="string">"R4053N"</span>&#125;;</span><br><span class="line">        LSD.sort(a, <span class="number">6</span>);</span><br><span class="line">        System.out.println(Arrays.toString(a));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Time complexity: <code>O(W(N + R))</code>, where <code>N</code> is the number of all string to be sorted, <code>R</code> is the radix (number of characters in alphabet) and <code>W</code> is the width of each string.</p>
<p>Space complexity: <code>O(N + R)</code>, as we use two additional arrays.</p>
<p>Remember that there are some requirements when applying this method:</p>
<ol>
<li>Each string has the same length (certainly we can modify this method to accommodate this case, but we have other algorithms that work well for this scenario);</li>
<li>We know the radix of the alphabet of these strings (in this case, 256).</li>
</ol>
<h3 id="MSD"><a href="#MSD" class="headerlink" title="MSD"></a>MSD</h3><p>LSD algorithm listed above only works for fix-length strings. Here we want to implement an algorithm that works for a general purpose: <em>most-significant-digit-first (MSD)</em>.</p>
<p>We still follow the basic idea of key-indexed counting to complete this algorithm. Now, as the algorithm’s name indicates, we will start sorting based on the most significant digits. So, if we have sorted them based on the first digit, what should we do next? <strong>We can group (or split) these strings and sort in each group based on other digits,</strong> which requires a recursive algorithm.</p>
<p>Remember, this algorithm does not require all strings with same length. What should we do if, in a group, there are string which are shorter than others and we have reached the end of these short strings during key-indexed counting? Okay, we know that shorter strings here should be sorted first, so here is the solution:</p>
<p>Implement a new <code>toChar()</code> method that can convert from an indexed string character to an array index that returns -1 if the specified character position is pass the end of the string. Then, we just add 1 to each returned value, so get a nonnegative <code>int</code> that we can use to index <code>count[]</code>. It means we have <code>R+1</code> possible character values at each string position:</p>
<ul>
<li><code>0</code> to signify the end of the string;</li>
<li><code>1</code> for the first alphabet character;</li>
<li><code>2</code> for the second alphabet character;</li>
</ul>
<p>With all these practices above, now it is easy to write down the real code.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MSD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> R = <span class="number">256</span>;  <span class="comment">// radix</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> M = <span class="number">0</span>;  <span class="comment">// cutoff for small subarrays</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] aux; <span class="comment">// auxiliary array for distribution</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        aux = <span class="keyword">new</span> String[N];</span><br><span class="line">        sort(a, <span class="number">0</span>, N-<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Cut-off if the number of string is too small</span></span><br><span class="line">        <span class="keyword">if</span> (lo + M &gt;= hi) &#123;</span><br><span class="line">            Insertion.sort(a, lo, hi, d);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] count = <span class="keyword">new</span> <span class="keyword">int</span>[R+<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// Compute frequency counts.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt;= hi; i++) &#123;</span><br><span class="line">            count[charAt(a[i], d) + <span class="number">2</span>] ++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Transform counts to indices.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; R +<span class="number">1</span>; i++) &#123;</span><br><span class="line">            count[i+<span class="number">1</span>] += count[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Distribute.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt;= hi; i++) &#123;</span><br><span class="line">            aux[count[charAt(a[i], d) + <span class="number">1</span>]++] = a[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Copy back.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt;= hi; i++) &#123;</span><br><span class="line">            <span class="comment">// Consider why i - lo here: because we only sort hi- lo + 1 strings, starting with index 0 in aux</span></span><br><span class="line">            a[i] = aux[i - lo];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Recursive call: process to the next d for each split</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> r = <span class="number">0</span>; r &lt; R; r++) &#123;</span><br><span class="line">            sort(a, lo + count[r], lo + count[r+<span class="number">1</span>] - <span class="number">1</span>, d + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">charAt</span><span class="params">(String s, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; s.length())</span><br><span class="line">            <span class="keyword">return</span> s.charAt(index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] a = &#123;<span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"seashells"</span>, <span class="string">"by"</span>, <span class="string">"the"</span>, <span class="string">"sea"</span>,</span><br><span class="line">                        <span class="string">"shore"</span>, <span class="string">"the"</span>, <span class="string">"shells"</span>, <span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"are"</span>, <span class="string">"surely"</span>, <span class="string">"seashells"</span>&#125;;</span><br><span class="line">        sort(a);</span><br><span class="line">        System.out.println(Arrays.toString(a));</span><br><span class="line">        String[] b = &#123;<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>,<span class="string">"aaaaaa"</span>&#125;;</span><br><span class="line">        sort(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that we add a “cutoff-for-small-subarrays” before the sort really begins. why do we need this?</p>
<p>As we can see, the method quickly divides the array to be sorted into small subarrays. But this is also a double-edged sword: we are certain to have to handle huge numbers of tiny subarrays, so we had better be sure that we handle them efficiently. Each sort involves initializing the 258 (if <code>R = 256</code>) entries of the <code>count[]</code> array to <code>0</code> and transforming them all to indices. Accordingly, the switch to insertion sort for small subarrays is a must for MSD string sort (in the code I simply use a <code>Insertion.sort()</code> for this part).</p>
<p>Please also note another pitfall of MSD sort algorithm: it can be relatively slow for subarrays containing large numbers of equal keys. <strong><em>The worst case for MSD string sorting is when all key are equal</em></strong>: the algorithm cannot make smaller subarrays after each iteration (d). In this case, out program will have to examine every character in all input strings, and the running time is linear in the number of characters in the data (like LSD string sort).</p>
<p>In many cases, we should treat the input strings are randomly generated. In this case, MSD string sort examines just enough characters to distinguish among the keys, and the running time is sub-linear in the number of characters in the data.</p>
<h3 id="Three-way-string-quicksort"><a href="#Three-way-string-quicksort" class="headerlink" title="Three-way string quicksort"></a>Three-way string quicksort</h3><p>This algorithm borrows the idea from quick sort.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quick3string</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a)</span> </span>&#123;</span><br><span class="line">        sort(a, <span class="number">0</span>, a.length - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(String[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (lo &gt;= hi) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> lt = lo, gt = hi;</span><br><span class="line">        <span class="keyword">int</span> i = lo + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> v = charAt(a[lo], d);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt;= gt) &#123;</span><br><span class="line">            <span class="keyword">int</span> t = charAt(a[i], d);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (t &lt; v) exch(a, lt++, i++);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (t &gt; v) exch(a, i, gt--);</span><br><span class="line">            <span class="keyword">else</span> i ++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sort(a, lo, lt - <span class="number">1</span>, d);</span><br><span class="line">        <span class="keyword">if</span> (v &gt;= <span class="number">0</span>) sort(a, lt, gt, d + <span class="number">1</span>);</span><br><span class="line">        sort(a, gt + <span class="number">1</span>, hi, d);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">charAt</span><span class="params">(String s, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; s.length())</span><br><span class="line">            <span class="keyword">return</span> s.charAt(index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exch</span><span class="params">(String[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        String tmp = a[i];</span><br><span class="line">        a[i] = a[j];</span><br><span class="line">        a[j] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] a = &#123;<span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"seashells"</span>, <span class="string">"by"</span>, <span class="string">"the"</span>, <span class="string">"sea"</span>,</span><br><span class="line">                <span class="string">"shore"</span>, <span class="string">"the"</span>, <span class="string">"shells"</span>, <span class="string">"she"</span>, <span class="string">"sells"</span>, <span class="string">"are"</span>, <span class="string">"surely"</span>, <span class="string">"seashells"</span>&#125;;</span><br><span class="line">        sort(a);</span><br><span class="line">        System.out.println(Arrays.toString(a));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This algorithm will always partition the array into three subarrays, which is different from MSD as MSD might generate many subarrays and many of them might be small or even empty subarrays. It can adapt well to handling equal keys, keys with long common prefixes. <strong>It will not use extra space, just like quick sort</strong>.</p>
<p>An interesting fact will be found when you try to compare this algorithm with standard quicksort. Indeed, one way to think 2-way string quick sort is <strong><em>as a way for standard quicksort to keep track of leading characters that are known to be equal</em></strong>. Note: no algorithm can beat 3-way string quicksort by more than a constant factor.</p>
<h2 id="Tries"><a href="#Tries" class="headerlink" title="Tries"></a>Tries</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrieSTNew</span>&lt;<span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Object val;</span><br><span class="line">        <span class="keyword">private</span> Node[] next = <span class="keyword">new</span> Node[R];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When finding the node, we use recursion rather than iteration.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Value <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Node node = get(root, key, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> (Value) node.val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">get</span><span class="params">(Node x, String key, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Return value associated with key in the subtrie rooted at x.</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Remember, right now we are at the node corresponding to char at index d-1</span></span><br><span class="line">        <span class="keyword">if</span> (d == key.length()) <span class="keyword">return</span> x;</span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        <span class="keyword">return</span> get(x.next[c], key, d + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, Value value)</span> </span>&#123;</span><br><span class="line">        root = put(root, key, value, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">put</span><span class="params">(Node x, String key, Value value, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) x = <span class="keyword">new</span> Node();</span><br><span class="line">        <span class="comment">// Remember, right now we are at the node corresponding to char at index d-1</span></span><br><span class="line">        <span class="keyword">if</span> (d == key.length()) &#123;</span><br><span class="line">            x.val = value;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        x.next[c] = put(x.next[c], key, value, d + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		TrieSTNew&lt;Integer&gt; trie = <span class="keyword">new</span> TrieSTNew&lt;&gt;();</span><br><span class="line">		trie.put(<span class="string">"dede"</span>, <span class="number">0</span>);</span><br><span class="line">		trie.put(<span class="string">"de"</span>, <span class="number">0</span>);</span><br><span class="line">		trie.put(<span class="string">"deeffe"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String str: trie.keys()) &#123;</span><br><span class="line">			System.out.print( str+<span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		System.out.println(trie.root);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Collecting-keys"><a href="#Collecting-keys" class="headerlink" title="Collecting keys"></a>Collecting keys</h3><p>Now, we are going to implement some methods for collecting keys. The above code contains some basic operations including <code>get</code> and <code>put</code>. Now we will continue to implement some method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> keysWithPrefix(<span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">keysWithPrefix</span><span class="params">(String pre)</span> </span>&#123;</span><br><span class="line">    Queue&lt;String&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    collect(<span class="keyword">this</span>.get(root, pre, <span class="number">0</span>), pre, queue);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(Node x, String pre, Queue&lt;String&gt; q)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Starting with Node x, find all keys</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) q.add(pre);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c = <span class="number">0</span>; c &lt; R; c++)</span><br><span class="line">        collect(x.next[c], pre + c, q);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Wildcard-match"><a href="#Wildcard-match" class="headerlink" title="Wildcard match"></a>Wildcard match</h3><p>Wildcard match: to implement <code>keysThatMatch()</code> method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">keysThatMatch</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">    Queue&lt;String&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    collect(root, <span class="string">""</span>, pat, queue);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(Node x, String pre, String pat, Queue&lt;String&gt; queue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">int</span> len = pre.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == pat.length()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) queue.add(pre);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> next = pat.charAt(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c = <span class="number">0</span>; c &lt; R; c ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == next || c == <span class="string">'.'</span>)</span><br><span class="line">            collect(x.next[c], pre + c, pat, queue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Longest-prefix"><a href="#Longest-prefix" class="headerlink" title="Longest prefix"></a>Longest prefix</h3><p>Now we also want to method <code>longestPrefixOf(String s)</code> to find the longest string which is a prefix of a given string. The principle is quite similar: go down the trie with the given string; once we find a node with a non-null value, we just update the length.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">longestPrefixOf</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length = search(root, s, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> s.substring(<span class="number">0</span>, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(Node x, String s, <span class="keyword">int</span> d, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> length;</span><br><span class="line">    <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) length = d;</span><br><span class="line">    <span class="keyword">if</span> (d == s.length()) <span class="keyword">return</span> length;</span><br><span class="line">    <span class="keyword">char</span> c = s.charAt(d);</span><br><span class="line">    <span class="keyword">return</span> search(x.next[c], s, d + <span class="number">1</span>, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Deletion"><a href="#Deletion" class="headerlink" title="Deletion"></a>Deletion</h3><p>What if we want to delete a key? Apparently, the first step is to find the node corresponding to the input string and then set the value to <code>null</code>. However, we need to remove many nodes all the way down. This can be easily implemented with the recursive method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    root = delete(root, key, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">delete</span><span class="params">(Node x, String key, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (d == key.length()) &#123;</span><br><span class="line">        <span class="comment">// Find the node representing the key</span></span><br><span class="line">        x.val = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Keep going down and find the node.</span></span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        x.next[c] = delete(x.next[c], key, d + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x.val != <span class="keyword">null</span>) <span class="keyword">return</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c = <span class="number">0</span>; c &lt; R; c ++) &#123;</span><br><span class="line">        <span class="comment">// Check if x have a non-null link</span></span><br><span class="line">        <span class="keyword">if</span> (x.next[c] != <span class="keyword">null</span>) <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>It is easy to prove the time complexity of this algorithm. What about space?</p>
<p>The number of links in a trie us between <code>RN</code> and <code>RNw</code>, where w is the average key length.</p>
<h2 id="TSTs"><a href="#TSTs" class="headerlink" title="TSTs"></a>TSTs</h2><p>Ternary search tries (TSTs) are used to avoid the excessive space cost associated with R-way tries. In a TST, each node has a character, three links, and a value.The three links corresponds to keys whose current characters are less than, equal, or greater than the node’s character.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TSTNew</span>&lt;<span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> c;</span><br><span class="line">        Node left, mid, right;</span><br><span class="line">        Value value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Value <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Node node = get(root, key, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Note: value could be null</span></span><br><span class="line">        <span class="keyword">return</span> node.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">get</span><span class="params">(Node x, String key, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        <span class="keyword">if</span> (c &lt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the left side.</span></span><br><span class="line">            <span class="keyword">return</span> get(x.left, key, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the right side.</span></span><br><span class="line">            <span class="keyword">return</span> get(x.right, key, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (d &lt; key.length() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// Have not reached the end of key, need to go down.</span></span><br><span class="line">            <span class="keyword">return</span> get(x.mid, key, d + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Have reached the end of the key.</span></span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, Value val)</span> </span>&#123;</span><br><span class="line">        root = put(root, key, val, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">put</span><span class="params">(Node x, String key, Value val, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> c = key.charAt(d);</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x = <span class="keyword">new</span> Node();</span><br><span class="line">            x.c = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c &lt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the left side.</span></span><br><span class="line">            x.left = put(x.left, key, val, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt; x.c) &#123;</span><br><span class="line">            <span class="comment">// Go to the rigth side.</span></span><br><span class="line">            x.right = put(x.right, key, val, d);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (d &lt; key.length() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// Have not reached the end of the key.</span></span><br><span class="line">            x.mid = put(x.mid, key, val, d + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Have reached the end of the key.</span></span><br><span class="line">            x.value = val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The number of links in a TST build from N string keys of average length <code>w</code> is between <code>3N</code> and <code>3Nw</code>.</p>
<h2 id="Substring-Search"><a href="#Substring-Search" class="headerlink" title="Substring Search"></a>Substring Search</h2><h3 id="Brute-force"><a href="#Brute-force" class="headerlink" title="Brute-force"></a>Brute-force</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringSearch</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is the brute-force substring search</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String pat, String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> N = txt.length();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N - M; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> j;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j ++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (txt.charAt(i + j) != pat.charAt(j))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(search(<span class="string">"ABRA"</span>, <span class="string">"ABACADABRAC"</span>));</span><br><span class="line">        System.out.println(search(<span class="string">"ABRA"</span>, <span class="string">"ABACADABRBC"</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Time complexity: <code>O(MN)</code>. Below is an alternative solution.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">search2</span><span class="params">(String pat, String txt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> M = pat.length();</span><br><span class="line">    <span class="keyword">int</span> N = txt.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; N &amp;&amp; j &lt; M; i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (txt.charAt(i) == pat.charAt(j)) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            i -= j;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i - M;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> N;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="KMP-Algorithm"><a href="#KMP-Algorithm" class="headerlink" title="KMP Algorithm"></a>KMP Algorithm</h3><p>Here I will introduce two versions of KMP algorithms.</p>
<h4 id="2D-Version-with-DFA"><a href="#2D-Version-with-DFA" class="headerlink" title="2D Version with DFA"></a>2D Version with DFA</h4><p>As we mentioned in the brute-force substring match algorithm (the alternate one), if we find a mismatch at some point, <code>j</code> has to set to be <code>0</code> and <code>i</code> will also decremented. This is the main reason that the running time of that algorithm is high.</p>
<p>Is there a way which avoids decrementing the value of ‘j’. This is what KMP algorithm tries to achieve. The basic idea behind the algorithm discovered by Knuth, Morris, and Pratt is this: whenever we detect a mismatch, <em>we already know some of the characters in the text</em>, since they matched the pattern characters prior to the mismatch.</p>
<p>In KMP substring search, we never back up the text pointer <code>i</code>, and we use an array <code>dfa[][]</code> to record how far to back up the pattern pointer <code>j</code> when a mismatch is detected. For every character <code>c</code>, <code>dfa[c][j]</code> is the pattern position to compare with next text position after comparing <code>c</code> with <code>pat.charAt(j)</code>. During the search, <strong><code>dfa[txt.charAt(i)][j]</code> is the pattern position to compare with <code>txt.charAt(i)</code> with <code>pat.charAt(j)</code></strong>. Thus, <code>dfa[pat.charAt(j)][j]</code> is always <code>j+1</code>.</p>
<p>Once we have computed DFA, we then can easily search the match with DFA. You may ask, why we have to call it “DFA”?</p>
<p>In fact, “DFA” represents <em>deterministic finite-state automation</em>. For example, for a pattern <code>A B A B A C</code>, the DFA will be (we will later study how can we construct DFA):</p>
<pre><code>   A B C D E F
j  0 1 2 3 4 5
   -----------
A |1 1 3 1 5 1
B |0 2 0 4 0 4
C |0 0 0 0 0 6</code></pre><p>Please note that here we assume there are only three characters (A, B, and C) in the alphabet. Below is the graphical representation of this DFA.</p>
<p><img src="dfa_graph.jpg" alt="dfa_graph"></p>
<p>We then could easily use this to finish the matching process. The input text string is “B C B A A B A C A A B A B A C A A”:</p>
<p><img src="dfa_process.jpg" alt="dfa_process"></p>
<p>Below is the code corresponding to the process showed in the picture.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KMP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[][] dfa;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KMP</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        dfa = <span class="keyword">new</span> <span class="keyword">int</span>[R][M];</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> construct the DFA array    </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, j;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length(), M = <span class="keyword">this</span>.pat.length();</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; N &amp;&amp; j &lt; M; i++) &#123;</span><br><span class="line">            j = dfa[txt.charAt(i)][j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i - M;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Up to now, you must feel the logic is natural and comfortable. Now, we have to know how can we construct DFA array with a given pattern string, which is much trickier and interesting.</p>
<p>When we have a mismatch at <code>pat.charAt(j)</code>, our interest is in knowing in what state the DFA <em>would be</em> if we were to back up the next index and rescan the text characters that we just saw after shifting to the right one position (remember, <code>i</code> is always incremented by <code>1</code> after a match or mismatch).</p>
<p>What should the DFA do with the next character? <strong><em>Exactly what it would have done if we had backed up</em></strong>, except if it finds a match with <code>pat.charAt(j)</code>, when it should go to state <code>j+1</code>. Certainly, this makes sense and is straightforward.</p>
<p>So, the question here is, what is the back up state X? before this question, we must know what exactly happens (or, say, what we should do) when backing up to state X. Here are two question to discussed about:</p>
<blockquote>
<p>Q: What we actually do after backing up to state <code>X</code>?</p>
</blockquote>
<p>If we back up to state X after a mismatch, keep <code>i</code> not changed, and set <code>j</code> to X. The definition of X should guarantee that <strong>all chars from index 0 to <code>j - 1</code> (i.e., <code>X - 1</code>) are matched with chars prior to <code>i</code> in the text string</strong>. We now, we just need to compare the char of index <code>j</code> (<code>X</code>) in the pattern string and the char of index <code>i</code> in the text string, this may proceed to a nigger state or a level state. Because our DFA is partially completed already, and <code>X &lt; j</code>, so we can use the DFA now! which is: <code>dfa[c][X]</code>, where <code>c</code> is the current text char at index <code>i</code>. And then, according to the definition of DFA, we get a new position for <code>j</code> (the result of <code>dfa[c][X]</code>), and <code>i</code> is incremented by 1.</p>
<p><strong><em>Thus, we can copy the entry values in state <code>X</code> to state <code>j</code>, except when we see a match: <code>dfa[pat.charAt(j)][j] = j + 1</code>.</em></strong></p>
<p>I know this is kind of confusing, so let’s look into 2 example. In both these examples, we use pattern string <code>A B A B A C</code>.</p>
<p><strong>~ Example 1</strong></p>
<p>Say we have completed the first column of DFA (the first column of this DFA is in fact the complete DFA for pattern string <code>A</code>), and we are building the second column. As mentioned earlier, we should back up (exception there is a match, and we will handle this case specially) to state <code>X</code>. <code>X</code> for the second column (<code>j = 1</code>) is <code>0</code> (we will explain why <code>X</code> is this value later).</p>
<pre><code>             (i)
txt string: A A C ...
pat string: A B A ...
             (j)</code></pre><p>We can see that when state is <code>1</code> (<code>j = 1</code>) we have a mismatch. As we said previously, we need to remain the value of <code>i</code>, and set <code>j</code> to <code>0</code>.</p>
<pre><code>             (i)
txt string: A A C...
pat string:   A B A...
             (j)
             (X)</code></pre><p>We have backed up the <code>X</code>, and we have not finished our job. We could only make sure that all chars from index <code>0</code> to <code>X - 1</code> is pattern string are matched (of course, it is none in this example), but how about char on index <code>X</code> (<code>i</code> for text string)? We cannot make sure it is also match.</p>
<p>In fact, because we have finished the first column of DFA, and <code>j</code> is <code>0</code> now, and you may also notice that <strong><em>we are actually doing a match</em></strong>! All of these indicate that we can use the partially completed DFA to determine a new state, which is given by <code>dfa[&#39;A&#39;][X]</code>. The first <code>A</code> indicates the char on index <code>i</code> in text string. If the text string is <code>A B ...</code>, then use <code>dfa[&#39;B&#39;][X]</code>. As we are building the second column of DFA, we might need a loop: <code>dfa[][j] = dfa[][X]</code> (note <code>j</code> here is the original <code>y</code>).</p>
<p>Continue this example. <code>dfa[&#39;A&#39;][X]</code>, which is also <code>dfa[&#39;A&#39;][0]</code> will return <code>1</code>. Thus, we set <code>j</code> to <code>1</code> and increment <code>i</code> by 1.</p>
<pre><code>               (i)
txt string: A A C...
pat string:   A B A...
               (j)</code></pre><p><strong>~ Example 2</strong></p>
<p>You may notice that the example 1 does not show that <strong>all chars from index 0 to <code>X - 1</code> are matched with chars prior to <code>i</code> in the text string</strong>. No worry, we can give you another example.</p>
<p>Suppose now we have a mismatch at index <code>j = 3</code>, and <code>X</code> is <code>1</code>. For example, it happens when the text string is <code>A B A C ...</code></p>
<pre><code>                 (i)
txt string: A B A C A...
pat string: A B A B A...
                 (j)</code></pre><p>As we discussed previously, we need to remain the value of <code>i</code>, and set <code>j</code> to <code>X</code>, which is <code>1</code>.</p>
<pre><code>                 (i)
txt string: A B A C A ...
pat string:     A B A B A ...
                 (j)
                 (X)</code></pre><p>We can see all chars from index <code>0</code> to <code>X - 1</code>, in fact, <code>A</code>, match with txt string. So, we only need to care about the chars after <code>X</code>, and we can just use value of <code>dfa[C][X]</code> as the DFA is partially built. The value given by it is <code>0</code>.</p>
<pre><code>                   (i)
txt string: A B A C A ...
pat string:         A B A B A ...
                   (j)</code></pre><p>I believe these two examples can help you understand the process that we build the DFA array. The key to understand the process is to be aware that state <code>X</code> <em>can make sure all chars prior to index <code>X</code> in pattern string have will be matched if we set <code>j</code> to <code>X</code> and do not change <code>i</code></em>.</p>
<p>There is another way to understand <code>X</code>, and it will help you understand the next question.</p>
<p>For a given string, we define its <strong><em>prefix set</em></strong> as the set of all its prefix (exclude the string itself) and <strong><em>suffix set</em></strong> as the set of all its suffix (exclude the string itself). <strong><code>X</code> will be the length of the longest string in the intersection set of the string’s prefix and suffix set</strong>. For example, for string <code>ABA</code>, longest string is <code>A</code>, and <code>X</code> is <code>1</code>; for <code>ABAB</code>, <code>X</code> will be <code>2</code>.</p>
<p>We have image the you are match two same strings, while sliding one to the left and another one to right. Once the overlapping matches, we get the <code>X</code> value. Take <code>ABAB</code> as an example:</p>
<pre><code>← A B A B
      A B A B →</code></pre><p>It should be easy to derive this representation once you have understand the two examples above.</p>
<p>In fact, this is also the way to compute the value of <code>X</code>. However, we don’t want to use this naive way, and here comes our second question.</p>
<blockquote>
<p>Q: How can we compute the value of <code>X</code>?</p>
</blockquote>
<p>At first, let’s talk about what is the initial value of <code>X</code> when we just start to build the DFA array.</p>
<ul>
<li>If we mismatch at state <code>0</code>, of course we should go back to state <code>0</code> (<code>j = 0</code>). This is totally understandable;</li>
<li>If we mismatch at state <code>1</code>, we could only back up to <code>0</code> as well as we cannot stay the same state.</li>
</ul>
<p>What if we mismatch at other positions? The method is, every time when we have finished one column of DFA, <strong>we need to update the value of <code>X</code></strong>.</p>
<p>Say we now have finished the first three columns of the DFA array and are building the 4th column. The prefix with length of 3 is <code>ABA</code>, and the <code>X</code> value during the construction of 4th column is <code>1</code>:</p>
<pre><code>← A B A
      A B A →
       (X)</code></pre><p>Apparently, value of <code>X</code> is the length that we can self-matched, as showed above. Say now we also have finished the 4th column, and the prefix length should be <code>4</code>. Then, it is necessary to update the value of <code>X</code>:</p>
<pre><code>   (new char added)
        ↓
← A B A B
      A B A B →
       (X)  ↑
          (new char added)</code></pre><p>A critical observation is, to determine the new value of <code>X</code> (or, say, the new length of self-matching), <strong><em>we only need to match the newly added char with the char on index of previous <code>X</code></em></strong>: <code>dfs[pat.charAt(j)][X]</code>!</p>
<p>We can use DFA to do this still because <code>X</code> is smaller than <code>j</code> and the DFA is partially completed!</p>
<p>You will find some interesting facts about <code>X</code>. For example, if <code>X</code> is incremented after one update, it could only be incremented by <code>1</code>; <code>X</code> might also be lower after one update (e.g., if the newly added char is <code>c</code> rather than <code>B</code>, <code>X</code> will become <code>0</code>).</p>
<p>Okay, take a deep breath! We have gone through everything about KMP now, and I believe (100%) that you are confident in writing the code by yourself.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KMP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[][] dfa;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KMP</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        dfa = <span class="keyword">new</span> <span class="keyword">int</span>[R][M];</span><br><span class="line">        dfa[pat.charAt(<span class="number">0</span>)][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>, X = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; R; c ++) &#123;</span><br><span class="line">                dfa[c][j] = dfa[c][X];</span><br><span class="line">            &#125;</span><br><span class="line">            dfa[pat.charAt(j)][j] = j + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update X</span></span><br><span class="line">            X = dfa[pat.charAt(j)][X];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i, j;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length(), M = <span class="keyword">this</span>.pat.length();</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; N &amp;&amp; j &lt; M; i++) &#123;</span><br><span class="line">            j = dfa[txt.charAt(i)][j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == M) <span class="keyword">return</span> i - M;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1D-Version-with-PMT"><a href="#1D-Version-with-PMT" class="headerlink" title="1D Version with PMT"></a>1D Version with PMT</h4><p>If you are a Chinese reader, you can also refer to <a href="https://www.zhihu.com/question/21923021/answer/281346746" target="_blank" rel="noopener">this post</a> for a new version which only uses a 1-D array. I will translate it into English later.</p>
<p>One hint I would give you is: though these two versions seem to differ a lot, they still share something (which plays a big role in KMP algorithm) in common. <strong><em>You will find that the the “PMT” mentioned in this version is exactly the restart state <code>X</code> is the 2D version!</em></strong></p>
<h4 id="Performance-1"><a href="#Performance-1" class="headerlink" title="Performance"></a>Performance</h4><p>For the second version, the time complexity is <code>O(M + N)</code> (<code>O(M)</code> for computing DFA and <code>O(N)</code> for search); if we do not ignore the alphabet size <code>R</code>, then it should be <code>O(RM + N)</code>.</p>
<h3 id="Boyer-Moore-Algorithm"><a href="#Boyer-Moore-Algorithm" class="headerlink" title="Boyer-Moore Algorithm"></a>Boyer-Moore Algorithm</h3><p>AS you can see, KMP algorithm is a method based on <em>left-to-right</em> compare. Here we want to introduce a new algorithm based on the <em>right-to-left</em> compare.</p>
<p>In this algorithm, we still have two pointers, <code>i</code> and <code>j</code>, for text string and pattern string respectively. Index<br><code>i</code> always points to the char in the text string that should be compared with the first char of the pattern string, <code>j</code> initially points to the last char of the pattern string and will be decremented if <code>pat.charAt(j) == txt.charAt(i+j)</code>.</p>
<p>In addition, we also implement an array <code>right[]</code> that gives fir each character in the alphabet, the index of its <em>rightmost occurrence</em> in the pattern (or <code>-1</code> if the character is not in the pattern). For example, if the string is <code>N E E D L E</code>:</p>
<pre><code> A  B  C  D  E ... L   M  N ...
-1 -1 -1  3  5 ... 4  -1  0 ...</code></pre><p>If there is a mismatch between <code>pat.charAt(j)</code> and <code>txt.charAt(i+j)</code>, we will have one of the following three cases:</p>
<ol>
<li>If the character causing the mismatch is not found in the pattern, we can slide the pattern <code>j+1</code> positions to the right;</li>
<li>If the character <code>c</code> causing the mismatch is found in the pattern ,we use the <code>right[]</code> array to line up the pattern with the text string so that character will match its rightmost occurrence in the pattern. To do so, we increment <code>i</code> by <code>j</code> minus <code>right[c]</code>.</li>
<li>If the computation would not increase <code>i</code>, i.e., not helping, we simply increment <code>i</code> by <code>1</code>, just like what we do in the brute-force algorithm.</li>
</ol>
<p>Now, the code below should be understandable and straightforward.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoyerMoore</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] right;</span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BoyerMoore</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">        right = <span class="keyword">new</span> <span class="keyword">int</span>[R];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span> ; c &lt; R; c++) &#123;</span><br><span class="line">            right[c] = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">            right[pat.charAt(j)] = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length();</span><br><span class="line">        <span class="keyword">int</span> M = pat.length();</span><br><span class="line">        <span class="keyword">int</span> skip;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N - M; i += skip) &#123;</span><br><span class="line">            skip = <span class="number">0</span>;  <span class="comment">// the increment for i</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = M - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j --) &#123;</span><br><span class="line">                <span class="comment">// compare pat.charAt(i) and txt.charAt(i+j)</span></span><br><span class="line">                <span class="keyword">if</span> (pat.charAt(j) != txt.charAt(i+j)) &#123;</span><br><span class="line">                    skip = j - right[txt.charAt(i+j)];</span><br><span class="line">                    <span class="comment">// if value of `right` is -1, then skip = j + 1, which is the second case</span></span><br><span class="line">                    <span class="keyword">if</span> (skip &lt; <span class="number">1</span>) skip = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (skip == <span class="number">0</span>) <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Please note, this algorithm requires <em>backup in the input string</em>, i.e., we need to read previous chars again during the process. It enables us to exploit some features of right-to-left compares. In some applications where backup is not allowed, KMP would be a better candidate.</p>
<h3 id="Rabin-Karp-Algorithm"><a href="#Rabin-Karp-Algorithm" class="headerlink" title="Rabin-Karp Algorithm"></a>Rabin-Karp Algorithm</h3><p>Unlike the two algorithms above, this algorithm will use hashing. In fact, each string of length <code>M</code> corresponds to an <code>M</code>-digit base-<code>R</code> number, which means we can totally treat a string as a number. We could also implement a has function to convert an <code>M</code>-digit base-<code>R</code> number to an <code>int</code> value between 0 and <code>Q-1</code>, with the help of modular hashing.</p>
<p>A naive solution is based on the brute-force substring matching: we could simply compute the hash value for every possible substring with length <code>M</code> of the text string, and compare it with the hash value of pattern string. However, it is not efficient and shows no improvement over brute-force solution.</p>
<p>The Rabin-Karp algorithm shows an efficient way to get the new hash value after we move <code>i</code> to the right position by 1. It is easy to derive this logic with some simple maths work:</p>
<p>Using the notation $t_i$ for <code>txt.charAt(i)</code>, the number corresponding to the <code>M</code>-character substring of text string that starts at position <code>i</code> is</p>
<p>$$x_i = t_iR^{M-1} + t_{i+1}R^{M} + … + t_{i+M-1}R^0$$</p>
<p>and we can assume that we know the value of $h(x_i)=x_i$ mod Q. It is also easy to get that</p>
<p>$$x_{i+1} = (x_i - t_iR^{M-1})R+t_{i+M}$$</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabinKarp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String pat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> M;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> patHash;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> Q;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> R = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> RM;  <span class="comment">// R^(M - 1) % Q</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RabinKarp</span><span class="params">(String pat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pat = pat;</span><br><span class="line">        <span class="keyword">this</span>.M = pat.length();</span><br><span class="line">        Q = <span class="number">997</span>; <span class="comment">// A prime number</span></span><br><span class="line">        RM = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= M - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            RM = (R * RM ) % Q;</span><br><span class="line">        &#125;</span><br><span class="line">        patHash = hash(pat, M);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">hash</span><span class="params">(String key, <span class="keyword">int</span> M)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> h = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; M ; j++) &#123;</span><br><span class="line">            h = (R * h + key.charAt(j)) % Q;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = txt.length();</span><br><span class="line">        <span class="keyword">long</span> txtHash = hash(txt, M); <span class="comment">// only get the hash value for the first M chars</span></span><br><span class="line">        <span class="keyword">if</span> (patHash == txtHash &amp;&amp; check(<span class="number">0</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = M ; i &lt; N; N++) &#123;</span><br><span class="line">            txtHash = (txtHash + Q - RM * txt.charAt(i-M) % Q) % Q;  </span><br><span class="line">            <span class="comment">// Adding Q to make sure we can always get the positive value</span></span><br><span class="line">            txtHash = (txtHash * R + txt.charAt(i)) % Q;</span><br><span class="line">            <span class="keyword">if</span> (patHash == txtHash &amp;&amp; check(i - M + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i - M + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You may notice that there is a function called <code>check()</code>. Why do we need this?</p>
<p>hashing is a good thing and we could exploit hashing for many applications, e.g., <code>HashMap</code> in Java. However, one main problem of hashing is that we may see hash conflict sometimes. Of course, we have the same problem in this case, as two different strings will get the same hash value. In order to resolve this issue, we can simply add an additional check when we see a hash value match, but we do not want to do that as it requires backup in the text string. Instead, we can choose a bigger value for <code>Q</code> to make the probability of hash conflict very small.</p>
<p>This algorithm is an early and famous example of <em>Monte Carlo</em> algorithm that has a guaranteed completion time but fails to output a correct answer with a small probability. The alternative method of checking for a match could be slow (it might amount to the brute-force algorithm, with a small probability) but is guaranteed correct, which is known as a <em>Las Vegas</em> algorithm.</p>
<p>Rabin-Karp substring search is known as a <em>fingerprint</em> search because it uses a small amount of information to represent a pattern.</p>
<h2 id="Regex"><a href="#Regex" class="headerlink" title="Regex"></a>Regex</h2><p>Substring search appears in many applications in real world, but we also need regular expressions to describe patterns and use this pattern to recognize some input string. In this section, we will implement algorithms for recognizing strings with regex.</p>
<p>If you have experience with regex in some programming languages, you may notice that there are many complicated rules in regex, but here we will not do all of them. Instead, we will only focus on three basic operations:</p>
<ol>
<li>Concatenation: when we write <code>AB</code>, we are specifying the language <code>{AB}</code>that has one two-character string, formed by concatenating <code>A</code> and <code>B</code>;</li>
<li>Or: specified by <code>|</code>. E.g., <code>A|B</code> specified the language <code>{A, B}</code>;</li>
<li>Closure: close allows parts of the pattern to be repeated arbitrarily. We denote closure by placing a <code>*</code> after<br>the pattern to be repeated.</li>
</ol>
<p>By convention, we also use parentheses to override the default precedence rules. All patterns will be enclosed in parentheses as well.</p>
<h3 id="NFA"><a href="#NFA" class="headerlink" title="NFA"></a>NFA</h3><p>Recall the KMP algorithm for substring search where DFA is exploited. Here we will also exploit this idea, though we might do something different.</p>
<p>We will build a <strong><em>nondeterministic finite-state automata</em></strong> (NFA) for a given regex string. Unlike DFA, the automata shows nondeterminism due to the nature of regex, as we are faced with more than one way to try to match the pattern.</p>
<p>For pattern string <code>((A*B|AC)D)</code>, the NFA is showed below:</p>
<p><img src="nfa.svg" alt="nfa_eg"></p>
<p>The rules for an NFA is listed below:</p>
<ol>
<li>The NFA corresponding to an regex of length <em>M</em> has exactly one state per pattern chars, starts at state 0, and has a (virtual) accept state <em>M</em>;</li>
<li>States corresponding to character from the alphabet have an outgoing edge that goes to the state corresponding to the next character in the pattern (black edges in the diagram);</li>
<li>States corresponding to the meta-chars <code>(</code>,<code>)</code>,<code>|</code>,<code>*</code> have at least one outgoing black edge (red edges in the diagram).</li>
<li>No state has more than one outgoing black edge.</li>
</ol>
<p>What are the the rules when we match the input string?</p>
<ol>
<li>If the current state corresponding to a char in the alphabet and the current char in the text string matched the char, the automation can scan past the char in the text string and take the black transition to the next state;</li>
<li>the automation can follow any red edge to another state without scanning any text char.</li>
</ol>
<p>We can use the rules to scan and recognize the input text string. As there might be multiple outgoing red edges for a state, we need to find all possible path to check the input text string.</p>
<h3 id="Simulating-an-NFA"><a href="#Simulating-an-NFA" class="headerlink" title="Simulating an NFA"></a>Simulating an NFA</h3><p>NFA is in similar to a directed graph and simulating an NFA is similar to DFS. We create the initial states by starting state <code>0</code> and going all the way to states pointed by read edge. In the example above, the initial state should be <code>0 1 2 3 4 6</code>; if the first char in text string is <code>A</code>, then we update the state set to <code>2 3 4 7</code>. We should keep doing this until all chars from text string are exhausted, and finally we check if the accept state is in the state set.</p>
<p><strong>Note</strong>: when building digraph, we will not include the black edges into the graph.</p>
<p>We then can write the code out immediately with the idea. The code use <code>Digraph</code> and <code>DirectedDFS</code> class and you may refer to their implementation in <a href="#Appendix">Appendix</a>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NFA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span>[] re;</span><br><span class="line">    <span class="keyword">private</span> Digraph G;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> M;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NFA</span><span class="params">(String regexp)</span> </span>&#123;</span><br><span class="line">        re = regexp.toCharArray();</span><br><span class="line">        M = regexp.length();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> construct the NFA</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">recognizes</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        Set&lt;Integer&gt; pc = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        DirectedDFS dfs = <span class="keyword">new</span> DirectedDFS(G, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; txt.length(); i++) &#123;</span><br><span class="line">            <span class="comment">// Compute possible NFA states for txt[i+1]</span></span><br><span class="line">            Set&lt;Integer&gt; match = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">                <span class="keyword">if</span> (v &lt; M) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (re[v] == txt.charAt(i) || re[v] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                        match.add(v+<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            dfs = <span class="keyword">new</span> DirectedDFS(G, match);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v == M) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Determining whether an N-character text string is recognized by the NFA corresponding to an M-character RE takes time proportional to <em>NM</em> in the worst case. However, we in fact need to know the number of edges in the directed graph. We will talk about it later.</p>
<h3 id="Building-an-NFA"><a href="#Building-an-NFA" class="headerlink" title="Building an NFA"></a>Building an NFA</h3><p>Now, the problem is how we can build an NFA given a pattern string. For different operations, we might need to exploit different rules.</p>
<p><strong><em>Concatenation</em></strong></p>
<p>This is the simplest one. We just mentioned that we do not include black edge into the graph, so we can just simply ignore the char if the char is in the alphabet.</p>
<p><strong><em>Parentheses</em></strong></p>
<p>We just push the RE index of each left parentheses on the stack, and pop the left one out of the stack if we see a right one. It could be tricker than you think, as we will also push the or operator <code>|</code> on the stack.</p>
<p><strong><em>Closure</em></strong></p>
<p>A closure (*) operator must occur either after a single character or after a right parenthesis. The picture below shows these two cases and what we should do regarding updating the graph.</p>
<p><img src="nfa_closure.svg" alt="nfa_closure"></p>
<p><strong><em>Or</em></strong></p>
<p>We only consider an RE of the form <code>(A|B)</code> where <code>A</code> and <code>B</code> are both REs. When we see <code>)</code>, we should find the index of <code>|</code> and <code>(</code> then add two edges to the graph, as showed in the picture below. Please note within a pair of parenthesis, there will only be one <code>|</code>; a form of RE like <code>(A|B|C)</code> is not supported here.</p>
<p><img src="nfa_or.svg" alt="nfa_or"></p>
<p>With all the rules above, we can implement the code for building an NFA.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NFA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span>[] re;</span><br><span class="line">    <span class="keyword">private</span> Digraph G;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> M;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NFA</span><span class="params">(String regexp)</span> </span>&#123;</span><br><span class="line">        re = regexp.toCharArray();</span><br><span class="line">        M = regexp.length();</span><br><span class="line">        G = <span class="keyword">new</span> Digraph(M+<span class="number">1</span>);  <span class="comment">// Remember to include the accept state</span></span><br><span class="line">        Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> lp = i;</span><br><span class="line">            <span class="keyword">if</span> (re[i] == <span class="string">'('</span> || re[i] == <span class="string">'|'</span>) &#123;</span><br><span class="line">                stack.push(i);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (re[i] == <span class="string">')'</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> or = stack.pop();</span><br><span class="line">                <span class="keyword">if</span> (re[or] == <span class="string">'|'</span>) &#123;</span><br><span class="line">                     lp = stack.pop();</span><br><span class="line">                     G.addEdge(lp, or+<span class="number">1</span>);</span><br><span class="line">                     G.addEdge(or, i);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    lp = or;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &lt; M - <span class="number">1</span> &amp;&amp; re[i+<span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line">                <span class="comment">// lp could be i (current index), or a left parenthesis.</span></span><br><span class="line">                <span class="comment">// It in fact handles the two cases for closure.</span></span><br><span class="line">                G.addEdge(lp, i+<span class="number">1</span>);</span><br><span class="line">                G.addEdge(i+<span class="number">1</span>, lp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (re[i] == <span class="string">'('</span> || re[i] == <span class="string">'*'</span> || re[i] == <span class="string">')'</span>) &#123;</span><br><span class="line">                G.addEdge(i, i+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">recognizes</span><span class="params">(String txt)</span> </span>&#123;</span><br><span class="line">        Set&lt;Integer&gt; pc = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        DirectedDFS dfs = <span class="keyword">new</span> DirectedDFS(G, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; txt.length(); i++) &#123;</span><br><span class="line">            <span class="comment">// Compute possible NFA states for txt[i+1]</span></span><br><span class="line">            Set&lt;Integer&gt; match = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">                <span class="keyword">if</span> (v &lt; M) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (re[v] == txt.charAt(i) || re[v] == <span class="string">'.'</span>) &#123;</span><br><span class="line">                        match.add(v+<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            dfs = <span class="keyword">new</span> DirectedDFS(G, match);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dfs.marked(v)) pc.add(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v: pc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v == M) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Building the NFA corresponding to an M-character RE takes time ad space proportional to M in the worst case, as for each of the RE character in the regular expression, we add at most three transitions and perhaps execute one or two stack operations.</p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><h3 id="Directed-Graph-and-DFS"><a href="#Directed-Graph-and-DFS" class="headerlink" title="Directed Graph and DFS"></a>Directed Graph and DFS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Digraph</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> V;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> E;</span><br><span class="line">    <span class="keyword">private</span> Bag&lt;Integer&gt;[] adj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Digraph</span> <span class="params">(<span class="keyword">int</span> V)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.V = V;</span><br><span class="line">        <span class="keyword">this</span>.E = <span class="number">0</span>;</span><br><span class="line">        adj = (Bag&lt;Integer&gt;[])<span class="keyword">new</span> Bag[V];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; V; v++) &#123;</span><br><span class="line">            adj[v] = <span class="keyword">new</span> Bag&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">V</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> V;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">E</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> E;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">        adj[v].add(w); <span class="comment">// v -&gt; w</span></span><br><span class="line">        <span class="keyword">this</span>.E ++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Integer&gt; <span class="title">adj</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> adj[v];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Digraph <span class="title">reverse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Digraph R = <span class="keyword">new</span> Digraph(V);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; V; v++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> w: adj(v)) &#123;</span><br><span class="line">                R.addEdge(w, v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectedDFS</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>[] marked;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DirectedDFS</span><span class="params">(Digraph G, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        marked = <span class="keyword">new</span> <span class="keyword">boolean</span>[G.V()];</span><br><span class="line">        dfs(G, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DirectedDFS</span><span class="params">(Digraph G, Iterable&lt;Integer&gt; sources)</span> </span>&#123;</span><br><span class="line">        marked = <span class="keyword">new</span> <span class="keyword">boolean</span>[G.V()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> s: sources) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!marked[s]) dfs(G, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(Digraph G, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        marked[v] = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> w: G.adj(v)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!marked[w]) dfs(G, w);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">marked</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> marked[v];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/17/java3/">A Java programmer? Try these puzzles! (Part 3/3)</a>
            <span class="archive-item-date">Apr 17, 2020</span>
            <!-- <span style=> <p>Let’s continue our puzzlers!</p>
<h2 id="Classier-Puzzlers"><a href="#Classier-Puzzlers" class="headerlink" title="Classier Puzzlers"></a>Classier Puzzlers</h2><p>Puzzlers in this chapter will concern inheritance, overriding, and other forms of name reuse.</p>
<h3 id="A-Private-Matter"><a href="#A-Private-Matter" class="headerlink" title="A Private Matter"></a>A Private Matter</h3><p>In this program, a subclass filed has the same name as a superclass field. What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String className = <span class="string">"Base"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String className = <span class="string">"Derived"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrivateMatter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Derived().className);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are two possible behavior you may expect from this program:</p>
<ol>
<li>it should print <code>Base</code> as overriding may not take effect;</li>
<li>it does not compile, because the variable className in Derived has more restrictive access than it does in <code>Base</code>.</li>
</ol>
<p>If you run this program, you will find it does not compile, but the program is with <code>PrivateMatter</code>. Had <code>className</code> been an instance method instead of an instance filed, <code>Derived.className()</code> would have <em>overridden</em> <code>Base.className()</code>, and the program would have been illegal. The access modifier of an overriding method must provide at least as much access as that of the overridden method. Because <code>classname</code> is a field, <code>Derived.className</code> <em>hides</em> <code>Base.className</code> rather than overriding it. It is legal, though inadvisable.</p>
<p>In fact, hiding always cause confusion. A class that hides a field with one whose accessibility is more restrictive than that of the hidden field, as in out original program, violates the principle of <em>subsumption</em>, also known as <em>Liskov Substitution Principle</em>. This principle, generally speaking, says that everything you can do with a base class, you can also do with a derived class. This is an integral part of the natural mental model of object-oriented programming. The program will become very difficult to understand if it is violated. This principle is also violated when hiding one filed with another and:</p>
<ul>
<li>if the two field are of different types;</li>
<li>if one field is static and the other isn’t;</li>
<li>if one field is final and the other isn’t;</li>
<li>if one filed is constant and the other isn’t;</li>
<li>of both are constant and have different values.</li>
</ul>
<h3 id="All-Strung-Out"><a href="#All-Strung-Out" class="headerlink" title="All Strung Out"></a>All Strung Out</h3><p>Try to run the program below with the Java command or your favorite IDE. <strong>Don’t just read it and guess what is the output</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StrungOut</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s = <span class="keyword">new</span> String(<span class="string">"Hello world!"</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> java.lang.String s;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(java.lang.String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.s = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This program looks simple. It acts like a wrapper for <code>String</code>. However, if you try to run this code from an IDE (such as IntelliJ), it will not allow you to run it; if you run with java command, if will give you an exception:</p>
<pre><code>Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: main</code></pre><p>It seems strange, because we indeed have a main method in class <code>StrungOut</code>. Why can’t the VM find it?</p>
<p>Although <code>StrungOut</code> has a method named “main”, it has the wrong signature. A <code>main</code> method must accept a single argument that is an array of strings. What the VM is struggling to tell us is that <code>StrungOut.main</code> accepts an arrays of <em>our</em> <code>String</code> class, which has nothing whatsoever to do with <code>java.lang.String</code>.</p>
<p>Remember: <strong><em>avoid reusing the names of platform classes, and never reuse class names from java.lang</em></strong>.</p>
<h3 id="Package-Deal"><a href="#Package-Deal" class="headerlink" title="Package Deal"></a>Package Deal</h3><p>This program involves the interaction of two classes in different packages. What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hack;</span><br><span class="line"><span class="keyword">import</span> click.CodeTalk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeIt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClickIt</span> <span class="keyword">extends</span> <span class="title">CodeTalk</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">printMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Hack"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ClickIt clickit = <span class="keyword">new</span> ClickIt();</span><br><span class="line">        clickit.doIt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> click;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeTalk</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doIt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        printMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Click"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you run this program, you will find the output is <code>Click</code>. In fact, <strong><em>a package-private method cannot be directly overridden by a method in a different package</em></strong>. The two <code>printMessage</code> methods in this program are unrelated; they merely have the same name. The purpose of this rule for Java is to enable packages to support encapsulation of abstractions larger than a single class.</p>
<p>If you want the <code>printMessage</code> method in <code>hack.TypeIt.ClickIt</code> to override the method in <code>click.CodeTalk</code>, you must add the <code>protected</code> or <code>public</code> modifier to the method declaration in <code>click.CodeTalk</code>. To make the program compile, you must also add a modifier to the overriding declaration in <code>hack.TypeIt.ClickIt</code>. The modifier must be no more restrictive than the one you placed in the declaration for <code>printMessage</code> in <code>hack.TypeIt.ClickIt</code>.</p>
<h3 id="Import-Duty"><a href="#Import-Duty" class="headerlink" title="Import Duty"></a>Import Duty</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Arrays.toString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportDuty</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        printArgs(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printArgs</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">        System.out.println(toString(args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, this program does not compile. What is the problem? Is it because the compiler cannot find the function <code>toString</code>?</p>
<p>If you write this program in an IDE, probably the IDE will tell you what is the result: “Non-static method <code>toString</code> cannot be referenced from a static context”. The function <code>toString</code> we used in function <code>printArgs</code> is in fact the member method of class <code>ImportDuty</code> (inherit this method from class <code>Object</code>).</p>
<p><strong><em>Members that re naturally in scope take precedence over static imports</em></strong>. Remember: static import facility cannot be used effectively on a method if its name is already in scope.</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/13/java2/">A Java programmer? Try these puzzles! (Part 2/3)</a>
            <span class="archive-item-date">Apr 13, 2020</span>
            <!-- <span style=> <p>Let’s continue our puzzlers!</p>
<h2 id="Classy-Puzzlers"><a href="#Classy-Puzzlers" class="headerlink" title="Classy Puzzlers"></a>Classy Puzzlers</h2><h3 id="The-Case-of-the-Confusing-Constructor"><a href="#The-Case-of-the-Confusing-Constructor" class="headerlink" title="The Case of the Confusing Constructor"></a>The Case of the Confusing Constructor</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Confusing</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Confusing</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Object"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Confusing</span><span class="params">(<span class="keyword">double</span>[] dArray)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"double array"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Confusing(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apparently, this is a question on overloading. Which method is called by <code>main</code> method? The answer is the second one: <code>Confusing(double[])</code>.</p>
<p>There are two phases in Java’s overload resolution process:</p>
<ol>
<li>selects all the methods or constructors that are accessible and applicable;</li>
<li>selects the <em>most specific</em> of the methods or constructors selected in the first phase.</li>
</ol>
<p>In our program, both constructors are applicable and accessible, but <code>Confusing(Object)</code> is less specific as accepts any parameter passed to <code>Confusing(Object)</code>. The key to understanding this puzzle is that the test for which method or constructors is most specific does not use the <em>actual parameters</em>: the parameters appearing in the invocation (e.g., null in this case).</p>
<p>This puzzle should indicate some advices for you when you are writing some APIs: ensure your clients aren’t forced to go to these extreme fashions of selecting among overloadings. Ideally, you should <strong><em>avoid</em></strong> overloading: use different names for different methods, which, however, it is not possible sometimes. For example, constructors don’t have names, but you could make constructors private and providing public static libraries. If constructors have too many parameters, consider builder pattern.</p>
<p>If you really have to do overload, make sure that all overloading accept mutually incompatible parameter types, <strong><em>so that no two are applicable at the same time</em></strong>.</p>
<h3 id="Well-Dog-My-Cats"><a href="#Well-Dog-My-Cats" class="headerlink" title="Well, Dog My Cats!"></a>Well, Dog My Cats!</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123; count ++; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> count; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">woof</span><span class="params">()</span> </span>&#123; increment(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">meow</span><span class="params">()</span> </span>&#123; increment(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ruckus</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Dog[] dogs = &#123; <span class="keyword">new</span> Dog(), <span class="keyword">new</span> Dog() &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dogs.length; i++) &#123;</span><br><span class="line">            dogs[i].woof();</span><br><span class="line">        &#125;</span><br><span class="line">        Cat[] cats = &#123;<span class="keyword">new</span> Cat(), <span class="keyword">new</span> Cat(), <span class="keyword">new</span> Cat()&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cats.length; i++) &#123;</span><br><span class="line">            cats[i].meow();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(Dog.getCount() + <span class="string">" woofs "</span>);</span><br><span class="line">        System.out.println(Cat.getCount() + <span class="string">" meows"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A naive guess is <code>2 woofs 3 meows</code>. However, it turns out to be <code>5 woofs 5 meows</code>. It is not easy to get the reason: a single copy of each static field is shared among its declaring class and all subclasses. So <code>Dog</code> and <code>Cat</code> use the same <code>count</code> field.</p>
<p>To avoid this problem, we must correct a fundamental design error. When designing one class to build on the behavior of another, you have two options: <em>inheritance</em> (one class extends the other) and <em>composition</em> (one class contains an instance of the other). Apparently, composition is preferable in this case.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Counter counter = <span class="keyword">new</span> Counter();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">woofCount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> counter.getCount();&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">woof</span><span class="params">()</span> </span>&#123;counter.increment();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you are familiar with design patterns and principles in Java, you will aware that composition uses delegation to assign tasks and reduce coupling. You can refer to <em>Effective Java</em> for more information.</p>
<h3 id="All-I-Get-Is-Static"><a href="#All-I-Get-Is-Static" class="headerlink" title="All I Get Is Static"></a>All I Get Is Static</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Woof "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Basenji</span> <span class="keyword">extends</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bark</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bark</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Dog woofer = <span class="keyword">new</span> Dog();</span><br><span class="line">        Dog nipper = <span class="keyword">new</span> Basenji();</span><br><span class="line">        woofer.bark();</span><br><span class="line">        nipper.bark();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Both <code>woofer</code> and <code>nipper</code> are declared with <code>Dog</code>, but <code>nipper</code> is initializer with <code>Basenji</code> constructor. The method <code>bark</code> is <code>Basenji</code> is defined to do nothing. So <code>nipper.bark()</code> will print nothing. Is this true?</p>
<p>No. You will see two <code>Woof</code> on the screen.</p>
<p>The problem is that <code>bark</code> is a static method, and <strong>there is no dynamic dispatch on static methods</strong>. When a program calls a static method, the method to be invoked is selected at compile time, based on the compile-time type of the qualifier, which is the name we give to the part of the method invocation expression to the left of the dot. In this program, both <code>woofer</code> and <code>nipper</code> are declared to be of type <code>Dog</code> and they have to same compile-time type, the compiler causes the same method to be invoked: <code>Dog.bark</code>. It does not matter that the runtime type of <code>nipper</code> is <code>Basenji</code>; only compile-time type is considered.</p>
<p>When you  invoke a static method, you typically qualify it with a class rather an expression.</p>
<pre><code>Dog.bark();
Basenji.bark();</code></pre><p>In fact, this is what Java recommends to do. Remember: <strong><em>static methods cannot be overridden</em></strong>.</p>
<h3 id="Larger-Than-Life"><a href="#Larger-Than-Life" class="headerlink" title="Larger Than Life"></a>Larger Than Life</h3><p>What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Elvis</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Elvis INSTANCE = <span class="keyword">new</span> Elvis();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beltSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CURRENT_YEAR =</span><br><span class="line">        Calendar.getInstance().get(Calendar.YEAR);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Elvis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        beltSize = CURRENT_YEAR - <span class="number">1930</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBeltSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.beltSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            <span class="string">"Elvis wears a size "</span> + INSTANCE.getBeltSize() + <span class="string">" belt."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The program will return you <code>Elvis wears a size -1930 belt.</code>. It seems that <code>INSTANCE.getBeltSize()</code> will return <code>0</code>.</p>
<p>If you still have some memory of the puzzler “The Reluctant Constructor”, you might have some idea of what is really happening. However, <code>INSTANCE</code> here is a static variable and it may not cause <code>StackOverFlowError</code>. But the reason is similar: we have to dive deep into order of <em>class</em> initialization.</p>
<p>Initialization of <code>Elvis</code> is triggered by the VM’s call to its <code>main</code> method. First, static field are set to their default values. The field <code>INSTANCE</code> is set to <code>null</code>, and <code>CURRENT_YEAR</code> is set to 0. Next, static field initializers are executed in order of appearance. The first static field is <code>INSTANCE</code>. Its value is computed by invoking the <code>Elvis()</code> constructor.</p>
<p>The constructor initializes <code>beltSize</code> to an expression involving the static field <code>CURRENT_YEAR</code>. Normally, reading a static field is one of the things that causes a class to be initialized, but we are already initializing the class <code>Elvis</code>. Recursive initialization attempts are simply ignored. Consequently, the value of <code>CURRENT_VALUE</code> still has its default value of 0. That is why Elvis’s belt size if <code>-1930</code>. Though <code>CURRENT_YEAR</code> will be initialized to <code>2020</code> (current year), it is too late for the now correct value of this field to affect the computation of <code>Elvis.INSTANCE.beltSize</code>.</p>
<p>This puzzle shows that <strong><em>it is possible to observer a final static field before it is initialized.</em></strong> You should always be careful of the initialization cycles.</p>
<h3 id="What’s-the-Point"><a href="#What’s-the-Point" class="headerlink" title="What’s the Point?"></a>What’s the Point?</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> x, y;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    Point(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">        name = makeName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span> + x + <span class="string">","</span> + y + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorPoint</span> <span class="keyword">extends</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String color;</span><br><span class="line"></span><br><span class="line">    ColorPoint(<span class="keyword">int</span> x, <span class="keyword">int</span> y, String color) &#123;</span><br><span class="line">        <span class="keyword">super</span>(x, y);</span><br><span class="line">        <span class="keyword">this</span>.color = color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.makeName() + <span class="string">":"</span> + color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> ColorPoint(<span class="number">4</span>, <span class="number">2</span>, <span class="string">"red"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is not hard to spot the bug in the program, but I believe many programmers might not notice this bug. The result returned by this program is <code>[4,2]:null</code>.</p>
<p>If you are not aware of the issue, let’s mark the order of instance initialization.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> x, y;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    Point(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">        name = makeName();  <span class="comment">// 3. Invoke subclass method</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span> + x + <span class="string">","</span> + y + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ColorPoint</span> <span class="keyword">extends</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String color;</span><br><span class="line"></span><br><span class="line">    ColorPoint(<span class="keyword">int</span> x, <span class="keyword">int</span> y, String color) &#123;</span><br><span class="line">        <span class="keyword">super</span>(x, y);  <span class="comment">// 2. Chain to Point constructor</span></span><br><span class="line">        <span class="keyword">this</span>.color = color;  <span class="comment">// 5. Initialization blank final-Too late</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">makeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  4. Executes before subclass constructor body!</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.makeName() + <span class="string">":"</span> + color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  1. Invoke subclass constructor</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> ColorPoint(<span class="number">4</span>, <span class="number">2</span>, <span class="string">"red"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apparently, the bug is because we use the value of variable <code>color</code> before it is initialized. So, always remember that <strong><em>it is possible to observe the value of a final instance field before its value has been assigned</em></strong>.</p>
<p>In fact, this problem arises whenever a constructor calls a method that has been over-ridden in its subclass. A method invoked in this way always runs before the instance has been initialized, when its declared fields still have their default values. To avoid this problem, <strong>never call overridable methods from constructors</strong>.</p>
<h3 id="Sum-Fun"><a href="#Sum-Fun" class="headerlink" title="Sum Fun"></a>Sum Fun</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        initializeIfNecessary();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> sum;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initializeIfNecessary();</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initializeIfNecessary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">                sum += i;</span><br><span class="line">            initialized = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Cache.getSum());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems that the author of this program apparently went to a lot of trouble to make sure that <code>sum</code> was initialized before use, and expected <code>Cache.sum</code> to be <code>4950</code>. However, the program tells you the sum is <code>9900</code>, fully twice the expected value.</p>
<p>Obviously, the problem is because of the class initialization. Let’s go through the whole process.</p>
<p>Before it can invoke <code>Client.main</code>, the VM must initialize the class <code>Client</code>. The <code>Client.main</code> method invokes <code>Cache.getSum</code>. Before the <code>getSum</code> method can be executed, the VM must initialize the class <code>Cache</code>.</p>
<p>Do you still remember the order of static initializers? It follows the order they appear in the source. The <code>Cache</code> class has two static initializers: the <code>static</code> block at the top of the class and the initializing of the static field <code>initialized</code>. The first one will be executed first, adding 4950 to <code>sum</code> (default value of <code>sum</code> is <code>0</code>) and setting <code>initialized</code> to <code>true</code>.</p>
<p>The second initializer will com later. <strong>The static initializer for the <code>initialized</code> field sets it back to <code>false</code></strong>, completing the class initialization of <code>Cache</code>. Thus, when calling <code>Cache.getSum()</code>, <code>sum</code> will be added with 4950 again.</p>
<p>From the program, it infers that the programmer did not think about the order in which the initialization of the <code>Cache</code> class would take place, and was unable to decide between eager and lazy initialization. The author used both eager (<code>initializeIfNecessary()</code> in static block) and lazy initialization (<code>initializeIfNecessary()</code> in <code>getSum()</code>). Remember: <strong><em>use either eager initialization or lazy initialization, never both</em></strong>.</p>
<p>Instead, the code below is a better version for <code>Cache</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> sum = computeSum();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">computeSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100l</span> i++)</span><br><span class="line">            result += i;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A goof lesson (which we mentioned previously): if you want to compute a value for a static field, you’d better write a static function to do it.</p>
<h3 id="Creationism"><a href="#Creationism" class="headerlink" title="Creationism"></a>Creationism</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Creator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">            Creature creature = <span class="keyword">new</span> Creature();</span><br><span class="line">        System.out.println(Creature.getNum());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Creature</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Creature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        num ++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Pretty trick, right? If you try to write this program on your favorite IDE, you will find that this program does not compile. My IDE will tell me “Declaration not allowed here” at line 5.</p>
<p>I would say this puzzle is the most impressive and surprising one. Please notice that, line 5 is <em>a local variable declaration statement</em>. The syntax of the language does not allow a local variable declaration statement as the statement repeated by a <code>for</code>, <code>while</code>, or <code>do</code> loop. <strong><em>A local variable declaration can appear only as a statement directly within a block</em></strong>. (A block is a pair of curly braces and the statements and declaration contained within it.)</p>
<p>There are two ways to fix it:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    Creature creature = <span class="keyword">new</span> Creature();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">    <span class="keyword">new</span> Creature();</span><br></pre></td></tr></table></figure>

<h2 id="Library-Puzzlers"><a href="#Library-Puzzlers" class="headerlink" title="Library Puzzlers"></a>Library Puzzlers</h2><h3 id="The-Dating-Game"><a href="#The-Dating-Game" class="headerlink" title="The Dating Game"></a>The Dating Game</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatingGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Calendar cal = Calendar.getInstance();</span><br><span class="line">        cal.set(<span class="number">1999</span>, <span class="number">12</span>, <span class="number">31</span>);</span><br><span class="line">        System.out.println(cal.get(Calendar.YEAR) + <span class="string">" "</span>);</span><br><span class="line"></span><br><span class="line">        Date d = cal.getTime();</span><br><span class="line">        System.out.println(d.getDay());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems that the program should print <code>1999 31</code>. However, it prints <code>2000 1</code>. What is happening here?</p>
<p>Our program illustrates a few of the problems with the <code>Date</code> and <code>Calendar</code> API. The program’s first bug is in the method invocation <code>cal.set(1999, 12, 31)</code>. <strong><code>Date</code> represents January as 0, and <code>Calendar</code> perpetuates this mistake</strong>. Therefore, this method invocation sets the calendar to the thirty-first day of the thirteenth month of 1999. But the standard (Gregorian) calendar has only 12 months; surely this method invocation should cause an <code>IllegalArgumentException</code>? <strong>It should, but it doesn’t</strong>. The <code>Calendar</code> class silently substitutes the first month of the next year, in this case, 2000. This explains the first number printed by  our program (<code>2000</code>).</p>
<p>Another bug is: <strong><code>Date.getDay</code> returns the day of the week represented by the <code>Date</code> instance, not the day of the month</strong>. The returned value is 0-based, starting at Sunday.</p>
<p>A good thing is some of these confusing methods are deprecated already, and you should avoid using these methods. In addition, be careful when using <code>Calendar</code> or <code>Date</code> (or even other classes); always consult the API documentation.</p>
<h3 id="The-Mod-Squad"><a href="#The-Mod-Squad" class="headerlink" title="The Mod Squad"></a>The Mod Squad</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mod</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> MODULUS = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span>[] histogram = <span class="keyword">new</span> <span class="keyword">int</span>[MODULUS];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            histogram[Math.abs(i) % MODULUS] ++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (i ++ != Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; MODULUS; j++) &#123;</span><br><span class="line">            System.out.println(histogram[j] + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We expect to see number from each entry of <code>histogram</code> is roughly equal. However, if you run this code. You will get:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.ArrayIndexOutOfBoundsException: Index -2 out of bounds for length 3</span><br><span class="line">	at src.Mod.main(Mod.java:8)</span><br></pre></td></tr></table></figure>

<p>So <code>Math.abs(i)</code> returns a negative value? Let’s go to the documentation for <code>Math.abs</code>. The method is supposed to always return non-negative value， but in one case, it does not. The documentation says: if the argument is equal to the value of <code>Integer.MIN_VALUE</code>, the result is that same value, which is negative.</p>
<p>Please remember that <code>Math.abs()</code> is not guaranteed to return a non-negative value.</p>
<h3 id="A-strange-Saga-of-a-Suspicious-sort"><a href="#A-strange-Saga-of-a-Suspicious-sort" class="headerlink" title="A strange Saga of a Suspicious sort"></a>A strange Saga of a Suspicious sort</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuspiciousSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">        Integer[] arr = <span class="keyword">new</span> Integer[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">            arr[i] = rnd.nextInt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Comparator&lt;Integer&gt; cmp = <span class="keyword">new</span> Comparator&lt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer i1, Integer i2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i2 - i1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Arrays.sort(arr, cmp);</span><br><span class="line">        System.out.println(order(arr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> Order &#123;ASCENDING, DESCENDING, CONSTANT, UNORDERED&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Order <span class="title">order</span><span class="params">(Integer[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> ascending = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> descending = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">            ascending |= (a[i] &gt; a[i-<span class="number">1</span>]);</span><br><span class="line">            descending |= (a[i] &lt; a[i-<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ascending &amp;&amp; !descending)</span><br><span class="line">            <span class="keyword">return</span> Order.ASCENDING;</span><br><span class="line">        <span class="keyword">if</span> (descending &amp;&amp; ! ascending)</span><br><span class="line">            <span class="keyword">return</span> Order.DESCENDING;</span><br><span class="line">        <span class="keyword">if</span> (!ascending)</span><br><span class="line">            <span class="keyword">return</span> Order.CONSTANT;</span><br><span class="line">        <span class="keyword">return</span> Order.UNORDERED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this program, we try to sort a random generated array with a self-defined comparator. Then, we use a static method <code>order</code> to determine the type of the order. From the code, the comparator is supposed to sort the array in descending order. However, if you run this code, you will find that the program will print <code>UNORDERED</code>. What happens here?</p>
<p>There is a problem in the comparator. Seemingly this idiom always makes sense: if you have two numbers and you want a value whose sign indicates their order, compute their difference. However, the problem with this idiom us that a fixed-width integer is not big enough to hold the difference of two arbitrary integers of the same width. When you subtract two <code>int</code> or <code>long</code> values, the result can overflow, in which case it will have the wrong sign. Try the program below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverFlow</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> x = -<span class="number">2000000000</span>;</span><br><span class="line">		<span class="keyword">int</span> z = <span class="number">2000000000</span>;</span><br><span class="line">		System.out.println(x - z);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Thus, subtracting two values to compare them might not be a good choice.</p>
<br>

<p>———— END OF THIS POST ————</p>
<p>If you want to read more puzzlers, please go to <a href="/2020/04/17/java3/">this</a> page!</p>
</span> -->
        </article>
    
        

        

        <article class="archive-item">
            <a class="archive-item-link" href="/2020/04/05/java/">A Java programmer? Try these puzzles! (Part 1/3)</a>
            <span class="archive-item-date">Apr 5, 2020</span>
            <!-- <span style=> <p><img src="book.jpg" alt="book"></p>
<br>

<p>If you are a Java programmer, <strong><em>I highly recommend reading this book: Java Puzzler</em></strong>, by <em>Joshua Bloch</em> and <em>Neal Gafter</em>. This book will introduce many common traps, pitfalls and corner cases that you are highly likely to meet when programming with Java.</p>
<p>This post is intended to summarize the most interesting and critical pitfalls recorded in this book. Trust me, you will be highly surprised by some of them.<br><br></p>
<p><img src="pitfall.gif" alt="gif"></p>
<br>
This post will keep updating. Welcome to revisit!

<h2 id="Expressive-Puzzlers"><a href="#Expressive-Puzzlers" class="headerlink" title="Expressive Puzzlers"></a>Expressive Puzzlers</h2><h3 id="The-Joy-of-Hex"><a href="#The-Joy-of-Hex" class="headerlink" title="The Joy of Hex"></a>The Joy of Hex</h3><p>What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoyOfHex</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Long.toHexString(<span class="number">0x100000000L</span> + <span class="number">0xcafebabe</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The most intuitive answer would be <code>1cafebabe</code>, right? However, if you run this program, it is in fact <code>cafebabe</code>.</p>
<p>A very subtle feature for decimal literal is: <strong><em>decimal literals are all positive</em></strong>. This feature is not shared by hexadecimal or octal literals. To write a negative decimal literal, we always use a minus sign <code>-</code> in combination with a decimal literal. Thus, negative decimal constants are clearly identifiable by the presence of the minus sign. <strong><em>Hex and octal literals are negative if their high-order bit is <code>1</code></em></strong>.</p>
<p>In this program, the number <code>0xcafebabe</code> is an <code>int</code> constant with its high-order bit set, so it is negative. The addition performed by the program is a mixed-type computation: the left operand is of type <code>long</code>. Java will promote the <code>int</code> value to a <code>long</code> value with a <em>widening primitive conversion</em>.</p>
<p>Final computation will be: <code>0xffffffffcafebabeL + 0x0000000100000000L = 0x00000000cafebabeL</code></p>
<h3 id="Swap-Meat"><a href="#Swap-Meat" class="headerlink" title="Swap Meat"></a>Swap Meat</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CleverSwap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">1984</span>;  <span class="comment">//(0x7c0)</span></span><br><span class="line">        <span class="keyword">int</span> y = <span class="number">2001</span>;  <span class="comment">//(0x7d1)</span></span><br><span class="line">        x ^= y ^= x ^= y;</span><br><span class="line">        System.out.println(<span class="string">"x = "</span> + x + <span class="string">"; y = "</span> + y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As referred by its name, this program is supposed to swap the values of the variables <code>x</code> and <code>y</code>. However, you will find it fails, printing <code>x = 0; y = 1984</code>.</p>
<p>The most natural way to swap two variables is to use a temporary variable:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tmp = x;</span><br><span class="line">x = y;</span><br><span class="line">y = tmp;</span><br></pre></td></tr></table></figure>

<p>It was discovered that one could avoid the temporary variable:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = x ^ y;</span><br><span class="line">y = y ^ x;</span><br><span class="line">x = y ^ x;</span><br><span class="line"><span class="comment">// promise me: don't do this in your program :)</span></span><br></pre></td></tr></table></figure>

<p>In fact, it works. However, it is not recommended, as it is far less clear than its naive counterpart and far slower. Now, you might combine the three exclusive OR operations and make it into a single statement, like in the code.</p>
<p>However, it is guaranteed not to work in Java, though might work in other languages (C, C++, …).</p>
<p>Operands of operators are evaluated from left to right. To evaluate the expression <code>x ^= expr</code>, the value of <code>x</code> is sampled <strong>before</strong> <code>expr</code> is evaluated, and the exclusive OR of these two values is assigned to the variable <code>x</code>.</p>
<p>The code below describes what in fact happens in the original program:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tmp1 = x;  <span class="comment">// first appearance of x in the expression</span></span><br><span class="line"><span class="keyword">int</span> tmp2 = y;  <span class="comment">// first appearance of y</span></span><br><span class="line"><span class="keyword">int</span> tmp3 = x ^ y;  <span class="comment">// compute x ^ y</span></span><br><span class="line">x = tmp3;  <span class="comment">// last assignment: store x ^ y in x</span></span><br><span class="line">y = tmp2 ^ tmp3;  <span class="comment">// second assignment, store original x value in y</span></span><br><span class="line">x = tmp1 ^ y;  <span class="comment">// first assignment: store 0 in x</span></span><br></pre></td></tr></table></figure>

<p>If you really want to make it work, you shoudl write it like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y = (x ^= (y ^= x)) ^ y;  <span class="comment">// NOT recommended!</span></span><br></pre></td></tr></table></figure>

<p>A lesson: do not assign to the same variable more than once in a single expression.</p>
<h3 id="Dos-Equis"><a href="#Dos-Equis" class="headerlink" title="Dos Equis"></a>Dos Equis</h3><p>Now look at an example of conditional operator. What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DosEquis</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> x = <span class="string">'X'</span>;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        System.out.print(<span class="keyword">true</span> ? x : <span class="number">0</span>);</span><br><span class="line">        System.out.print(<span class="keyword">false</span> ? i : x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okay, this program seems trivial, and both <code>print</code> lines will print out <code>x</code>. However, if you run the program, it turns out to be <code>X88</code>.</p>
<p>I would admit this is the most surprising behavior of Java I’ve ever seen.</p>
<p>The answer lies in a dark corner of the specification for the conditional operator. <strong><em>Mixed-type computation can be confusing. Nowhere is this more apparent than in conditional expressions.</em></strong></p>
<p>So, this problem is due to that these two expressions have different result types (one is <code>char</code> is one is <code>int</code>). There are three key points in determining the result type of a conditional expression:</p>
<ol>
<li>If the second and third operands have the same type, that is the type of the conditional expression;</li>
<li>If one of the operands is of type <em>T</em> and <em>T</em> is <code>byte</code>, <code>short</code>, or <code>char</code> and the other operand is a constant expression of type <code>int</code> whose value is represented in type <em>T</em>, the type of the conditional expression is <em>T</em>.</li>
<li>Otherwise, binary numeric promotion is applied to the operands types, and the type of the conditional expression is the promoted type of the second and third operands.</li>
</ol>
<p>Remember: use the same type for the second and third operands in conditional expressions.</p>
<h2 id="Puzzlers-with-Characters"><a href="#Puzzlers-with-Characters" class="headerlink" title="Puzzlers with Characters"></a>Puzzlers with Characters</h2><h3 id="Animal-Farm"><a href="#Animal-Farm" class="headerlink" title="Animal Farm"></a>Animal Farm</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnimalFarm</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String pig = <span class="string">"length: 10"</span>;</span><br><span class="line">        <span class="keyword">final</span> String dog = <span class="string">"length: "</span> + pig.length();</span><br><span class="line">        System.out.println(pig == dog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Both strings will be <code>length: 10</code> in this case. Though the <code>==</code> operator does not test whether two objects are equal (it tests whether two object reference are identical), compile-time constants of type <code>String</code> are <strong>interned</strong>. So this program should print <code>True</code>, right?</p>
<p>Unfortunately, no. <strong><em>This is because the second string is not initialized with constant expressions</em></strong>, and they will not point to the a same object.</p>
<h3 id="Escape-Rout"><a href="#Escape-Rout" class="headerlink" title="Escape Rout"></a>Escape Rout</h3><p>The following programs uses two Unicode escapes. What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EscapeRout</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// \u0022 is the Unicode escape for double quote (")</span></span><br><span class="line">        System.out.println(<span class="string">"a\u0022.length() + \u0022b"</span>.length());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You probably guess the result is 16 or 26. However, it’s 2.</p>
<p>A key to understanding this puzzle is: <strong><em>Java provides no special treatment for Unicode escapes within string literals</em></strong>. The compiler translates Unicode escapes into the characters they represent before it pareses the program into tokens, such as string literals. The Unicode escape in the program closes a one-character string literal (<code>&quot;a&quot;</code>), and same for the second one (<code>&quot;b&quot;</code>). In fact, the print line should be:</p>
<pre><code>System.out.println(&quot;a&quot;.length() + &quot;b&quot;.length())</code></pre><p>When programming with Java, remember that Unicode escapes are designed for use when a programmer needs to insert a character that can’t be represented in the source file’s character set. <strong><em>Don’t use unicode escapes to represent ASCII character</em></strong>.</p>
<h3 id="Hello-Whirled"><a href="#Hello-Whirled" class="headerlink" title="Hello Whirled"></a>Hello Whirled</h3><p>The program below seems to be absolutely right.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generated by the IBM IDL-to-Java compiler, version 1.0</span></span><br><span class="line"><span class="comment"> * from F:\TestRoot\apps\a1\units\include\PolicyHome.idl</span></span><br><span class="line"><span class="comment"> * Wednesday, June 17, 1998 6:44:40 o'clock Am GMT+00:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">"Hell"</span>);</span><br><span class="line">        System.out.println(<span class="string">"o world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, it does not compile. If you have read the previous puzzlers, you might get a subtle hint now.</p>
<p>Look at <code>\units</code> in the comments. These characters begin with a backslash (<code>\</code>) followed by the letter <code>u</code>, which denotes the start of a Unicode escape. These characters are not followed by four hexadecimal digits, so the Unicode escape is ill-formed.</p>
<p><em>Don’t put a Unicode escape in the program though it is well-formed</em>, unless you have a strong reason to do it.</p>
<p>Sometimes you might want to use Unicode escape to represent some special characters:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method calls itself recursively, causing a</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;StackOverFlowError&lt;/tt&gt; to be thrown.</span></span><br><span class="line"><span class="comment"> * The algorithm is due to Peter von Ah\u00E9.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>Please use HTML entity escapes instead.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method calls itself recursively, causing a</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;StackOverFlowError&lt;/tt&gt; to be thrown.</span></span><br><span class="line"><span class="comment"> * The algorithm is due to Peter von Ah&amp;eacute.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>An important lesson from this example is to avoid putting Windows filenames into comments in generated Java source files without first processing them to eliminate backslashes.</p>
<h3 id="Classy-Fire"><a href="#Classy-Fire" class="headerlink" title="Classy Fire"></a>Classy Fire</h3><p>What does this program print?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class Classifier &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            classify(&#39;n&#39;) + classify(&#39;+&#39;) + classify(&#39;2&#39;));</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static String classify(char ch) &#123;</span><br><span class="line">        if (&quot;0123456789&quot;.indexOf(ch) &gt;&#x3D; 0)</span><br><span class="line">            return &quot;NUMERAL &quot;;</span><br><span class="line">        if (&quot;qwertyuiopasdfghjklzxcvbnm&quot;.indexOf(ch) &gt;&#x3D; 0)</span><br><span class="line">            return &quot;LETTER &quot;;</span><br><span class="line">    &#x2F;* (Operator not supported yet)</span><br><span class="line">        if (&quot;+-*&#x2F;&amp;|!&#x3D;\&quot;&quot;.indexOf(ch) &gt;&#x3D; 0)</span><br><span class="line">            return &quot;OPERATOR &quot;;</span><br><span class="line">     *&#x2F;</span><br><span class="line">        return &quot;UNKNOWN &quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>you might not find anything wrong in this program. However, this program does not compile. You may also notice that I did not use code highlight. This is becasue you will easily find out the truth if I go with it:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Classifier</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            classify(<span class="string">'n'</span>) + classify(<span class="string">'+'</span>) + classify(<span class="string">'2'</span>));</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">classify</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"0123456789"</span>.indexOf(ch) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"NUMERAL "</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"qwertyuiopasdfghjklzxcvbnm"</span>.indexOf(ch) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"LETTER "</span>;</span><br><span class="line">    <span class="comment">/* (Operator not supported yet)</span></span><br><span class="line"><span class="comment">        if ("+-*/</span>&amp;|!=\<span class="string">""</span>.indexOf(ch) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"OPERATOR "</span>;</span><br><span class="line">     */</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"UNKNOWN "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Once again, as we mentioned earlier, <strong><em>string literals are not treated specially within comments</em></strong>. So, block comments do not nest either.</p>
<p>The best way to comment out a section of code is to use a sequence of single-line comments. You may use some IDEs to automate this process.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /* Operator not supported yet */</span></span><br><span class="line"><span class="comment">// if ("+-*/&amp;|!=".indexOf(ch) &gt;= 0)</span></span><br><span class="line"><span class="comment">//     return "OPERATOR ";</span></span><br></pre></td></tr></table></figure>

<h3 id="What’s-My-Class"><a href="#What’s-My-Class" class="headerlink" title="What’s My Class?"></a>What’s My Class?</h3><p>You might get this issue previously, which is presented by the program below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Me</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            Me.class.getName().replaceAll(".", "/") + ".class");</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems the program tries to replace all <code>.</code> with <code>/</code>. However, it prints <code>///////.class</code>.</p>
<p>The problem is due to that <code>String.replaceAll</code> takes a regular expression as its first parameter (same with <code>String.split</code>).Thus, every character of the class name if replaced by a slash.</p>
<p>An alternative is to use <code>java.util.regex.Pattern.quote</code> after release 5.0. It takes a string as a parameter and adds any necessary escapes, returning a regular expression string that matches the input string exactly.</p>
<h3 id="Dupe-of-URL"><a href="#Dupe-of-URL" class="headerlink" title="Dupe of URL"></a>Dupe of URL</h3><p>What do you think about this program? It doesn’t compile, right?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class BrowserTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;Hello World&quot;);</span><br><span class="line">        http:&#x2F;&#x2F;www.google.com;</span><br><span class="line">        System.out.println(&quot;Is this wrong?&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, it does. You might notice that I did not use the code highlight again.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">        http:<span class="comment">//www.google.com;</span></span><br><span class="line">        System.out.println(<span class="string">"Is this wrong?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In fact, the URL that appears in the middle of the program is a <em>statement label</em> followed by an end-of-line comment. Labels are rarely needed in Java.</p>
<h3 id="No-Pain-No-Gain"><a href="#No-Pain-No-Gain" class="headerlink" title="No Pain, No Gain"></a>No Pain, No Gain</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rhymes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuffer word = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span>(rnd.nextInt(<span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: word = <span class="keyword">new</span> StringBuffer(<span class="string">'P'</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: word = <span class="keyword">new</span> StringBuffer(<span class="string">'G'</span>);</span><br><span class="line">            <span class="keyword">default</span>: word = <span class="keyword">new</span> StringBuffer(<span class="string">'M'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        word.append(<span class="string">'a'</span>);</span><br><span class="line">        word.append(<span class="string">'i'</span>);</span><br><span class="line">        word.append(<span class="string">'n'</span>);</span><br><span class="line">        System.out.println(word);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You might notice that <code>rnd.nextInt(2)</code> will never return <code>2</code>, so <code>case 2</code> will never be reached; in addition, since there is no <code>break</code> at the end of each case, the default case will always be executed, so the result always should be <code>Main</code>.</p>
<p>Well, you successfully spotted several issues in this program, but the result will always be <code>ain</code>.</p>
<p>There is a very subtle error that you didn’t catch: <code>new StringBuffer(&#39;M&#39;)</code> probably does not do what you think it does. Let me ask you a question:</p>
<blockquote>
<p>Q: Are you pretty sure you are familiar with <code>StringBuffer(char)</code> constructor?</p>
</blockquote>
<p>I am pretty sure you aren’t with a good reason: <strong><em>It does not exist</em></strong>.</p>
<p>All <code>StringBuffer</code> constructors are listed below:</p>
<ul>
<li>A parameterless one;</li>
<li>one that takes a <code>String</code> indicating the initial contents of the string buffer;</li>
<li>one that takes an <code>int</code> indicating its initial capacity.</li>
</ul>
<p>So, if we pass a <code>char</code> to it, the third constructor will be used.</p>
<p>To avoid this kind of problem, use familiar idioms and APIs whenever possible. If you must use unfamiliar APIs, read the documentation carefully.</p>
<h2 id="Loopy-Puzzlers"><a href="#Loopy-Puzzlers" class="headerlink" title="Loopy Puzzlers"></a>Loopy Puzzlers</h2><h3 id="A-Big-Delight-in-Every-Byte"><a href="#A-Big-Delight-in-Every-Byte" class="headerlink" title="A Big Delight in Every Byte"></a>A Big Delight in Every Byte</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BigDelight</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span> b = Byte.MIN_VALUE; b &lt; Byte.MAX_VALUE; b++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (b == <span class="number">0x90</span>)</span><br><span class="line">                System.out.println(<span class="string">"Joy!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okay, it seems that <code>b</code> goes through every value from <code>Byte.MIN_VALUE</code> to <code>Byte.MAX_VALUE</code> (exclusive). As a byte has 8 bits, so the min value is <code>0x90</code> while the max one is <code>0x7F</code>. What happens here?</p>
<p>To figure it out, I should know what really happens in <code>b == 0x90</code>. The comparison of a <code>byte</code> to an <code>int</code> is a <em>mixed-type comparison</em>. Java will promote the <code>byte</code> to an <code>int</code> with a widening primitive conversion and compares the two <code>int</code> values. And remember, <code>byte</code> a <strong><em>signed</em></strong> value, and the conversion performs sign extension, promoting negative <code>byte</code> values to numerically equal <code>int</code> values. Thus, if we treat <code>b</code> as an <code>int</code>, its values are from <code>-128</code> to <code>+127</code>, while <code>0x90</code> is <code>+144</code>.</p>
<p>Remember, avoid mixed-type comparisons, because they are inherently confusing, and there are many hidden cases we might not be aware of.</p>
<h3 id="Inclement-Increment"><a href="#Inclement-Increment" class="headerlink" title="Inclement Increment"></a>Inclement Increment</h3><p>What does the program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Increment</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            j = j++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You might expect the output is ‘100’, right? In each loop, <code>j</code> will increment itself and assign it to itself. However, the result is ‘0’.</p>
<p>When palced after a variable, the <code>++</code> operator functions as the <em>postfix increment operator</em>: the value of the expression <code>j++</code> is the original value of <code>j</code> before it was incremented. The assignment is equivalent to this sequence of statements:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tmp = j;</span><br><span class="line">j = j + <span class="number">1</span>;</span><br><span class="line">j = tmp;</span><br></pre></td></tr></table></figure>

<p>Remember: do not assign to the same variable more than once in a single expression.</p>
<h3 id="Shifty-i’s"><a href="#Shifty-i’s" class="headerlink" title="Shifty i’s"></a>Shifty i’s</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shifty</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (-<span class="number">1</span> &lt;&lt; i != <span class="number">0</span>) &#123;</span><br><span class="line">            i ++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okay, <code>-1</code> is an <code>int</code> value with all 32 bits set. The left-shift operator shifts zeros in from the right to fill the low-order bits vacated by the shift, since there are 32 bits in <code>-1</code>, <code>-1</code> will become 0 when <code>i</code> is <code>32</code>. Is it right? If you run this program, you will not see such a value printed but an infinite loop.</p>
<p>Remember, <strong><em>shift operators use only the five low-order bits of their right operand as the shift distance, or six bits if the left operand is a <code>long</code></em></strong>. The applies to all three shift operators: <code>&lt;&lt;</code>, <code>&gt;&gt;</code> and <code>&gt;&gt;&gt;</code>. So the shift distance is always between 0 and 31, or 0 and 63 if the left operand is a <code>long</code>.</p>
<p>A good practice from this puzzler is, shift distances should, if possible, be constants.</p>
<h3 id="Loopers"><a href="#Loopers" class="headerlink" title="Loopers"></a>Loopers</h3><p>It is your turn to write some codes.</p>
<ol>
<li>what declaration for <code>i</code> turns this loop into aninfinite one?</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i == i + <span class="number">1</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>what declaration for <code>i</code> turns this loop into aninfinite one?</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i != i) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When working with float number, remember that Java mandates the use of IEEE 754 floating-point arithmetic, <strong>which lets you represent infinity as a <code>double</code> or <code>float</code></strong>. And, infinity plus 1 is still infinity. Thus, for the first puzzle, you can initialize <code>i</code> by <code>double i = 1.0 / 0.0</code> or, better yet, <code>double i = Double.POSITIVE_INFINITY</code>.</p>
<p>Also, IEEE 754 floating-point arithmetic reserves a special value to represrent a quantity that is <em>not a number</em>, which is known as <code>NaN</code>. <strong>NaN is not equal to any floating-point value, <em>including itself</em>.</strong> Thus, for the second puzzle, you can initialize <code>i</code> by <code>double i = 0.0 / 0.0</code> or <code>double i = Double.NaN</code>.</p>
<p>In addition, NaN holds other similar surpises. <strong>Any floating-point operation evaluates to NaN if one or more of its operands are NaN</strong>.</p>
<h3 id="Ghost-of-Looper"><a href="#Ghost-of-Looper" class="headerlink" title="Ghost of Looper"></a>Ghost of Looper</h3><p>Provide a declaration for <code>i</code> that turns this loop in to an infinite loop:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (i != <span class="number">0</span>)</span><br><span class="line">    i &gt;&gt;&gt;= <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>To solve this puzzler, you should be aware that <strong><em><code>&gt;&gt;&gt;=</code>  is a compound assignment operator and they will silently perform narrowing primitive conversions.</em></strong> Narrow primitive conversions can lose information about the magnitude or precision of numeric values. Thus, if we declare <code>i</code> with <code>short i = -1</code>, the program will do the following:</p>
<ol>
<li>As <code>1</code> is an <code>int</code>, Java will promote <code>i</code> to type of <code>int</code>, which turns <code>0xffff</code> into <code>0xffffffff</code>.</li>
<li>This value if then shifted to the right by one bit without sign extension to yield the <code>int</code> value <code>0x7fffffff</code>.</li>
<li>In order to store the <code>int</code> value into the <code>short</code> variable, Java performs the dreaded narrowing primitive conversion, which simply lops off the high-order 16 bits of the value, which is <code>0xffff</code> again.</li>
</ol>
<p>Remember: do not use compound assignment operators on <code>short</code>, <code>byte</code>, or <code>char</code> variables.\</p>
<h2 id="Exceptional-Puzzlers"><a href="#Exceptional-Puzzlers" class="headerlink" title="Exceptional Puzzlers"></a>Exceptional Puzzlers</h2><h3 id="Indecision"><a href="#Indecision" class="headerlink" title="Indecision"></a>Indecision</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Indecisive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(decision());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">decision</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We know that once it reaches a <code>return</code> statement in a function, the rest of the function will not execute anymore; on the other hand, <code>finally</code> block will always be executed. What is the fact?</p>
<p>The answer is <code>false</code>. <code>return</code> statement is called <em>abrupt completion</em>. When both the <code>try</code> and the <code>finally</code> block complete abruptly, the abrupt completion in the <code>try</code> block is discarded, and the whole <code>try-finally</code> statement completes abruptly for the same reason as the <code>finally</code> block. In this program, the abrupt completion caused by the <code>return</code> statement is the <code>try</code> block is discarded, and the <code>try-finally</code> statement completes abruptly because of the <code>return</code> statement in the <code>finally</code> block.</p>
<p>Remember, <strong><em>never exit a <code>finally</code> block with a <code>return</code>, <code>break</code>, <code>continue</code>, or <code>throw</code>, and never allow a checked exception to propagate out of a <code>finally block</code></em></strong>.</p>
<h3 id="Exceptionally-Arcane"><a href="#Exceptionally-Arcane" class="headerlink" title="Exceptionally Arcane"></a>Exceptionally Arcane</h3><p>Look at the three programs below and expect their behaviors.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Acrane1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Arcane2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// Nothing here</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Exception"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Type1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Type2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Type3</span> <span class="keyword">extends</span> <span class="title">Type1</span>, <span class="title">Type2</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Arcane3</span> <span class="keyword">implements</span> <span class="title">Type3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Type3 t3 = <span class="keyword">new</span> Arcane3();</span><br><span class="line">        t3.f();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You will get compile error in the first program, as the language specification says that <strong>it is a compile-time error for a <code>catch</code> clause to catch a checked exception type E if the corresponding <code>try</code> clause can’t throw an exception of some subtype of E</strong>.</p>
<p>By the same token, in the second program, it should not compile either, but it does. <strong><code>Catch</code> clauses that catch <code>Exception</code> or <code>Throwable</code> are legal regardless of the contents of the corresponding <code>try</code> clause</strong>.</p>
<p>Should the third program compile? Method <code>f</code> is declared to throw checked exceptions in <code>Type1</code> and <code>Type2</code>. Interface <code>Type3</code> inherits from <code>Type1</code> and <code>Type2</code>, so it would seem that invoking <code>f</code> on an object whose static type is <code>Type3</code> could potentially throw either of these exceptions. However, it is not true that <code>Type3.f</code> can throw either the exception declared on <code>Type1.f</code> or the one declared on <code>Type2.f</code>. <strong>Each interface limits the set of checked exceptions that method <code>f</code> can throw</strong>. The set of checked exceptions that a method can throw is the intersection of the sets of checked exceptions that it is declared to throw in all applicable types. Thus, the <code>f</code> method on an object whose static type is <code>Type3</code> can’t throw any checked exceptions at all.</p>
<h3 id="Hello-Goodbye"><a href="#Hello-Goodbye" class="headerlink" title="Hello, Goodbye"></a>Hello, Goodbye</h3><p>What does this program print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloGoodbye</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Goodbye world"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Recall the puzzler “Indecision”, you might remember that if there are abrupt completions in both <code>try</code> and <code>finally</code> block, we will follow the on in <code>finally</code> block. However, in this case, you will find that this program will only print <code>Hello World</code>.</p>
<p>It is true that a <code>finally</code> is executed when a <code>try</code> block completes execution whether normally or abruptly. In this program, however, the <code>try</code> block does not complete execution at all. <strong>The <code>System.exit</code> method halts the execution of the current thread and all others dead in their tracks.</strong> The presence of a <code>finally</code> clause does not give a method special permission to continue executing.</p>
<p>When <code>System.exit</code> is called, the virtual machine performs two cleanup tasks before shutting down. First, it executes all <em>shutdown hooks</em> that have been registered with <code>Runtime.addShutdownHook</code>. This is useful to release resources external to the VM. <strong>Use shutdown hook for behavior that must occur before the VM exits</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloGoodbye</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello world"</span>);</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(</span><br><span class="line">            <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Goodbye world"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The second cleanup task performed by the VM when <code>System.exit</code> is called concerns finalizers. If either <code>System.runFinalizerOnExit</code> or its evil twin <code>Runtime.runFimalizerOnExit</code> has been called, the VM runs the finalizers on all objects that have not yet been finalized. These methods were deprecated a log time ago and with good reason. <strong>Never call <code>System.runFinalizersOnExit</code> or <code>Runtime.runFinalizersOnExit</code> for any reason: They are among the most dangerous methods in the Java libraries</strong>.</p>
<p>In summary, <code>System.exit</code> stops all program threads immediately: it does not cause <code>finally</code> blocks to execute, but it does run shutdown hooks before halting the VM.</p>
<h3 id="The-Reluctant-Constructor"><a href="#The-Reluctant-Constructor" class="headerlink" title="The Reluctant Constructor"></a>The Reluctant Constructor</h3><p>Have you ever seen a <code>throws</code> clause in a constructor declaration? What does the program below print?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reluctant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Reluctant internalInstance = <span class="keyword">new</span> Reluctant();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Reluctant</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">throws</span> new <span class="title">Exception</span><span class="params">(<span class="string">"I'm not coming out!"</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Reluctant b = <span class="keyword">new</span> Reluctant();</span><br><span class="line">            System.out.println(<span class="string">"Surprise"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"I told you so!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It seems that the constructor will throw an exception when it is called, which is caught by the <code>try</code> clause in the main function. However, if you run this function, it throws a <code>StackOverflowError</code>. Why?</p>
<p>The error indicates an infinite recursion. When you invoke a constructor, the <strong>instance variable initializers run before the body of the constructor</strong>. In this case, the initializer for the variable <code>internalInstance</code> invokes the constructor recursively. The constructor, in turn, initializes its own <code>internalInstance</code> field by invoking the <code>Reluctant</code> constructor again and so on, ad infinitum, which leads to an infinite recursion.</p>
<p>In fact, do not assume that you will not write similar codes. It is very common for an object to contain instances of its own type.</p>
<p>Remember: <strong><em>a constructor must declare any checked exceptions thrown by its instance initializers.</em></strong></p>
<h3 id="Field-and-Stream"><a href="#Field-and-Stream" class="headerlink" title="Field and Stream"></a>Field and Stream</h3><p>This method copies one file to anotehr and was designed to close every stream it creates, even if encounters I/O errors. However, it doesn’t alwasy do this. Why?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(String scc, String dest)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> FileInputStream(scc);</span><br><span class="line">        out = <span class="keyword">new</span> FIleOutputStream(dest);</span><br><span class="line">        <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">while</span> ((n = in.read(buf)) &gt;= <span class="number">0</span>)</span><br><span class="line">            out.write(buf, <span class="number">0</span>, n);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) in.close();</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="keyword">null</span>) out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This bug might be really subtle as it is not always reproducable. The problem is in the <code>finally</code> block itself. The <code>close</code> method can throw an <code>IOException</code> too. Once that happens, the calls to <code>close</code> can cause the <code>finally</code> block to complete abruptly. Unfortunately, the compiler will not help you find the problem, because <code>close</code> throws the same exception type as <code>read</code> and <code>write</code>, and the enclosing method <code>copy</code> will propagate it for sure.</p>
<p>An important lesson is to make sure you have handled any checked exception that can be thrown within a finally block rather than letting it propagate. Furthermore, in a lot of cases you might want to keep you program running even when exceptions occur, so you might use <code>try finally</code> to handle and make program continue. But always remember that the <code>finally</code> is not that safe: it can throw exceptions as well (I also experienced this when I was working at Apple).</p>
<br>

<p>———— END OF THIS POST ————</p>
<p>If you want to read more puzzlers, please go to <a href="/2020/04/13/java2/">this</a> page!</p>
</span> -->
        </article>
    
    

</div>


        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Yihang (Ian) Ding | Powered by <i><a href="https://hexo.io" target="_blank">Hexo</a></i> & <i><a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></i></span>
    </div>
</footer>

    </div>
</body>
</html>
